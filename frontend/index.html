<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WapMarket · Marketplace</title>
<style>
:root{
  --amz-dark:#131921;
  --amz-yellow:#FF9900;
  --bg:#f6f7f9;
  --card:#fff;
  --muted:#6b7280;
  --btn-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#111;display:flex;flex-direction:column;min-height:100vh}
.header{background:var(--amz-dark);color:#fff;padding:12px 18px;position:sticky;top:0;z-index:100}
.header-content{display:flex;align-items:center;gap:12px;flex-wrap:wrap;max-width:1100px;margin:0 auto}
.brand{font-weight:800;font-size:18px}
.container{max-width:1100px;margin:20px auto;padding:0 16px;flex-grow:1}
.grid{display:grid;grid-template-columns:280px 1fr;gap:16px}
.card{background:var(--card);border:1px solid #e6e6e6;border-radius:8px;padding:14px;box-shadow:0 6px 18px rgba(17,24,39,0.04)}
.small{font-size:13px;color:var(--muted)}
.btn{background:var(--amz-yellow);border:none;padding:8px 10px;border-radius:6px;cursor:pointer;font-weight:700;box-shadow:var(--btn-shadow)}
.btn.ghost{background:transparent;border:1px solid #ddd;color:#111;box-shadow:none}

/* Main */
.topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
.form-row{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
.input, textarea, select{padding:8px;border-radius:6px;border:1px solid #ddd;width:100%}
.product-card{border:1px solid #e6e6e6;border-radius:8px;padding:10px;background:#fff;display:flex;flex-direction:column;gap:8px}
.product-card img{width:100%;height:140px;object-fit:cover;border-radius:6px}
/* ===== FOOTER ===== */
    .footer { background: var(--amz-dark); color: #fff; margin-top: auto; text-align: center; font-size: 13px; padding: 24px 18px; display: flex; flex-direction: column; align-items: center; }
    .footer-links { display: flex; justify-content: center; gap: 20px; margin-bottom: 12px; flex-wrap: wrap; }
    .footer-links a { color: #E5E7EB; text-decoration: none; font-size: 14px; transition: color 0.2s; }
    .footer-links a:hover { color: var(--amz-yellow); }

/* Custom styles for the marketplace */
.product-item {
  border: 1px solid #e6e6e6;
  border-radius: 8px;
  padding: 10px;
  background: #fff;
  display: flex;
  flex-direction: column;
  gap: 8px;
  aspect-ratio: 1/1; /* Make cards square */
}
.product-item img {
  width: 100%;
  height: auto;
  object-fit: cover;
  flex: 1; /* Allow image to fill available space */
  border-radius: 6px;
}
.product-item .meta {
  display: flex;
  flex-direction: column;
  gap: 6px;
  align-items: stretch;
}
.product-item .meta h4 {
  margin: 0;
  font-size: 1rem;
  font-weight: 600;
  line-height: 1.2;
}
.product-item .price {
  font-size: 1.06rem;
  font-weight: 800;
}
.product-item .badge {
  font-size: 0.88rem;
  padding: 4px 6px;
  background: #f0f0f0;
  border-radius: 4px;
}

/* New responsive grid layout */
.products-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 12px;
}
@media (min-width: 600px) {
  .products-grid { grid-template-columns: repeat(3, 1fr); }
}
@media (min-width: 900px) {
  .products-grid { grid-template-columns: repeat(4, 1fr); }
}
@media (min-width: 1200px) {
  .products-grid { grid-template-columns: repeat(5, 1fr); }
}

.modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  z-index: 99999;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}
.modal.right{
  align-items:stretch;
  justify-content:flex-end;
  padding:0
}
.modal.right .dialog{
  height:100%;
  border-radius:0;
  border-left:1px solid #e6e6e6;
  padding:1rem;
  animation:slideIn 0.25s ease both;
  width: min(480px, 100%);
}
.dialog{
  background:var(--card);
  width: min(480px, 100%);
  max-width: 90%;
  border-radius:8px;
  box-shadow:0 18px 50px rgba(17,24,39,0.12);
  padding:1rem;
  animation:fadeIn 0.25s ease both;
}
@keyframes fadeIn {
  from { transform: scale(0.95); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
@keyframes slideIn {
  from { transform: translateX(30px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}
.product-card{
  border:1px solid #e6e6e6;border-radius:8px;padding:10px;background:#fff;display:flex;flex-direction:column;gap:8px
}
.product-card img{
  width:100%;height:140px;object-fit:cover;border-radius:6px
}
.product-card .meta>div:last-child{
  display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:6px
}
.product-card .btn,.product-card .btn.ghost{
  flex:1 1 auto;min-width:0;padding:8px 10px
}
.search{
  display:flex;flex:1;max-width:720px;position:relative;gap:0
}
.search input{
  flex:1;padding:8px;border-radius:6px 0 0 6px;border:1px solid #ddd;outline:none;height:auto
}
#btnBuscar{
  background:var(--amz-yellow);border:none;padding:8px 10px;border-radius:0 6px 6px 0;cursor:pointer;font-weight:700
}
.search .sugg{
  position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #e6e6e6;border-radius:8px;box-shadow:0 6px 18px rgba(17,24,39,0.04);z-index:10;margin-top:4px
}
.sugg li{
  list-style:none;padding:8px;display:flex;gap:8px;align-items:center;cursor:pointer
}
.sugg li:hover{
  background:#f6f7f9
}

/* Sidebar changes */
.sidebar {
  position: sticky;
  top: 80px; /* Adjust top to be below header */
  height: calc(100vh - 100px);
  overflow-y: auto;
  border-right: 1px solid #e6e6e6;
  padding-right: 16px;
  background: var(--bg);
  align-self: flex-start; /* Aligns to the left */
}
.sidebar .card {
  box-shadow: none;
  border: none;
  padding: 0;
}
.biz-item {
  padding: 12px 14px;
  cursor: pointer;
  border-bottom: 1px solid #f0f0f0;
}
.biz-item:hover {
  background: #eee;
}
.biz-item:last-child {
  border-bottom: none;
}
/* Main section changes to remove card border */
.main .card{
  padding:0;
  box-shadow:none;
  border:none;
  background:transparent;
}

/* New Cart Icon */
.cart-btn-icon {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 8px 10px;
  border-radius: 6px;
  background: var(--amz-yellow);
  box-shadow: var(--btn-shadow);
  cursor: pointer;
  border: none;
}
.cart-btn-icon svg {
  width: 24px;
  height: 24px;
  fill: #fff;
  stroke: #fff;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
}
.cart-btn-icon[data-has-items="true"]::after {
  content: attr(data-item-count);
  position: absolute;
  top: -8px;
  right: -8px;
  background: red;
  color: white;
  border-radius: 50%;
  padding: 2px 6px;
  font-size: 11px;
  font-weight: bold;
}

/* Responsive grid for the main layout */
@media (max-width: 768px) {
  .grid {
    display: flex;
    flex-direction: column;
    gap: 0;
  }
  .sidebar {
    position: static;
    height: auto;
    overflow-y: visible;
    border-right: none;
    padding-right: 0;
  }
}

/* Mobile-first header layout */
@media (max-width: 600px) {
  .header-content {
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding-bottom: 8px;
  }
  .header-content .search {
    width: 100%;
  }
}

/* New pagination styles */
.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
  margin-top: 16px;
}
.pagination button {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  background-color: #fff;
  cursor: pointer;
  font-weight: 600;
}
.pagination button.active {
  background-color: var(--amz-yellow);
  color: #fff;
  border-color: var(--amz-yellow);
}

/* AI Assistant styles - NEW */
.chat-modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  align-items: flex-end;
  justify-content: flex-end;
  z-index: 1000;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}
.chat-dialog {
  background: var(--card);
  border-radius: 8px 8px 0 0;
  width: min(400px, 100%);
  height: 500px;
  display: flex;
  flex-direction: column;
  padding: 16px;
  box-shadow: 0 -8px 20px rgba(17, 24, 39, 0.1);
  animation: slideUp 0.3s ease both;
}
.chat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #ddd;
  padding-bottom: 10px;
  margin-bottom: 10px;
}
.chat-messages {
  flex-grow: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding-right: 8px;
}
.message-bubble {
  padding: 10px;
  border-radius: 18px;
  max-width: 85%;
}
.message-bubble.user {
  background: var(--amz-yellow);
  color: #fff;
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}
.message-bubble.ai {
  background: #f0f0f0;
  color: #111;
  align-self: flex-start;
  border-bottom-left-radius: 4px;
}
.chat-input-area {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}
.chat-input-area input {
  flex-grow: 1;
}
.mic-btn {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 0;
  display: flex;
  align-items: center;
}
.mic-btn svg {
  width: 24px;
  height: 24px;
  fill: #111;
  transition: fill 0.2s;
}
.mic-btn.active svg {
  fill: red;
  animation: pulse 1s infinite;
}
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}
@keyframes slideUp {
  from { transform: translateY(100%); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
/* End of AI Assistant styles */
</style>
</head>
<body>
<header class="header">
  <div class="header-content" style="gap:24px">
    <div class="brand">Wap<span style="color:var(--amz-yellow)">Market</span></div>
    <form id="searchForm" class="search" onsubmit="return false;">
      <input id="q" placeholder="Buscar productos..." autocomplete="off" />
      <button class="btn" id="btnBuscar" aria-label="Buscar">Buscar</button>
      <ul id="suggBox" class="sugg" role="listbox" style="display:none"></ul>
    </form>
    <div style="display:flex; gap: 12px; align-items: center;">
      <button class="cart-btn-icon" id="btnOpenChat" aria-label="Abrir asistente de IA" title="Asistente de IA">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-zap">
            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
        </svg>
      </button>
      <button class="cart-btn-icon" id="btnOpenCart" aria-label="Abrir carrito" title="Carrito" data-has-items="false" data-item-count="0">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4H6zM3.86 6l2.14-4h12l2.14 4H3.86zM5 10h14M5 14h14M5 18h14"></path>
        </svg>
      </button>
    </div>
  </div>
</header>
<div class="container">
  <div class="grid">
    <aside class="sidebar">
      <div class="card">
        <h3>Negocios disponibles</h3>
        <p class="small">Selecciona un negocio para ver sus productos.</p>
        <div id="bizList"></div>
      </div>
    </aside>
    <main class="main">
      <div class="topbar">
        <div style="display:flex;flex-direction:column">
          <strong id="bizTitle">Selecciona un negocio</strong>
          <span class="small">Lista de productos disponibles.</span>
        </div>
      </div>
      <div class="card">
        <div id="results" class="products-grid"></div>
        <div id="pagination" class="pagination" style="display:none"></div>
      </div>
    </main>
  </div>
</div>
<div class="footer">
  <div class="footer-links">
    <a href="https://wa.me/240555218661?text=Hola,%20necesito%20ayuda." target="_blank">Soporte</a>
    <a href="#top">Volver arriba</a>
  </div>
  <p>© 2025 WapMarket</p>
</div>

<div id="customModal" class="modal">
  <div class="dialog">
    <p id="modalMessage"></p>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:1rem">
      <button class="btn" id="modalConfirmBtn" style="display:none">OK</button>
      <button class="btn ghost" id="modalCancelBtn">Cerrar</button>
    </div>
  </div>
</div>

<div class="modal right" id="cartModal">
  <div class="dialog">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h3 style="margin:6px 0">Tu carrito</h3>
      <button class="btn ghost" type="button" onclick="closeCart()">✕</button>
    </div>
    <div id="cartInfo" class="small" style="margin-bottom:8px"></div>
    <div id="cartItems"></div>
    <div style="margin:12px 0">
      <label style="display:flex;gap:8px;align-items:center">
        <input type="checkbox" id="deliveryChk"> <span>Envío a domicilio (+2000 XAF)</span>
      </label>
    </div>
    <div id="addressBox" style="display:none">
      <label style="display:block;margin-bottom:10px">Dirección exacta <input id="address" placeholder="Ej: Malabo, Semu, casa azul" class="input"> </label>
    </div>
    <div id="totals" style="margin:12px 0;font-weight:900"></div>
    <form id="checkoutForm" style="display:grid;gap:10px">
      <label>Tu nombre (opcional) <input id="cname" class="input"> </label>
      <label>Teléfono (WhatsApp) <input id="cphone" required class="input"></label>
      <label>Nota <textarea id="cnote" placeholder="Ej: Entrega 18:00" class="input"></textarea></label>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
        <button class="btn" type="submit">Confirmar pedido</button>
        <button class="btn ghost" type="button" onclick="closeCart()">Cerrar</button>
      </div>
    </form>
  </div>
</div>

<div id="chatModal" class="chat-modal">
  <div class="chat-dialog">
    <div class="chat-header">
      <strong style="margin:0">Asistente de WapMarket</strong>
      <button class="btn ghost" type="button" onclick="closeChat()">✕</button>
    </div>
    <div id="chatMessages" class="chat-messages">
      <div class="message-bubble ai">Hola, soy tu asistente de compras. ¿Cómo puedo ayudarte hoy?</div>
    </div>
    <div class="chat-input-area">
      <input type="text" id="chatInput" placeholder="Escribe tu mensaje..." class="input">
      <button class="mic-btn" id="micBtn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
          <line x1="12" y1="18" x2="12" y2="23"></line>
          <line x1="8" y1="23" x2="16" y2="23"></line>
        </svg>
      </button>
      <button class="btn" id="sendChatBtn">Enviar</button>
    </div>
  </div>
</div>

<script src="/api.js"></script>
<script>
// Custom modal functions to replace alert() and confirm()
function showModal(message, isConfirm = false, onConfirm = null) {
  const modal = document.getElementById('customModal');
  const msgEl = document.getElementById('modalMessage');
  const confirmBtn = document.getElementById('modalConfirmBtn');
  const cancelBtn = document.getElementById('modalCancelBtn');

  msgEl.textContent = message;
  
  if (isConfirm) {
    confirmBtn.style.display = 'inline-block';
    confirmBtn.onclick = () => {
      modal.style.display = 'none';
      if (onConfirm) onConfirm();
    };
    cancelBtn.onclick = () => {
      modal.style.display = 'none';
    };
  } else {
    confirmBtn.style.display = 'none';
    cancelBtn.onclick = () => {
      modal.style.display = 'none';
    };
  }

  modal.style.display = 'flex';
}

// Function to close the cart modal
function closeCart() {
  const cartModal = document.getElementById('cartModal');
  cartModal.style.display = 'none';
}

// Function to close the chat modal
function closeChat() {
  const chatModal = document.getElementById('chatModal');
  chatModal.style.display = 'none';
}

// Open chat modal
document.getElementById('btnOpenChat').addEventListener('click', () => {
  document.getElementById('chatModal').style.display = 'flex';
});

// Chatbot functionality
const chatInput = document.getElementById('chatInput');
const sendChatBtn = document.getElementById('sendChatBtn');
const chatMessages = document.getElementById('chatMessages');

async function sendToAI(text) {
  if (!text) return;
  
  // Add user message to chat
  const userBubble = document.createElement('div');
  userBubble.className = 'message-bubble user';
  userBubble.textContent = text;
  chatMessages.appendChild(userBubble);
  chatMessages.scrollTop = chatMessages.scrollHeight;

  // Show a loading indicator (a simple one)
  const loadingBubble = document.createElement('div');
  loadingBubble.className = 'message-bubble ai';
  loadingBubble.textContent = '...';
  chatMessages.appendChild(loadingBubble);
  chatMessages.scrollTop = chatMessages.scrollHeight;

  try {
    const response = await callGeminiApi(text);
    
    // Replace the loading bubble with the AI response
    loadingBubble.textContent = response;
  } catch (error) {
    console.error('Error with AI assistant:', error);
    loadingBubble.textContent = 'Lo siento, hubo un problema. Por favor, intenta de nuevo.';
  }
  
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

sendChatBtn.addEventListener('click', () => {
  const message = chatInput.value.trim();
  if (message) {
    sendToAI(message);
    chatInput.value = '';
  }
});

chatInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    sendChatBtn.click();
  }
});

// Voice input functionality
const micBtn = document.getElementById('micBtn');
const isSpeechRecognitionAvailable = 'webkitSpeechRecognition' in window;

if (isSpeechRecognitionAvailable) {
    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'es-ES'; // Set language
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
        micBtn.classList.add('active');
        chatInput.placeholder = 'Hablando...';
        chatInput.value = '';
    };

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        chatInput.value = transcript;
        sendToAI(transcript); // Send transcription to the AI
    };

    recognition.onerror = (event) => {
        console.error('Voice recognition error:', event.error);
        showModal('Error al iniciar el reconocimiento de voz. Asegúrate de que tu navegador lo soporte y de haber dado permiso.');
        micBtn.classList.remove('active');
        chatInput.placeholder = 'Escribe tu mensaje...';
    };

    recognition.onend = () => {
        micBtn.classList.remove('active');
        chatInput.placeholder = 'Escribe tu mensaje...';
    };

    micBtn.addEventListener('click', () => {
        if (micBtn.classList.contains('active')) {
            recognition.stop();
        } else {
            recognition.start();
        }
    });
} else {
    micBtn.style.display = 'none'; // Hide the button if the API is not available
    console.warn('Web Speech API no está disponible en este navegador.');
}

</script>
</body>
</html>
