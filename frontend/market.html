<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WapMarket — Marketplace GE (modificado)</title>
  <link rel="stylesheet" href="/styles.css">

  <!-- Fuente Futura PT -->
  <style>
    @import url('https://fonts.cdnfonts.com/css/futura-pt');

    /* ====== TOKENS ====== */
    :root{
      --gap:16px;
      --aside-w:300px;
      --radius:12px;
      --shadow: 0 8px 24px rgba(0,0,0,.06);
      --shadow-lg: 0 18px 50px rgba(0,0,0,.12);
      --bg: #f5f7fb;
      --card: #ffffff;
      --text: #111;
      --muted: #5c6370;
      --brand1:#5b8cff;
      --brand2:#8a5bff;
      --accent:#ff7a18;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      padding:0;
      background:var(--bg);
      font-family:-apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Futura PT', system-ui;
      color:var(--text);
      display:flex;
      flex-direction:column;
      min-height:100vh;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .wrapper{max-width:1200px;margin:0 auto;padding:16px}

    /* ====== HEADER ====== */
    .header {
      position: sticky; top: 0; z-index: 9999;
      backdrop-filter: saturate(180%) blur(6px);
      background: linear-gradient(90deg, #131921 0%, #1a2440 100%);
      border-bottom: 1px solid rgba(255,255,255,.06);
      width:100%;
      left:0;
    }
    .header > .wrapper {
      max-width: 100% !important;
      width: 100vw !important;
      margin: 0 !important;
      padding-left: 12px !important;
      padding-right: 12px !important;
      box-sizing: border-box !important;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .row {display:flex; align-items:center; gap:12px; flex-wrap:nowrap; width:100%}
    .logo {
      font-family: Arial, sans-serif;
      font-weight: 900;
      letter-spacing:.3px;
      font-size: 1.25rem;
      color: #fff;
      display:flex; align-items:center; gap:8px;
      flex: 0 0 auto;
    }

    /* buscador */
    .search {display:flex; flex:1; min-width:0; max-width:900px; position:relative}
    .search input {
      flex:1; min-width:0; padding:10px 44px 10px 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color:#fff;
      border-radius: 999px;
      outline:none;
    }
    .search input::placeholder{color:#d5d9e3}
    #btnBuscar {
      position:absolute; right:6px; top:6px; bottom:6px;
      background: linear-gradient(90deg, var(--brand1), var(--brand2));
      color: #fff; border: none; padding: 0 16px;
      font-weight: 800; cursor: pointer; display: inline-flex; align-items: center; justify-content:center;
      border-radius: 999px; box-shadow: var(--shadow);
      transition: transform .15s ease;
    }

    /* Filters button (mobile) */
    #btnFilters {
      display:inline-flex; align-items:center; gap:8px;
      background:transparent;color:#fff;border:1px solid rgba(255,255,255,.12);
      padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:700;
      flex:0 0 auto;
    }

    /* Cart button */
    #btnOpenCart {
      position: relative; display: inline-flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,.06); color: #fff;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 12px; height: 42px; padding: 0 12px; margin-left: 4px;
      transition: transform .15s ease, background .2s ease;
      flex:0 0 auto;
    }
    #btnOpenCart:hover{ transform: translateY(-1px); background: rgba(255,255,255,.12); }
    #btnOpenCart img { width: 22px; height: 22px; object-fit: contain; filter: brightness(1.2) }

    /* ====== LAYOUT ====== */
    .layout{display:grid;grid-template-columns: var(--aside-w) 1fr; gap:var(--gap); flex:1}
    aside{margin-left:-4px}
    .card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .body{padding:14px 14px}

    /* ====== PRODUCT GRID ====== */
    /* Default: desktop - 4 columns */
    #results.grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:var(--gap);
      width:100%;
    }

    /* 3 columns medium */
    @media (max-width:1200px){
      #results.grid{ grid-template-columns: repeat(3, minmax(0,1fr)); }
      :root{ --aside-w:260px; }
    }
    /* 2 columns tablet & phones */
    @media (max-width:900px){
      #results.grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .layout{ grid-template-columns: 1fr; }
      aside{ order:2 }
      section{ order:1 }
    }
    /* keep 2 columns on very small screens */
    @media (max-width:520px){
      #results.grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .row{flex-direction:row;align-items:center}
      .search{ width:100% }
      .logo{justify-content:flex-start}
    }

    .product-item{
      background:var(--card); border-radius:10px; overflow:hidden;
      display:flex; flex-direction:column; justify-content:space-between;
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .product-item .thumb{width:100%;aspect-ratio:4/3;object-fit:cover;display:block}
    .product-item .meta{padding:10px 12px}
    .price{font-weight:900;margin:6px 0;font-size:1.05rem}

    /* ====== FILTER MODAL (Amazon-like) ====== */
    .filter-modal{ position:fixed; inset:0; display:none; z-index:99998; background: rgba(0,0,0,.35); align-items:flex-start; justify-content:flex-end; }
    .filter-panel{
      width:min(460px,100%); height:100%; background:#fff; box-shadow:var(--shadow-lg); padding:18px; overflow:auto;
      transform: translateX(24px); animation: slideFromRight .22s ease both;
    }
    @keyframes slideFromRight{ from{ transform:translateX(30px); opacity:0 } to{ transform:translateX(0); opacity:1 } }
    .filter-section{ margin-bottom:14px; border-bottom:1px solid #eee; padding-bottom:12px; }
    .filter-section h4{ margin:0 0 8px; font-size:1rem; }
    .filter-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }

    /* make filter controls compact */
    .filter-panel label{ display:block; margin-bottom:8px; font-weight:600; color:#222 }
    .filter-panel input[type="checkbox"]{ margin-right:8px; }

    /* ====== CAROUSEL DOTS AS DASHES ====== */
    .wa-dots, #featDots{ display:flex; gap:8px; align-items:center; justify-content:center; padding:6px 0; }
    .wa-dot, #featDots button {
      width:22px; height:6px; border-radius:4px; background:#d0d0d0; border:none; cursor:pointer;
      box-shadow:none; padding:0;
      transition:background .25s, transform .25s;
    }
    .wa-dot.active, #featDots button.active{ background: linear-gradient(90deg,var(--brand1),var(--brand2)); transform:scale(1.05); }

    /* ensure header never overflows / gets cut */
    .header, body { overflow-x:hidden; }

    /* suggestions */
    .sugg{ position:absolute; top:48px; left:0; right:0; background:var(--card); border:1px solid rgba(0,0,0,.1); border-radius:12px; box-shadow:var(--shadow); overflow:hidden; display:none; z-index:25; max-height:280px; overflow:auto; }
    .sugg li{ list-style:none; padding:10px 12px; display:flex; gap:10px; align-items:center; cursor:pointer }
    .sugg li:hover{ background:rgba(91,140,255,.06) }

    /* modal cart */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:stretch;justify-content:flex-end;padding:0;z-index:40}
    .dialog{ background:var(--card); width:min(480px, 100%); height:100%; overflow:auto; box-shadow: var(--shadow-lg); border-left:1px solid rgba(0,0,0,.08); padding:16px 16px 24px; }

    /* small helpers */
    .btn{ background: linear-gradient(90deg, var(--accent), #af002d 85%); color:#fff; border:none; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:800; }
    .btn.ghost{ background: transparent; color:var(--text); border:1px solid rgba(0,0,0,.12) }

    footer.footer{ margin-top:auto; padding:12px; text-align:center; color:var(--muted); background:transparent }

    /* ensure buttons don't overflow on tiny widths */
    .product-item .meta > div:last-child { display:flex; gap:8px; justify-content:space-between; align-items:center; margin-top:6px; flex-wrap:nowrap; }
    .product-item button.btn, .product-item button.btn.ghost { flex:1 1 auto; min-width:0 }
  </style>
</head>
<body>

<header class="header">
  <div class="row wrapper" style="padding-block:10px">
    <div class="logo">WapMarket</div>

    <form id="searchForm" class="search" onsubmit="return false;">
      <input id="q" placeholder="Buscar productos o servicios..." autocomplete="off" />
      <button class="btn" id="btnBuscar" aria-label="Buscar">Buscar</button>
      <ul id="suggBox" class="sugg" role="listbox"></ul>
    </form>

    <button id="btnFilters" title="Filtros" aria-label="Filtros">Filtros</button>
    <a href="#" class="btn ghost" id="btnOpenCart" aria-label="Abrir carrito" title="Carrito" data-has-items="false">
      <img src="/aset/icons8-buy-64.png" alt="Carrito" style="width:20px;height:20px">
    </a>
  </div>
</header>

<main class="wrapper">
  <div class="layout">
    <aside>
      <div class="card">
        <div class="body">
          <h3 style="margin:4px 0 10px">Negocios disponibles</h3>
          <div id="bizList"></div>
        </div>
      </div>

      <!-- Filtros: chips -->
      <div class="card" style="margin-top:16px">
        <div class="body">
          <h3 style="margin:4px 0 10px">Filtros</h3>
          <div class="chips" id="chips"></div>
          <select id="category" style="display:none">
            <option value="">Todas</option>
            <option>Servicios</option><option>Comida</option><option>Tiendas</option>
            <option>Salud</option><option>Transporte</option><option>Tecnología</option>
          </select>
        </div>
      </div>
    </aside>

    <section>
      <div class="card" style="background:transparent;box-shadow:none;border:none">
        <div class="body" style="padding:0">
          <h3 id="bizTitle" style="margin:6px 0 14px">Selecciona un negocio</h3>

          <!-- Featured carousel -->
          <div id="featuredWrap" style="display:none;margin-bottom:14px">
            <div class="wa-carousel-wrap">
              <div class="wa-carousel" id="featCarousel"></div>
            </div>
            <div class="wa-nav">
              <button class="wa-btn" type="button" data-dir="-1" data-target="feat">‹</button>
              <div class="wa-dots" id="featDots"></div>
              <button class="wa-btn" type="button" data-dir="1" data-target="feat">›</button>
            </div>
          </div>

          <div id="results" class="grid"></div>
          <div style="display:flex;justify-content:center;margin-top:12px">
            <button id="nextBtn" class="btn" style="display:none">Ver más</button>
          </div>
        </div>
      </div>

      <!-- WhatsApp ads -->
      <section class="wa-ads" aria-label="Publicidad" style="margin-top:14px">
        <h3>Publicidad</h3>
        <div class="wa-carousel-wrap">
          <div class="wa-carousel" id="waCarousel">
            <div class="wa-slide">
              <a href="https://wa.me/240555218661" target="_blank" rel="noopener">
                <img src="/aset/Captura de pantalla 2025-07-07 a la(s) 19.02.16.png" alt="Wap Tech & Services">
                <p>Wap Tech &amp; Services</p>
              </a>
            </div>
            <div class="wa-slide">
              <a href="https://wa.me/240555218661" target="_blank" rel="noopener">
                <img src="/aset/app-check-hero_2x.png" alt="CiberSeguridad Prisma">
                <p>CiberSeguridad Prisma</p>
              </a>
            </div>
          </div>
        </div>
        <div class="wa-nav">
          <button class="wa-btn" type="button" data-dir="-1" aria-label="Anterior">‹</button>
          <div class="wa-dots" id="waDots"></div>
          <button class="wa-btn" type="button" data-dir="1" aria-label="Siguiente">›</button>
        </div>
      </section>
    </section>
  </div>
</main>

<!-- Cart modal -->
<div class="modal" id="cartModal">
  <div class="dialog">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h3 style="margin:6px 0">Tu carrito</h3>
      <button class="btn ghost" type="button" onclick="closeCart()">✕</button>
    </div>
    <div id="cartInfo" class="small" style="margin-bottom:8px"></div>
    <div id="cartItems"></div>
    <div style="margin:12px 0">
      <label style="display:flex;gap:8px;align-items:center">
        <input type="checkbox" id="deliveryChk"> <span>Envío a domicilio (+2000 XAF)</span>
      </label>
    </div>
    <div id="addressBox" style="display:none">
      <label style="display:block;margin-bottom:10px">Dirección exacta
        <input id="address" placeholder="Ej: Malabo, Semu, casa azul" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,.12)">
      </label>
    </div>
    <div id="totals" style="margin:12px 0;font-weight:900"></div>
    <form id="checkoutForm" style="display:grid;gap:10px">
      <label>Tu nombre (opcional)
        <input id="cname" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,.12)">
      </label>
      <label>Teléfono (WhatsApp) <input id="cphone" required style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,.12)"></label>
      <label>Nota <textarea id="cnote" placeholder="Ej: Entrega 18:00" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,.12)"></textarea></label>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
        <button class="btn" type="submit">Confirmar pedido</button>
        <button class="btn ghost" type="button" onclick="closeCart()">Cerrar</button>
      </div>
    </form>
  </div>
</div>

<!-- Filter modal (Amazon-like) -->
<div class="filter-modal" id="filterModal" aria-hidden="true">
  <div class="filter-panel" role="dialog" aria-modal="true">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h3 style="margin:6px 0">Filtros</h3>
      <button class="btn ghost" type="button" onclick="closeFilters()">✕</button>
    </div>

    <div class="filter-section">
      <h4>Categorías</h4>
      <label><input type="checkbox" name="filter-cat" value="Servicios"> Servicios</label>
      <label><input type="checkbox" name="filter-cat" value="Comida"> Comida</label>
      <label><input type="checkbox" name="filter-cat" value="Tiendas"> Tiendas</label>
      <label><input type="checkbox" name="filter-cat" value="Salud"> Salud</label>
      <label><input type="checkbox" name="filter-cat" value="Transporte"> Transporte</label>
      <label><input type="checkbox" name="filter-cat" value="Tecnología"> Tecnología</label>
    </div>

    <div class="filter-section">
      <h4>Rango de precio (XAF)</h4>
      <label>Min: <input id="minPrice" type="number" style="width:120px"></label>
      <label>Max: <input id="maxPrice" type="number" style="width:120px"></label>
    </div>

    <div class="filter-actions">
      <button class="btn ghost" type="button" onclick="resetFilters()">Limpiar</button>
      <button class="btn" type="button" onclick="applyFilters()">Aplicar</button>
    </div>
  </div>
</div>

<footer class="footer">
  <span>© WapMarket — Pulsa <span class="kbd">/</span> para buscar</span>
  <a href="#">comprar</a>
  <a href="#">restaurante</a>
  <a href="#">negocios</a>
</footer>

<script src="/api.js"></script>
<script>
/* ====== JS PRINCIPAL (mejorado con filtros, dots en guiones y autoplay) ====== */
const DELIVERY_FEE = 2000;
let selectedBusiness = null;
let cart = JSON.parse(localStorage.getItem('cart') || '[]');
let currentProducts = [];

let pageSize = 20;
let currentPage = 1;

const qInput = document.getElementById('q');
const suggBox = document.getElementById('suggBox');

function saveCart(){ localStorage.setItem('cart', JSON.stringify(cart)); updateCartCount(); }
function updateCartCount(){
  const count = cart.reduce((a,c)=>a+Number(c.qty||1),0);
  document.getElementById('btnOpenCart').setAttribute('data-has-items', count>0 ? 'true' : 'false');
}
function closeCart(){ document.getElementById('cartModal').style.display='none'; }
function openCart(){ document.getElementById('cartModal').style.display='flex'; renderCart(); }

document.getElementById('btnOpenCart').addEventListener('click', (e)=>{ e.preventDefault(); openCart(); });

/* Filters button behavior */
document.getElementById('btnFilters').addEventListener('click', ()=> openFilters());

function openFilters(){
  document.getElementById('filterModal').style.display='flex';
  document.getElementById('filterModal').setAttribute('aria-hidden','false');
}
function closeFilters(){
  document.getElementById('filterModal').style.display='none';
  document.getElementById('filterModal').setAttribute('aria-hidden','true');
}
function resetFilters(){
  document.querySelectorAll('input[name="filter-cat"]').forEach(x=>x.checked=false);
  document.getElementById('minPrice').value = '';
  document.getElementById('maxPrice').value = '';
}
function applyFilters(){
  // combine checkboxes into category filter (if any checked)
  const cats = [...document.querySelectorAll('input[name="filter-cat"]:checked')].map(x=>x.value);
  // set the hidden category select to first selected or empty (we keep chips/search compatibility)
  document.getElementById('category').value = cats.length === 1 ? cats[0] : '';
  // Price filtering will be done client-side after loadProducts
  closeFilters();
  if (selectedBusiness) loadProducts();
}

/* Businesses & products (keeps original endpoints) */
async function loadBusinesses(){
  const data = await API.get('/public/businesses');
  const box = document.getElementById('bizList');
  box.innerHTML = '';
  (data.items||[]).forEach(b=>{
    const el = document.createElement('div');
    el.style.cssText = 'padding:12px;border:1px solid rgba(0,0,0,.08);border-radius:12px;background:var(--card);box-shadow:var(--shadow);cursor:pointer;transition:transform .15s ease';
    el.onmouseenter=()=>el.style.transform='translateY(-2px)';
    el.onmouseleave=()=>el.style.transform='translateY(0)';
    el.innerHTML = `
      <strong style="font-size:1.02rem">${b.name}</strong>
      ${b.business_type==='verified' ? '<span class="verified-badge"><img src="/aset/icons8-verified-50.png" alt="Verificado"></span>' : ''}
      <div class="small">${b.location||''}</div>`;
    el.addEventListener('click', ()=> setBusiness(b));
    box.appendChild(el);
  });
  if ((data.items||[]).length > 10){ box.classList.add('scrolling'); }
  if (!selectedBusiness && (data.items||[]).length) setBusiness(data.items[0]);
}

function setBusiness(b){
  selectedBusiness = b;
  document.getElementById('bizTitle').innerHTML =
    'Productos de ' + b.name + (b.business_type==='verified'
      ? '<span class="verified-badge"><img src="/aset/icons8-verified-50.png" alt="Verificado"></span>'
      : '');
  if (cart.length && cart[0].business_id !== b.id){
    if (confirm('Tu carrito pertenece a otro negocio. ¿Vaciar carrito para continuar con ' + b.name + '?')){
      cart = []; saveCart();
    }
  }
  currentPage = 1;
  loadProducts();
}

async function loadProducts(){
  if (!selectedBusiness) return;
  const q = document.getElementById('q').value.trim();
  const catHidden = document.getElementById('category').value;
  const params = new URLSearchParams();
  params.set('business_id', selectedBusiness.id);
  if (q) params.set('q', q);
  if (catHidden) params.set('category', catHidden);
  const data = await API.get('/public/products?' + params.toString());
  currentProducts = data.items || [];

  // Apply client-side price & multi-category filters from filter modal
  const minP = Number(document.getElementById('minPrice').value || 0);
  const maxP = Number(document.getElementById('maxPrice').value || 0);
  const cats = [...document.querySelectorAll('input[name="filter-cat"]:checked')].map(x=>x.value);
  if (cats.length){
    currentProducts = currentProducts.filter(p => cats.includes(p.category));
  }
  if (minP) currentProducts = currentProducts.filter(p => Number(p.price_xaf || 0) >= minP);
  if (maxP) currentProducts = currentProducts.filter(p => Number(p.price_xaf || 0) <= maxP);

  currentPage = 1;
  renderFeatured();
  renderProductsPage();
  renderSuggestions();
}

function renderProductsPage(){
  const list = document.getElementById('results');
  list.innerHTML = '';
  const start = (currentPage-1)*pageSize;
  const pageItems = currentProducts.slice(start, start+pageSize);

  pageItems.forEach((p, idx)=>{
    const el = document.createElement('div');
    el.className = 'product-item';
    el.innerHTML = `
<img class="thumb" src="${p.image_url || 'https://placehold.co/600x400?text=WapMarket'}" alt="">
<div class="meta">
  <h4 style="margin:0 0 4px; font-size:1rem">${p.title}</h4>
  <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
    <span class="price">${p.price_xaf ? Number(p.price_xaf).toLocaleString() + ' XAF' : ''}</span>
    <span class="badge">${p.category || ''}</span>
  </div>
  <div style="display:flex;gap:8px;justify-content:space-between;margin-top:6px">
    <button class="btn" data-id="${p.id}" title="Añadir al carrito">Añadir</button>
    <button class="btn ghost" data-prev="${p.image_url || ''}" title="Vista">Vista</button>
  </div>
</div>
`;
    list.appendChild(el);
  });

  const nextBtn = document.getElementById('nextBtn');
  if (currentProducts.length > pageSize){
    const startPlus = start + pageSize;
    nextBtn.style.display = startPlus < currentProducts.length ? 'inline-block' : 'none';
  } else nextBtn.style.display = 'none';

  list.onclick = (e)=>{
    const addBtn = e.target.closest('button[data-id]');
    if(addBtn){
      const id = addBtn.dataset.id;
      const p = currentProducts.find(x=>x.id == id);
      if (!p) return;
      if (cart.length && cart[0].business_id !== p.business_id){
        if (!confirm('Tu carrito es de otro negocio. ¿Vaciar y cambiar a ' + (selectedBusiness?.name||'este negocio') + '?')) return;
        cart = [];
      }
      const exists = cart.find(x=>x.id===p.id);
      if (exists) exists.qty = Number(exists.qty||1)+1;
      else cart.push({ id:p.id, title:p.title, price_xaf:p.price_xaf, image_url:p.image_url, category:p.category, qty:1, business_id: p.business_id });
      saveCart();
      addBtn.style.transform='scale(0.96)';
      setTimeout(()=>addBtn.style.transform='',120);
    }
  };
}

function renderFeatured(){
  const wrap = document.getElementById('featuredWrap');
  const car = document.getElementById('featCarousel');
  const dots = document.getElementById('featDots');
  if (!currentProducts.length){ wrap.style.display='none'; return; }

  const items = currentProducts.slice(0, Math.min(6, currentProducts.length));
  car.innerHTML = items.map(p=>`
    <div class="wa-slide">
      <a href="javascript:void(0)">
        <img src="${p.image_url || 'https://placehold.co/1200x480?text=WapMarket'}" alt="${p.title}">
        <p style="font-weight:800">${p.title} ${p.price_xaf ? '• '+Number(p.price_xaf).toLocaleString()+' XAF':''}</p>
      </a>
    </div>`).join('');

  dots.innerHTML = '';
  items.forEach((_,i)=>{
    const d = document.createElement('button'); d.className='wa-dot'+(i===0?' active':''); d.type='button';
    d.addEventListener('click',()=>featGo(i));
    dots.appendChild(d);
  });

  wrap.style.display='block';

  let idx=0;
  function featGo(i){
    const slides = items.length;
    idx = (i+slides)%slides;
    car.style.transform = `translateX(-${idx*100}%)`;
    [...dots.children].forEach((d,j)=>d.classList.toggle('active', j===idx));
  }
  document.querySelectorAll('.wa-btn[data-target="feat"]').forEach(b=>{
    b.onclick=()=>featGo(idx + Number(b.dataset.dir||1));
  });

  // Auto-advance for featured (new: dashes)
  if (items.length > 1){
    if (window._featInterval) clearInterval(window._featInterval);
    window._featInterval = setInterval(()=>{ featGo(idx+1); }, 4200);
  }
}

/* WhatsApp carousel with dash-dots and autoplay */
(function initWaCarousel(){
  const carousel = document.getElementById('waCarousel');
  const dotsBox = document.getElementById('waDots');
  const btns = document.querySelectorAll('.wa-btn:not([data-target])');
  if (!carousel || !dotsBox) return;

  const slides = Array.from(carousel.children);
  let idx = 0;

  // Create dots as dashes
  slides.forEach((_,i)=>{
    const dot=document.createElement('button');
    dot.className='wa-dot'+(i===0?' active':'');
    dot.type='button';
    dot.addEventListener('click',()=>go(i));
    dotsBox.appendChild(dot);
  });

  function go(i){
    idx = (i+slides.length)%slides.length;
    carousel.style.transform = `translateX(-${idx*100}%)`;
    [...dotsBox.children].forEach((d,j)=>d.classList.toggle('active', j===idx));
  }

  btns.forEach(b=>{
    b.addEventListener('click',()=>{
      const dir = Number(b.dataset.dir||1);
      go(idx+dir);
    });
  });

  // Touch
  let startX=0;
  carousel.addEventListener('touchstart',e=>{ startX=e.touches[0].clientX; }, {passive:true});
  carousel.addEventListener('touchend',e=>{
    const dx = e.changedTouches[0].clientX - startX;
    if (Math.abs(dx)>40) go(idx + (dx<0?1:-1));
  });

  // Auto-advance every 4.2s
  if (slides.length > 1){
    if (window._waInterval) clearInterval(window._waInterval);
    window._waInterval = setInterval(()=>{ go(idx+1); }, 4200);
  }
})();

/* Init */
function init(){
  categoryChipsInit();
  updateCartCount();
  loadBusinesses();
}
init();

/* Chips */
function categoryChipsInit(){
  const categories = ["Todas","Servicios","Comida","Tiendas","Salud","Transporte","Tecnología"];
  const wrap = document.getElementById('chips');
  wrap.innerHTML = '';
  categories.forEach(cat=>{
    const b = document.createElement('button');
    b.type='button'; b.className='chip'+(cat==="Todas"?' active':''); b.textContent=cat;
    b.dataset.value = cat==="Todas" ? "" : cat;
    b.addEventListener('click', ()=>{
      [...wrap.children].forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      document.getElementById('category').value = b.dataset.value;
      if (selectedBusiness) loadProducts();
    });
    wrap.appendChild(b);
  });
}

/* Cart rendering and checkout (kept original) */
function renderCart(){
  const box = document.getElementById('cartItems');
  const info = document.getElementById('cartInfo');
  if (!cart.length){
    box.innerHTML = '<p class="small">Tu carrito está vacío.</p>';
    info.textContent=''; document.getElementById('totals').textContent=''; return;
  }
  info.textContent = 'Negocio: ' + (selectedBusiness && cart[0].business_id===selectedBusiness.id ? selectedBusiness.name : ('#' + cart[0].business_id));
  box.innerHTML = '';
  let subtotal = 0;
  cart.forEach((item, idx)=>{
    const div = document.createElement('div');
    div.style.margin='8px 0';
    div.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <img src="${item.image_url || 'https://placehold.co/80'}" style="width:60px;height:60px;object-fit:cover;border-radius:12px;border:1px solid rgba(0,0,0,.08)">
        <div style="flex:1">
          <div><strong>${item.title}</strong></div>
          <div class="small">${(item.price_xaf||0).toLocaleString()} XAF • <span>${item.category||''}</span></div>
          <div style="display:flex;gap:6px;align-items:center;margin-top:6px">
            <button class="btn ghost" data-idx="${idx}" data-act="dec">-</button>
            <span style="min-width:24px;text-align:center">${item.qty}</span>
            <button class="btn ghost" data-idx="${idx}" data-act="inc">+</button>
            <button class="btn" data-idx="${idx}" data-act="del">Quitar</button>
          </div>
        </div>
      </div>
    `;
    subtotal += (Number(item.price_xaf||0) * Number(item.qty||1));
    box.appendChild(div);
  });
  const delivery = document.getElementById('deliveryChk').checked;
  const total = subtotal + (delivery ? DELIVERY_FEE : 0);
  document.getElementById('totals').textContent =
    'Subtotal: ' + subtotal.toLocaleString() + ' XAF' + (delivery? ' + Envío: 2.000 XAF = Total: ' + total.toLocaleString() + ' XAF' : ' = Total: ' + total.toLocaleString() + ' XAF');
  box.onclick = (e)=>{
    const btn = e.target.closest('button.btn,button.btn.ghost'); if(!btn) return;
    const i = Number(btn.dataset.idx); const act = btn.dataset.act;
    if (act==='inc') cart[i].qty = Number(cart[i].qty||1) + 1;
    if (act==='dec') cart[i].qty = Math.max(1, Number(cart[i].qty||1) - 1);
    if (act==='del') cart.splice(i,1);
    saveCart(); renderCart();
  }
}

document.getElementById('deliveryChk').addEventListener('change', (e)=>{
  document.getElementById('addressBox').style.display = e.target.checked ? 'block' : 'none';
  renderCart();
});

document.getElementById('btnBuscar').addEventListener('click', ()=>{ if (selectedBusiness) loadProducts(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='/'){ e.preventDefault(); qInput.focus(); } });

// Suggestions
let typingTimer;
qInput.addEventListener('input', ()=>{
  clearTimeout(typingTimer);
  typingTimer = setTimeout(()=>{ if(selectedBusiness) loadProducts(); }, 250);
  renderSuggestions();
});
qInput.addEventListener('focus', ()=>renderSuggestions());
document.addEventListener('click', e=>{
  if(!e.target.closest('.search')) suggBox.style.display='none';
});

function renderSuggestions(){
  const term = qInput.value.trim().toLowerCase();
  if(!term || !currentProducts.length){ suggBox.style.display='none'; return; }
  const matches = currentProducts
    .filter(p => (p.title||'').toLowerCase().includes(term))
    .slice(0,8);
  if(!matches.length){ suggBox.style.display='none'; return; }
  suggBox.innerHTML = matches.map(m=>`
    <li role="option" data-id="${m.id}">
      <img src="${m.image_url || 'https://placehold.co/80'}" alt="">
      <div style="display:flex;flex-direction:column">
        <strong style="line-height:1.1">${m.title}</strong>
        <span class="small">${m.category||''} ${m.price_xaf? '• '+Number(m.price_xaf).toLocaleString()+' XAF':''}</span>
      </div>
    </li>`).join('');
  suggBox.style.display='block';

  suggBox.querySelectorAll('li').forEach(li=>{
    li.onclick=()=>{
      const id = li.dataset.id;
      const p = currentProducts.find(x=>''+x.id === ''+id);
      if (p){
        qInput.value = p.title;
        suggBox.style.display='none';
        const idx = currentProducts.findIndex(x=>x.id===p.id);
        currentPage = Math.floor(idx / pageSize) + 1;
        renderProductsPage();
        const itemEl = [...document.querySelectorAll('.product-item')][idx % pageSize];
        if (itemEl) itemEl.scrollIntoView({behavior:'smooth', block:'center'});
      }
    };
  });
}

/* Pagination */
document.getElementById('nextBtn').addEventListener('click', ()=>{
  const maxPages = Math.ceil(currentProducts.length / pageSize);
  if (currentPage < maxPages){ currentPage++; renderProductsPage(); window.scrollTo({top:0,behavior:'smooth'}); }
});

/* Checkout submit (kept original) */
document.getElementById('checkoutForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (!cart.length) return alert('Tu carrito está vacío');
  const items = cart.map(c => ({ product_id: c.id, qty: c.qty }));
  const delivery = document.getElementById('deliveryChk').checked;
  const payload = {
    items,
    customer_name: document.getElementById('cname').value,
    customer_phone: document.getElementById('cphone').value,
    address: delivery ? document.getElementById('address').value : undefined,
    note: document.getElementById('cnote').value,
    delivery
  };
  const res = await API.post('/public/cart/checkout', payload);
  if (res.error){ alert(res.error); return; }
  alert('Pedido confirmado. Código de grupo: ' + res.group_id + '\\nTotal: ' + (res.total_xaf||0).toLocaleString() + ' XAF');
  cart = []; saveCart(); closeCart();
});
</script>
</body>
</html>
