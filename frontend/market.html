<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WapMarket — Marketplace GE</title>
  <link rel="stylesheet" href="/styles.css">

  <style>
    :root{
      --gap:16px;
      --aside-w:300px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      padding:0;
      background:#f7f7f9;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

/* ====== HEADER ====== */
.header {
  position: sticky;
  top: 0;
  z-index: 20;
  background: #131921; /* estilo Amazon */
  border-bottom: 1px solid #222;
}
.row {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: nowrap;
  padding: 6px 12px;
}
.logo {
  font-weight: 800;
  font-size: 1.5rem;
  color: #fff;
  flex-shrink:0;
}

/* buscador */
.search {
  display: flex;
  flex: 1;
  max-width: 800px;
  min-width: 180px;
}
.search input {
  flex: 1;
  padding: 7px 10px;
  border: 1px solid #ddd;
  border-radius: 0;
  font-size: 0.95rem;
}
#btnBuscar {
  background: #f90;
  color: #111;
  border: none;
  padding: 0 14px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  font-size: 0.9rem;
}

.menu-toggle{
  background:none;
  border:none;
  color:#fff;
  font-size:1.5rem;
  cursor:pointer;
  margin-right:8px;
  display:none;
}

/* ====== LAYOUT ====== */
.layout{display:grid;grid-template-columns: var(--aside-w) 1fr; gap:var(--gap);flex:1;position:relative}

aside{
  background:#fff;
  border-right:1px solid #eee;
  height:100%;
  overflow-y:auto;
  transition:transform .3s ease;
}

aside.hidden-mobile{
  transform:translateX(-100%);
  position:fixed;
  top:0;
  left:0;
  width:var(--aside-w);
  max-width:90%;
  height:100%;
  z-index:30;
}

aside.visible-mobile{
  transform:translateX(0);
}

.overlay{
  display:none;
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);
  z-index:25;
}
.overlay.active{display:block}

.card{background:#fff;border:1px solid #eee;border-radius:0}
.card .body{padding:12px 12px}
#bizList{display:flex;flex-direction:column;gap:8px}
#bizList.scrolling{max-height:380px;overflow:auto;border-top:1px dashed #eee;padding-top:8px}

#results.grid{display:grid;grid-template-columns: repeat(4, minmax(0,1fr));gap:var(--gap)}
.product-item{background:#fff;border:1px solid #eee;border-radius:0;}
.product-item .thumb{width:100%;aspect-ratio:4/3;object-fit:cover;display:block;border-bottom:1px solid #e9e9ee}
.product-item .meta{padding:8px 2px}
.badge{display:inline-block;font-size:12px;padding:4px 8px;border:1px solid #ddd;background:#fafafa}
.price{font-weight:800;margin:4px 0}

.verified-badge{display:inline-flex;align-items:center;margin-left:6px;vertical-align:middle}
.verified-badge img{width:18px;height:18px;object-fit:contain}

/* ====== PUBLICIDAD ====== */
.local-ads {margin: 20px 0;padding: 16px;background: #f9f9f9;border: 1px solid #ddd;}
.local-ads h3 {margin-bottom: 12px;font-size: 18px;color: #222;font-weight: 600;}
.ads-grid {display: grid;grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));gap: 12px;}
.ad-card {text-align: center;background: #fff;border: 1px solid #eee;padding: 8px;transition: transform 0.3s, box-shadow 0.3s;}
.ad-card img {width: 100%;height: 120px;object-fit: cover;}
.ad-card:hover {transform: scale(1.03);box-shadow: 0 2px 8px rgba(0,0,0,0.15);}
.ad-card p {margin-top: 6px;font-size: 14px;color: #444;}

/* ====== FOOTER ====== */
.footer{background:#fff;border-top:1px solid #eee;padding:12px;text-align:center;margin-top:auto}
.footer a{margin:0 8px;color:#111;text-decoration:underline;transition:color .2s}
.footer a:hover{color:#007bff;}

/* ====== RESPONSIVE ====== */
@media (max-width:900px){
  .layout{grid-template-columns:1fr}
  aside{position:fixed;top:0;left:0;height:100%;}
  .menu-toggle{display:block}
}
@media (max-width:600px){#results.grid{grid-template-columns: repeat(2,minmax(0,1fr));}}
@media (max-width:400px){#results.grid{grid-template-columns:1fr}}

  </style>
</head>
<body>

<header class="header">
  <div class="row wrapper">
    <button class="menu-toggle" id="menuToggle">☰</button>
    <div class="logo">WapMarket</div>
    <form id="searchForm" class="search" onsubmit="return false;">
      <input id="q" placeholder="Buscar productos o servicios..." />
      <button class="btn" id="btnBuscar">Buscar</button>
    </form>
  </div>
</header>

<div class="overlay" id="overlay"></div>

<main class="wrapper">
  <div class="layout">
    <aside id="sidebar" class="hidden-mobile">
      <div class="card">
        <div class="body">
          <h3>Negocios disponibles</h3>
          <div id="bizList"></div>
        </div>
      </div>
      <div class="card" style="margin-top:16px">
        <div class="body">
          <h3>Carrito</h3>
          <div id="cartItems"></div>
          <div style="margin-top:8px">
            <button class="btn" onclick="openCart()">Ver carrito</button>
          </div>
        </div>
      </div>
      <div class="card" style="margin-top:16px">
        <div class="body">
          <h3>Filtros</h3>
          <label>Categoría
            <select id="category" style="width:100%;padding:6px;border:1px solid #ddd">
              <option value="">Todas</option>
              <option>Servicios</option><option>Comida</option><option>Tiendas</option><option>Salud</option><option>Transporte</option><option>Tecnología</option>
            </select>
          </label>
        </div>
      </div>
      <!-- Publicidad fija -->
      <section class="local-ads">
        <h3>Publicidad</h3>
        <div class="ads-grid">
          <div class="ad-card">
            <a href="https://wa.me/240555218661" target="_blank">
              <img src="/aset/Captura de pantalla 2025-07-07 a la(s) 19.02.16.png" alt="Wap Tech & Services">
              <p>Wap Tech & Services</p>
            </a>
          </div>
          <div class="ad-card">
            <a href="https://wa.me/240555218661" target="_blank">
              <img src="/aset/app-check-hero_2x.png" alt="CiberSeguridad Prisma">
              <p>CiberSegurida Prisma</p>
            </a>
          </div>
        </div>
      </section>
    </aside>

    <section>
      <div class="card">
        <div class="body">
          <h3 id="bizTitle">Selecciona un negocio</h3>
          <div id="results" class="grid"></div>
          <div style="display:flex;justify-content:center;margin-top:12px">
            <button id="nextBtn" class="btn" style="display:none">Next</button>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<footer class="footer">
  <span>© WapMarket</span>
</footer>

<script src="/api.js"></script>
<script>
const sidebar=document.getElementById('sidebar');
const overlay=document.getElementById('overlay');
document.getElementById('menuToggle').onclick=()=>{
  sidebar.classList.toggle('visible-mobile');
  overlay.classList.toggle('active');
};
overlay.onclick=()=>{
  sidebar.classList.remove('visible-mobile');
  overlay.classList.remove('active');
};

let selectedBusiness=null;
let cart=[];
let currentProducts=[];

function setBusiness(b){
  selectedBusiness=b;
  document.getElementById('bizTitle').innerHTML=
    'Productos de '+b.name+(b.business_type==='verified'?'<span class="verified-badge"><img src="/aset/icons8-verified-50.png" alt="Verificado"></span>':'');
  loadProducts();
}

async function loadBusinesses(){
  const data=await API.get('/public/businesses');
  const box=document.getElementById('bizList');
  box.innerHTML='';
  (data.items||[]).forEach(b=>{
    const el=document.createElement('div');
    el.style.cssText='padding:8px;border:1px solid #eee;margin:6px 0;cursor:pointer;background:#fff;';
    el.innerHTML=`<strong>${b.name}</strong> ${b.business_type==='verified'?'<span class="verified-badge"><img src="/aset/icons8-verified-50.png" alt="Verificado"></span>':''}`;
    el.onclick=()=>{setBusiness(b);sidebar.classList.remove('visible-mobile');overlay.classList.remove('active');};
    box.appendChild(el);
  });
  if((data.items||[]).length) setBusiness(data.items[0]);
}

async function loadProducts(){
  if(!selectedBusiness)return;
  const data=await API.get('/public/products?business_id='+selectedBusiness.id);
  currentProducts=data.items||[];
  const list=document.getElementById('results');
  list.innerHTML='';
  currentProducts.forEach(p=>{
    const el=document.createElement('div');
    el.className='product-item';
    el.innerHTML=`
      <img class="thumb" src="${p.image_url||'https://placehold.co/600x400'}">
      <div class="meta">
        <div class="badge">${p.category||''}</div>
        <h4>${p.title}</h4>
        <div class="price">${p.price_xaf?Number(p.price_xaf).toLocaleString()+' XAF':''}</div>
        <button class="btn" onclick="addToCart(${p.id})">Añadir</button>
      </div>`;
    list.appendChild(el);
  });
}

function addToCart(id){
  const p=currentProducts.find(x=>x.id==id);
  if(!p) return;
  cart.push({...p,qty:1});
  renderCart();
}

function renderCart(){
  const box=document.getElementById('cartItems');
  box.innerHTML='';
  cart.forEach(item=>{
    const el=document.createElement('div');
    el.textContent=item.title+' x'+item.qty;
    box.appendChild(el);
  });
}

loadBusinesses();
</script>
</body>
</html>
