<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WapMarket — Marketplace GE (Aura Infinite)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      --brand:#0b0f19;        /* Dark base */
      --brand-2:#111827;      /* Sub base */
      --accent:#f59e0b;       /* Amber */
      --accent-2:#22d3ee;     /* Cyan */
      --surface:#0d1117;      /* bg */
      --panel:#0f172a;        /* panel */
      --glass:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.08);
      --muted:#9aa4b2;        /* text muted */
      --text:#eef2ff;         /* text */
      --radius:14px;
      --gap:14px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial;
      background:
        radial-gradient(1000px 400px at 80% -10%, rgba(34,211,238,.18), transparent 60%),
        radial-gradient(900px 500px at -10% 20%, rgba(245,158,11,.15), transparent 60%),
        linear-gradient(180deg, #070a12, #0a0f18 60%, #0b101a);
      color:var(--text);
      min-height:100vh;
    }

    /* ======= Topbar (glass + gradient) ======= */
    .header{position:sticky;top:0;z-index:70;backdrop-filter:saturate(1.2) blur(14px);
      background:linear-gradient(180deg, rgba(13,17,23,.85), rgba(13,17,23,.55));
      border-bottom:1px solid var(--line);
    }
    .top{
      height:64px;display:flex;align-items:center;justify-content:space-between;
      padding:0 14px;gap:10px;
    }
    .logo{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px}
    .logo-mark{width:28px;height:28px;border-radius:8px;
      background:conic-gradient(from 180deg, var(--accent), var(--accent-2), var(--accent));
      box-shadow:0 0 0 2px rgba(255,255,255,.06) inset, 0 10px 30px rgba(34,211,238,.15);
    }
    .logo span{font-size:1.05rem}

    /* Search bar (productos) */
    .search{display:flex;align-items:center;gap:8px;flex:1;max-width:820px}
    .search fieldset{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:var(--glass)}
    .search input{flex:1;min-width:120px;background:transparent;border:none;outline:none;color:var(--text)}
    .btn{border:none;border-radius:10px;background:var(--accent);color:#111;font-weight:700;padding:10px 14px;cursor:pointer}
    .btn:active{transform:translateY(1px)}

    /* Cart + Hamburger */
    .actions{display:flex;align-items:center;gap:8px}
    .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:42px;height:42px;border-radius:10px;border:1px solid var(--line);background:var(--glass);cursor:pointer}
    .icon-btn img{width:22px;height:22px}
    .hamburger{font-size:22px;color:var(--text)}
    #btnOpenCart[data-has-items="true"]{box-shadow:0 0 0 2px rgba(245,158,11,.25)}
    #btnOpenCart[data-has-items="true"]::after{content:"";position:absolute;top:6px;right:8px;width:9px;height:9px;border-radius:50%;background:#ff3b30}

    /* ======= Drawer menu ======= */
    .drawer{position:fixed;inset:0;z-index:80;display:none}
    .drawer.open{display:block}
    .drawer .scrim{position:absolute;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(1px)}
    .panel{position:absolute;top:0;left:0;height:100%;width:min(92vw,420px);background:#0b1018;border-right:1px solid var(--line);
      box-shadow:0 0 40px rgba(0,0,0,.4);display:flex;flex-direction:column}
    .panel header{padding:14px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px}
    .panel header .title{font-weight:800}
    .panel .inner{padding:14px;display:flex;flex-direction:column;gap:14px;overflow:auto}

    /* Business search */
    .biz-search{display:flex;gap:8px}
    .biz-search input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--glass);color:var(--text)}

    .biz-list{display:flex;flex-direction:column;gap:10px}
    .biz-card{padding:10px;border:1px solid var(--line);background:var(--glass);border-radius:12px;cursor:pointer;display:flex;align-items:flex-start;gap:10px}
    .biz-card:hover{border-color:rgba(34,211,238,.35)}
    .biz-avatar{width:36px;height:36px;border-radius:8px;background:#0e1623;border:1px solid var(--line)}
    .biz-meta{flex:1}
    .biz-name{font-weight:700}
    .biz-loc{color:var(--muted);font-size:12px}
    .v-badge{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border:1px solid rgba(34,211,238,.4);background:linear-gradient(180deg, rgba(34,211,238,.15), rgba(34,211,238,.05));border-radius:999px;font-size:12px}
    .v-badge img{width:16px;height:16px}

    /* ======= Main (solo productos + ads) ======= */
    main{padding:18px}
    .wrap{max-width:1200px;margin:0 auto}

    .headline{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:6px 2px 14px}
    .headline .biz-title{display:flex;align-items:center;gap:10px;font-weight:800}
    .headline .biz-title .ribbon{display:none}
    .headline .hint{color:var(--muted);font-size:12px}

    /* Verified ribbon visible si el negocio es verificado */
    .verified .headline .biz-title .ribbon{display:inline-flex;align-items:center;gap:6px;border:1px dashed rgba(34,211,238,.45);padding:4px 8px;border-radius:999px;background:linear-gradient(180deg, rgba(34,211,238,.15), rgba(34,211,238,.05));font-size:12px}
    .verified .headline .biz-title .ribbon img{width:16px;height:16px}

    /* Grid productos (3 columnas en móvil) */
    #results{display:grid;gap:var(--gap);grid-template-columns:repeat(5,minmax(0,1fr))}
    @media(max-width:1200px){#results{grid-template-columns:repeat(4,minmax(0,1fr))}}
    @media(max-width:960px){#results{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media(max-width:520px){#results{grid-template-columns:repeat(3,minmax(0,1fr))}}

    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
      border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .thumb{width:100%;aspect-ratio:1/1;object-fit:cover;display:block;background:#0a0f15;border-bottom:1px solid var(--line)}
    .meta{padding:10px}
    .meta .category{display:inline-block;font-size:11px;color:var(--muted);border:1px solid var(--line);padding:3px 8px;border-radius:999px}
    .meta h4{margin:6px 0 4px;font-size:14px}
    .price{font-weight:800}
    .cta{margin-top:8px}

    /* Ads grid con enlaces */
    .ads{margin:28px 0 8px}
    .ads h3{margin:0 0 10px}
    .ads-grid{display:grid;gap:12px;grid-template-columns:repeat(4,minmax(0,1fr))}
    @media(max-width:960px){.ads-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media(max-width:520px){.ads-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .ad{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:var(--glass);transition:transform .25s ease, box-shadow .25s ease}
    .ad:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .ad img{width:100%;height:120px;object-fit:cover;display:block}
    .ad .txt{padding:10px;font-size:14px}

    /* Modal base */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:90}
    .dialog{background:#0c121b;border:1px solid var(--line);border-radius:18px;padding:16px;max-width:560px;width:100%;max-height:85vh;overflow:auto}
    .small{color:var(--muted);font-size:.9em}

    /* Footer minimal */
    footer{padding:20px 14px;color:var(--muted);text-align:center;border-top:1px solid var(--line);background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01))}

    /* Utilities */
    .hide{display:none}
  </style>
</head>
<body>
  <!-- ======= HEADER ======= -->
  <header class="header">
    <div class="top wrap">
      <div class="logo"><div class="logo-mark"></div><span>WapMarket</span></div>
      <form id="searchForm" class="search" onsubmit="return false;">
        <fieldset>
          <input id="q" placeholder="Buscar productos o servicios..." />
          <button class="btn" id="btnBuscar" title="Buscar">Buscar</button>
        </fieldset>
      </form>
      <div class="actions">
        <button id="openDrawer" class="icon-btn hamburger" aria-label="Abrir menú" title="Menú">☰</button>
        <a href="#" class="icon-btn" id="btnOpenCart" aria-label="Abrir carrito" title="Carrito" data-has-items="false" style="position:relative">
          <img src="/aset/icons8-buy-64.png" alt="Carrito" />
        </a>
      </div>
    </div>
  </header>

  <!-- ======= DRAWER (hamburger) ======= -->
  <aside class="drawer" id="drawer">
    <div class="scrim" id="closeDrawer"></div>
    <div class="panel">
      <header>
        <div class="title">Menú</div>
        <div class="spacer" style="flex:1"></div>
        <button class="icon-btn" id="closeDrawerBtn" title="Cerrar">✕</button>
      </header>
      <div class="inner">
        <div>
          <div class="small" style="margin-bottom:6px">Buscar negocios</div>
          <div class="biz-search">
            <input id="bizSearch" placeholder="Escribe el nombre del negocio..." />
            <button class="btn" id="btnBizSearch">Buscar</button>
          </div>
        </div>
        <div>
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
            <strong>Negocios disponibles</strong>
            <span class="v-badge"><img src="/aset/icons8-verified-50.png" alt="Verificado"/> Verificados</span>
          </div>
          <div id="bizList" class="biz-list"></div>
        </div>
      </div>
    </div>
  </aside>

  <!-- ======= MAIN (solo productos + publicidad) ======= -->
  <main>
    <div class="wrap" id="page">
      <div class="headline" id="headline">
        <div class="biz-title">
          <h3 id="bizTitle" style="margin:0">Selecciona un negocio</h3>
          <span class="ribbon"><img src="/aset/icons8-verified-50.png" alt="Verificado"/> Verificado</span>
        </div>
        <div class="hint">Explora productos — toca un producto para añadirlo al carrito</div>
      </div>

      <div id="results"></div>

      <!-- Publicidad con enlaces (WhatsApp, etc.) -->
      <section class="ads">
        <h3>Publicidad</h3>
        <div class="ads-grid">
          <a class="ad" href="https://wa.me/240555218661" target="_blank" rel="noopener">
            <img src="/aset/Captura de pantalla 2025-07-07 a la(s) 19.02.16.png" alt="Wap Tech &amp; Services" />
            <div class="txt">Wap Tech &amp; Services</div>
          </a>
          <a class="ad" href="https://wa.me/240555218661" target="_blank" rel="noopener">
            <img src="/aset/app-check-hero_2x.png" alt="CiberSeguridad Prisma" />
            <div class="txt">CiberSeguridad Prisma</div>
          </a>
        </div>
      </section>

      <div style="display:flex;justify-content:center;margin:18px 0 2px">
        <button id="nextBtn" class="btn hide">Más</button>
      </div>
    </div>
  </main>

  <footer>
    <div class="wrap small">© WapMarket — Pulsa / para buscar • Diseñado con estética "aura infinita"</div>
  </footer>

  <!-- ======= MODALES ======= -->
  <div class="modal" id="cartModal">
    <div class="dialog">
      <h3>Tu carrito</h3>
      <div id="cartInfo" class="small" style="margin-bottom:8px"></div>
      <div id="cartItems"></div>
      <label style="display:block;margin-top:8px"><input type="checkbox" id="deliveryChk"> Envío a domicilio (+2000 XAF)</label>
      <div id="addressBox" style="display:none;margin-top:8px">
        <label>Dirección exacta
          <input id="address" placeholder="Ej: Malabo, Semu, casa azul" style="width:100%;margin-top:6px" />
        </label>
      </div>
      <div id="totals" style="margin:12px 0;font-weight:800"></div>
      <form id="checkoutForm">
        <label>Tu nombre (opcional)<input id="cname" style="width:100%"></label>
        <label>Teléfono (WhatsApp) <input id="cphone" required style="width:100%"></label>
        <label>Nota <textarea id="cnote" placeholder="Ej: Entrega 18:00" style="width:100%"></textarea></label>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
          <button class="btn" type="submit">Confirmar pedido</button>
          <button class="btn" type="button" onclick="closeCart()">Cerrar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9EEQZSC4X3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config','G-9EEQZSC4X3');
  </script>

  <script src="/api.js"></script>
  <script>
    /* ======= Estado y utilidades ======= */
    const DELIVERY_FEE = 2000;
    let selectedBusiness = null;
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    let currentProducts = [];

    let pageSize = 20;
    let currentPage = 1;

    function saveCart(){ localStorage.setItem('cart', JSON.stringify(cart)); updateCartCount(); }
    function updateCartCount(){
      const count = cart.reduce((a,c)=>a+Number(c.qty||1),0);
      document.getElementById('btnOpenCart').setAttribute('data-has-items', count>0 ? 'true' : 'false');
    }

    function closeCart(){ document.getElementById('cartModal').style.display='none'; }
    function openCart(){ document.getElementById('cartModal').style.display='flex'; renderCart(); }

    document.getElementById('btnOpenCart').addEventListener('click',(e)=>{e.preventDefault(); openCart();});

    /* ======= Drawer (hamburger) ======= */
    const drawer = document.getElementById('drawer');
    const openDrawerBtn = document.getElementById('openDrawer');
    const closeDrawerBtn = document.getElementById('closeDrawerBtn');
    const closeDrawerScrim = document.getElementById('closeDrawer');

    function openDrawer(){ drawer.classList.add('open'); }
    function closeDrawer(){ drawer.classList.remove('open'); }
    openDrawerBtn.addEventListener('click', openDrawer);
    closeDrawerBtn.addEventListener('click', closeDrawer);
    closeDrawerScrim.addEventListener('click', closeDrawer);

    /* ======= Negocios ======= */
    async function loadBusinesses(){
      const data = await API.get('/public/businesses');
      const box = document.getElementById('bizList');
      box.innerHTML = '';

      const items = (data.items||[]);
      items.forEach(b=> box.appendChild(renderBizCard(b)) );

      // Pre-selección
      if(!selectedBusiness && items.length) setBusiness(items[0]);
    }

    function renderBizCard(b){
      const el = document.createElement('div');
      el.className = 'biz-card';
      el.innerHTML = `
        <div class="biz-avatar"></div>
        <div class="biz-meta">
          <div class="biz-name">${b.name} ${b.business_type==='verified' ? '<span class="v-badge"><img src="/aset/icons8-verified-50.png" alt="Verificado"/> Verificado</span>' : ''}</div>
          <div class="biz-loc">${b.location||''}</div>
        </div>`;
      el.addEventListener('click',()=>{ setBusiness(b); closeDrawer(); });
      return el;
    }

    function setBusiness(b){
      selectedBusiness = b;
      const page = document.getElementById('page');
      if(b.business_type === 'verified') page.classList.add('verified'); else page.classList.remove('verified');
      document.getElementById('bizTitle').innerHTML = `Productos de ${b.name} ${b.business_type==='verified' ? '' : ''}`;
      currentPage = 1; loadProducts();
      if (cart.length && cart[0].business_id !== b.id){
        if (confirm('Tu carrito pertenece a otro negocio. ¿Vaciar carrito para continuar con '+b.name+'?')){ cart = []; saveCart(); }
      }
    }

    // Búsqueda de negocios (cliente)
    function filterBusinesses(term, list){
      term = term.toLowerCase();
      list.querySelectorAll('.biz-card').forEach(card=>{
        const name = card.querySelector('.biz-name')?.textContent?.toLowerCase()||'';
        const loc  = card.querySelector('.biz-loc')?.textContent?.toLowerCase()||'';
        card.style.display = (name.includes(term)||loc.includes(term))? 'flex':'none';
      });
    }

    document.getElementById('btnBizSearch').addEventListener('click',()=>{
      const term = document.getElementById('bizSearch').value.trim();
      filterBusinesses(term, document.getElementById('bizList'));
    });
    document.getElementById('bizSearch').addEventListener('input',(e)=>{
      filterBusinesses(e.target.value, document.getElementById('bizList'));
    });

    /* ======= Productos ======= */
    function renderProductsPage(){
      const list = document.getElementById('results');
      list.innerHTML = '';
      const start = (currentPage-1)*pageSize;
      const pageItems = currentProducts.slice(start, start+pageSize);

      pageItems.forEach(p=>{
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img class="thumb" src="${p.image_url || 'https://placehold.co/600x600?text=WapMarket'}" alt="${p.title||''}">
          <div class="meta">
            <span class="category">${p.category||''}</span>
            <h4>${p.title||''}</h4>
            <div class="price">${p.price_xaf ? (Number(p.price_xaf).toLocaleString()+' XAF') : ''}</div>
            <div class="cta"><button class="btn" data-id="${p.id}">Añadir</button></div>
          </div>`;
        list.appendChild(card);
      });

      const nextBtn = document.getElementById('nextBtn');
      if (currentProducts.length > pageSize){
        const more = (start + pageSize) < currentProducts.length;
        nextBtn.classList.toggle('hide', !more);
      } else {
        nextBtn.classList.add('hide');
      }

      list.onclick = (e)=>{
        const btn = e.target.closest('button[data-id]'); if(!btn) return;
        const id = btn.dataset.id;
        const p = currentProducts.find(x=>x.id == id); if(!p) return;
        if (cart.length && cart[0].business_id !== p.business_id){
          if (!confirm('Tu carrito es de otro negocio. ¿Vaciar y cambiar a '+(selectedBusiness?.name||'este negocio')+'?')) return;
          cart = [];
        }
        const exists = cart.find(x=>x.id===p.id);
        if (exists) exists.qty = Number(exists.qty||1)+1; else cart.push({ id:p.id, title:p.title, price_xaf:p.price_xaf, image_url:p.image_url, category:p.category, qty:1, business_id:p.business_id });
        saveCart();
      };
    }

    async function loadProducts(){
      if (!selectedBusiness) return;
      const q = document.getElementById('q').value.trim();
      const params = new URLSearchParams();
      params.set('business_id', selectedBusiness.id);
      if (q) params.set('q', q);
      const data = await API.get('/public/products?' + params.toString());
      currentProducts = data.items || [];
      currentPage = 1;
      renderProductsPage();
    }

    /* ======= Carrito ======= */
    function renderCart(){
      const box = document.getElementById('cartItems');
      const info = document.getElementById('cartInfo');
      if (!cart.length){ box.innerHTML = '<p>Tu carrito está vacío.</p>'; info.textContent=''; document.getElementById('totals').textContent=''; return; }
      info.textContent = 'Negocio: ' + (selectedBusiness && cart[0].business_id===selectedBusiness.id ? selectedBusiness.name : ('#' + cart[0].business_id));
      box.innerHTML = '';
      let subtotal = 0;
      cart.forEach((item, idx)=>{
        const div = document.createElement('div');
        div.style.margin='8px 0';
        div.innerHTML = `
          <div style="display:flex;gap:10px;align-items:center">
            <img src="${item.image_url || 'https://placehold.co/80'}" style="width:60px;height:60px;object-fit:cover;border-radius:8px">
            <div style="flex:1">
              <div><strong>${item.title}</strong> ${selectedBusiness?.business_type==='verified' ? '<span class="v-badge"><img src="/aset/icons8-verified-50.png" alt="V"/> VIP</span>' : ''}</div>
              <div class="small">${(item.price_xaf||0).toLocaleString()} XAF • <span>${item.category||''}</span></div>
              <div style="display:flex;gap:6px;align-items:center;margin-top:6px">
                <button class="btn" data-idx="${idx}" data-act="dec">-</button>
                <span>${item.qty}</span>
                <button class="btn" data-idx="${idx}" data-act="inc">+</button>
                <button class="btn" data-idx="${idx}" data-act="del">Quitar</button>
              </div>
            </div>
          </div>`;
        subtotal += (Number(item.price_xaf||0) * Number(item.qty||1));
        box.appendChild(div);
      });
      const delivery = document.getElementById('deliveryChk').checked;
      const total = subtotal + (delivery ? DELIVERY_FEE : 0);
      document.getElementById('totals').textContent = 'Subtotal: ' + subtotal.toLocaleString() + ' XAF' + (delivery? ' + Envío: 2.000 XAF = Total: ' + total.toLocaleString() + ' XAF' : ' = Total: ' + total.toLocaleString() + ' XAF');
      box.onclick = (e)=>{
        const btn = e.target.closest('button.btn'); if(!btn) return;
        const i = Number(btn.dataset.idx); const act = btn.dataset.act;
        if (act==='inc') cart[i].qty = Number(cart[i].qty||1) + 1;
        if (act==='dec') cart[i].qty = Math.max(1, Number(cart[i].qty||1) - 1);
        if (act==='del') cart.splice(i,1);
        saveCart(); renderCart();
      };
    }

    document.getElementById('deliveryChk').addEventListener('change',(e)=>{
      document.getElementById('addressBox').style.display = e.target.checked ? 'block' : 'none';
      renderCart();
    });

    document.getElementById('btnBuscar').addEventListener('click',()=>{ if (selectedBusiness) loadProducts(); });
    document.addEventListener('keydown',(e)=>{ if(e.key==='/'){ e.preventDefault(); document.getElementById('q').focus(); }});

    document.getElementById('checkoutForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!cart.length) return alert('Tu carrito está vacío');
      const items = cart.map(c => ({ product_id: c.id, qty: c.qty }));
      const delivery = document.getElementById('deliveryChk').checked;
      const payload = {
        items,
        customer_name: document.getElementById('cname').value,
        customer_phone: document.getElementById('cphone').value,
        address: delivery ? document.getElementById('address').value : undefined,
        note: document.getElementById('cnote').value,
        delivery
      };
      const res = await API.post('/public/cart/checkout', payload);
      if (res.error){ alert(res.error); return; }
      alert('Pedido confirmado. Código de grupo: ' + res.group_id + '\nTotal: ' + (res.total_xaf||0).toLocaleString() + ' XAF');
      cart = []; saveCart(); closeCart();
    });

    document.getElementById('nextBtn').addEventListener('click', ()=>{
      const maxPages = Math.ceil(currentProducts.length / pageSize);
      if (currentPage < maxPages){ currentPage++; renderProductsPage(); window.scrollTo({top:0,behavior:'smooth'}); }
    });

    /* ======= Init ======= */
    updateCartCount();
    loadBusinesses();
  </script>
</body>
</html>
