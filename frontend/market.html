<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WapMarket · Tienda</title>
<style>
:root{
  --amz-dark:#131921;
  --amz-yellow:#FF9900;
  --bg:#f6f7f9;
  --card:#fff;
  --muted:#6b7280;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:Inter,Arial,Helvetica,sans-serif}
body{background:var(--bg);color:#111;}
.header{background:var(--amz-dark);color:#fff;padding:12px 18px;display:flex;align-items:center;gap:12px;justify-content:space-between;}
.brand{font-weight:800;font-size:20px}
.controls{display:flex;gap:8px;margin:16px;}
.controls input, .controls select{padding:6px;border-radius:4px;border:1px solid #ccc;}
.products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;margin:16px;}
.product-card{background:var(--card);border-radius:8px;padding:10px;box-shadow:0 4px 12px rgba(0,0,0,0.05);display:flex;flex-direction:column;gap:8px}
.product-card img{width:100%;height:140px;object-fit:cover;border-radius:6px}
.btn{background:var(--amz-yellow);border:none;padding:8px 10px;border-radius:6px;cursor:pointer;font-weight:700}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000}
.modal-content{background:#fff;padding:20px;width:90%;max-width:480px;border-radius:8px;position:relative;max-height:80vh;overflow-y:auto}
.close-modal{position:absolute;top:8px;right:12px;font-size:18px;cursor:pointer;color:#333;font-weight:700}
.cart-item{display:flex;gap:8px;margin-bottom:8px;align-items:center}
.cart-item img{width:60px;height:60px;object-fit:cover;border-radius:4px}
.cart-item-details{flex:1;display:flex;flex-direction:column}
.cart-item-title{font-weight:700;font-size:14px}
.cart-item-qty{display:flex;gap:4px;align-items:center;font-size:13px}
.cart-item-qty input{width:40px;padding:2px 4px;border:1px solid #ccc;border-radius:4px;text-align:center}
.summary{margin-top:12px;font-weight:700}
.checkout-btn{margin-top:12px;width:100%;padding:10px;background:var(--amz-dark);color:#fff;border-radius:6px;cursor:pointer;font-weight:700}
.delivery-option{margin-top:8px;display:flex;align-items:center;gap:4px;font-size:14px}
.customer-info{margin-top:12px;display:flex;flex-direction:column;gap:6px}
.customer-info input, .customer-info textarea{padding:6px;border-radius:4px;border:1px solid #ccc;width:100%}
.footer{text-align:center;color:var(--muted);margin:20px 0;font-size:13px}
</style>
</head>
<body>
  <header class="header">
    <div class="brand">Wap<span style="color:var(--amz-yellow)">Market</span></div>
    <button id="openCartBtn" class="btn">Carrito (<span id="cartCount">0</span>)</button>
  </header>

  <div class="controls">
    <input type="text" id="searchInput" placeholder="Buscar productos..." />
    <select id="categoryFilter">
      <option value="">Todas las categorías</option>
    </select>
  </div>

  <main>
    <div id="productsContainer" class="products-grid"></div>
  </main>

  <div id="cartModal" class="modal">
    <div class="modal-content">
      <span id="closeCartBtn" class="close-modal">&times;</span>
      <h3>Carrito de compras</h3>
      <div id="cartItems"></div>

      <div class="delivery-option">
        <input type="checkbox" id="deliveryCheckbox" /> Envío a domicilio (+2000 XAF)
      </div>

      <div class="customer-info">
        <input type="text" id="customerName" placeholder="Nombre completo" />
        <input type="text" id="customerPhone" placeholder="Teléfono" />
        <textarea id="customerAddress" placeholder="Dirección (si es envío a domicilio)"></textarea>
      </div>

      <div class="summary">
        <div>Subtotal: <span id="subtotal">0</span> XAF</div>
        <div>Delivery: <span id="delivery">0</span> XAF</div>
        <div>Total: <span id="total">0</span> XAF</div>
      </div>

      <button id="checkoutBtn" class="checkout-btn">Pagar</button>
    </div>
  </div>

<script>
const API_BASE = 'https://wapmarket-backend-production.up.railway.app/api';
let products = [];
let filteredProducts = [];
let cart = [];

// Load products
async function loadProducts(){
  try{
    const res = await fetch(API_BASE+'/business/products');
    const data = await res.json();
    products = data.items || [];
    populateCategoryFilter();
    filteredProducts = [...products];
    renderProducts();
  }catch(e){ console.error('Error cargando productos',e); }
}

// Populate category filter
function populateCategoryFilter(){
  const select = document.getElementById('categoryFilter');
  const cats = Array.from(new Set(products.map(p=>p.category).filter(Boolean)));
  select.innerHTML='<option value="">Todas las categorías</option>';
  cats.forEach(c=>{ const opt=document.createElement('option'); opt.value=c; opt.textContent=c; select.appendChild(opt); });
}

// Render products
function renderProducts(){
  const container = document.getElementById('productsContainer');
  container.innerHTML='';
  if(!filteredProducts.length){ container.innerHTML='<p style="padding:16px;color:#555">No hay productos disponibles.</p>'; return; }
  filteredProducts.forEach(p=>{
    const div=document.createElement('div');
    div.className='product-card';
    div.innerHTML=`
      <img src="${p.image_url||'https://placehold.co/600x400?text=No+image'}" alt="${p.title}" />
      <strong>${p.title}</strong>
      <div class="small">${p.category||''}</div>
      <div style="font-weight:700">${Number(p.price_xaf||0).toLocaleString()} XAF</div>
      <button class="btn" data-id="${p.id}">Añadir al carrito</button>
    `;
    container.appendChild(div);
  });
}

// Search and filter
document.getElementById('searchInput').addEventListener('input', e=>{
  const term=e.target.value.toLowerCase();
  const cat=document.getElementById('categoryFilter').value;
  filteredProducts = products.filter(p=>{
    const matchesSearch=p.title.toLowerCase().includes(term) || (p.category||'').toLowerCase().includes(term);
    const matchesCat = cat? p.category===cat:true;
    return matchesSearch && matchesCat;
  });
  renderProducts();
});
document.getElementById('categoryFilter').addEventListener('change',()=>{ document.getElementById('searchInput').dispatchEvent(new Event('input')); });

// Cart
const cartModal=document.getElementById('cartModal');
const cartItems=document.getElementById('cartItems');
const subtotalEl=document.getElementById('subtotal');
const deliveryEl=document.getElementById('delivery');
const totalEl=document.getElementById('total');
const deliveryCheckbox=document.getElementById('deliveryCheckbox');

function updateCartCount(){ document.getElementById('cartCount').textContent = cart.reduce((a,c)=>a+c.qty,0); }

function renderCart(){
  cartItems.innerHTML='';
  if(!cart.length){ cartItems.innerHTML='<p>Carrito vacío.</p>'; subtotalEl.textContent='0'; deliveryEl.textContent='0'; totalEl.textContent='0'; return; }
  cart.forEach(item=>{
    const div=document.createElement('div');
    div.className='cart-item';
    div.innerHTML=`
      <img src="${item.image}" />
      <div class="cart-item-details">
        <div class="cart-item-title">${item.title}</div>
        <div class="cart-item-qty">
          Cantidad: <input type="number" min="1" value="${item.qty}" data-id="${item.id}" />
          <button data-id="${item.id}" class="btn" style="padding:2px 6px;background:#ccc;">Eliminar</button>
        </div>
      </div>
      <div>${Number(item.price).toLocaleString()} XAF</div>
    `;
    cartItems.appendChild(div);
  });
  updateSummary();
}

function updateSummary(){
  let subtotal=cart.reduce((sum,i)=>sum+i.price*i.qty,0);
  let delivery = deliveryCheckbox.checked? 2000:0;
  subtotalEl.textContent=subtotal.toLocaleString();
  deliveryEl.textContent=delivery.toLocaleString();
  totalEl.textContent=(subtotal+delivery).toLocaleString();
}

// Add to cart
document.getElementById('productsContainer').addEventListener('click',e=>{
  const btn = e.target.closest('button[data-id]');
  if(!btn) return;
  const id=btn.dataset.id;
  const p = products.find(x=>x.id==id);
  if(!p) return;
  const exist = cart.find(x=>x.id==id);
  if(exist){ exist.qty++; } else { cart.push({id:p.id,title:p.title,image:p.image_url||'https://placehold.co/600x400',price:Number(p.price_xaf||0),qty:1}); }
  renderCart(); updateCartCount();
});

// Cart modal
document.getElementById('openCartBtn').addEventListener('click',()=>{ cartModal.style.display='flex'; });
document.getElementById('closeCartBtn').addEventListener('click',()=>{ cartModal.style.display='none'; });
window.addEventListener('click',e=>{ if(e.target==cartModal) cartModal.style.display='none'; });

// Update qty and remove
cartItems.addEventListener('input',e=>{
  const input=e.target.closest('input[type="number"]');
  if(!input) return;
  const id=input.dataset.id;
  const item=cart.find(x=>x.id==id);
  if(!item) return;
  item.qty = Math.max(1, Number(input.value));
  renderCart(); updateCartCount();
});
cartItems.addEventListener('click',e=>{
  const btn = e.target.closest('button[data-id]');
  if(!btn) return;
  const id=btn.dataset.id;
  cart = cart.filter(x=>x.id!=id);
  renderCart(); updateCartCount();
});

// Delivery checkbox
deliveryCheckbox.addEventListener('change',()=>updateSummary());

// Checkout
document.getElementById('checkoutBtn').addEventListener('click',async ()=>{
  if(!cart.length) return alert('Carrito vacío');
  const name=document.getElementById('customerName').value.trim();
  const phone=document.getElementById('customerPhone').value.trim();
  const address=document.getElementById('customerAddress').value.trim();
  if(!name||!phone) return alert('Proporciona nombre y teléfono');
  if(deliveryCheckbox.checked && !address) return alert('Proporciona dirección para envío');
  try{
    const payload = {
      customer:{name,phone,address:deliveryCheckbox.checked?address:null},
      delivery_fee: deliveryCheckbox.checked?2000:0,
      items: cart.map(i=>({product_id:i.id, qty:i.qty}))
    };
    const res = await fetch(API_BASE+'/public/cart/checkout',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
    const data = await res.json();
    alert('Checkout OK: '+JSON.stringify(data));
    cart=[]; renderCart(); updateCartCount(); cartModal.style.display='none';
  }catch(e){ console.error(e); alert('Error checkout: '+(e.message||e)); }
});

loadProducts();
</script>
<div class="footer">© 2025 WapMarket - Tienda</div>
</body>
</html>
