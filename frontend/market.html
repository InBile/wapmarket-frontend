<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WapMarket · Marketplace</title>
<style>
:root{
  --amz-dark:#131921;
  --amz-yellow:#FF9900;
  --bg:#f6f7f9;
  --card:#fff;
  --muted:#6b7280;
  --btn-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#111;display:flex;flex-direction:column;min-height:100vh}
.header{background:var(--amz-dark);color:#fff;padding:12px 18px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;position:sticky;top:0;z-index:100}
.brand{font-weight:800;font-size:18px}
.container{max-width:1100px;margin:20px auto;padding:0 16px;flex-grow:1}
.grid{display:grid;grid-template-columns:320px 1fr;gap:16px}
.card{background:var(--card);border:1px solid #e6e6e6;border-radius:8px;padding:14px;box-shadow:0 6px 18px rgba(17,24,39,0.04)}
.small{font-size:13px;color:var(--muted)}
.btn{background:var(--amz-yellow);border:none;padding:8px 10px;border-radius:6px;cursor:pointer;font-weight:700;box-shadow:var(--btn-shadow)}
.btn.ghost{background:transparent;border:1px solid #ddd;color:#111;box-shadow:none}

/* Main */
.topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
.form-row{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
.input, textarea, select{padding:8px;border-radius:6px;border:1px solid #ddd;width:100%}
.products-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
.product-card{border:1px solid #e6e6e6;border-radius:8px;padding:10px;background:#fff;display:flex;flex-direction:column;gap:8px}
.product-card img{width:100%;height:140px;object-fit:cover;border-radius:6px}

.footer{margin-top:auto;text-align:center;color:var(--muted);font-size:13px;padding:12px 18px}

/* Custom styles for the marketplace */
.product-item {
  border: 1px solid #e6e6e6;
  border-radius: 8px;
  padding: 10px;
  background: #fff;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.product-item img {
  width: 100%;
  height: 140px;
  object-fit: cover;
  border-radius: 6px;
}
.product-item .meta {
  display: flex;
  flex-direction: column;
  gap: 6px;
  align-items: stretch;
}
.product-item .meta h4 {
  margin: 0;
  font-size: 1rem;
  font-weight: 600;
  line-height: 1.2;
}
.product-item .price {
  font-size: 1.06rem;
  font-weight: 800;
}
.product-item .badge {
  font-size: 0.88rem;
  padding: 4px 6px;
  background: #f0f0f0;
  border-radius: 4px;
}

/* New grid layout */
.products-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 12px;
}
@media (max-width: 1200px) {
  .products-grid {
    grid-template-columns: repeat(4, 1fr);
  }
}
@media (max-width: 900px) {
  .products-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}
@media (max-width: 600px) {
  .products-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

.modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  z-index: 99999;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}
.modal.right{
  align-items:stretch;
  justify-content:flex-end;
  padding:0
}
.modal.right .dialog{
  height:100%;
  border-radius:0;
  border-left:1px solid #e6e6e6;
  padding:1rem;
  animation:slideIn 0.25s ease both;
  width: min(480px, 100%);
}
.dialog{
  background:var(--card);
  width: min(480px, 100%);
  max-width: 90%;
  border-radius:8px;
  box-shadow:0 18px 50px rgba(17,24,39,0.12);
  padding:1rem;
  animation:fadeIn 0.25s ease both;
}
@keyframes fadeIn {
  from { transform: scale(0.95); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
@keyframes slideIn {
  from { transform: translateX(30px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}
.product-card{
  border:1px solid #e6e6e6;border-radius:8px;padding:10px;background:#fff;display:flex;flex-direction:column;gap:8px
}
.product-card img{
  width:100%;height:140px;object-fit:cover;border-radius:6px
}
.product-card .meta>div:last-child{
  display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:6px
}
.product-card .btn,.product-card .btn.ghost{
  flex:1 1 auto;min-width:0;padding:8px 10px
}
.search{
  display:flex;flex:1;max-width:720px;position:relative;gap:0
}
.search input{
  flex:1;padding:8px;border-radius:6px 0 0 6px;border:1px solid #ddd;outline:none;height:auto
}
#btnBuscar{
  background:var(--amz-yellow);border:none;padding:8px 10px;border-radius:0 6px 6px 0;cursor:pointer;font-weight:700
}
.search .sugg{
  position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #e6e6e6;border-radius:8px;box-shadow:0 6px 18px rgba(17,24,39,0.04);z-index:10;margin-top:4px
}
.sugg li{
  list-style:none;padding:8px;display:flex;gap:8px;align-items:center;cursor:pointer
}
.sugg li:hover{
  background:#f6f7f9
}

/* Sidebar changes */
.grid {
  display: grid;
  grid-template-columns: 280px 1fr;
  gap: 16px;
}
.sidebar {
  position: sticky;
  top: 80px; /* Adjust top to be below header */
  height: calc(100vh - 100px);
  overflow-y: auto;
  border-right: 1px solid #e6e6e6;
  padding-right: 16px;
  background: var(--bg);
}
.sidebar .card {
  box-shadow: none;
  border: none;
  padding: 0;
}
.biz-item {
  padding: 12px 14px;
  cursor: pointer;
  border-bottom: 1px solid #f0f0f0;
}
.biz-item:hover {
  background: #eee;
}
.biz-item:last-child {
  border-bottom: none;
}
/* Main section changes to remove card border */
.main .card{
  padding:0;
  box-shadow:none;
  border:none;
  background:transparent;
}

/* New Cart Icon */
.cart-btn-icon {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 8px 10px;
  border-radius: 6px;
  background: var(--amz-yellow);
  box-shadow: var(--btn-shadow);
  cursor: pointer;
  border: none;
}
.cart-btn-icon svg {
  width: 24px;
  height: 24px;
  fill: #fff;
  stroke: #fff;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
}
.cart-btn-icon[data-has-items="true"]::after {
  content: attr(data-item-count);
  position: absolute;
  top: -8px;
  right: -8px;
  background: red;
  color: white;
  border-radius: 50%;
  padding: 2px 6px;
  font-size: 11px;
  font-weight: bold;
}
</style>
</head>
<body>
<header class="header">
  <div class="brand">Wap<span style="color:var(--amz-yellow)">Market</span></div>
  <form id="searchForm" class="search" onsubmit="return false;">
    <input id="q" placeholder="Buscar productos..." autocomplete="off" />
    <button class="btn" id="btnBuscar" aria-label="Buscar">Buscar</button>
    <ul id="suggBox" class="sugg" role="listbox" style="display:none"></ul>
  </form>
  <button class="cart-btn-icon" id="btnOpenCart" aria-label="Abrir carrito" title="Carrito" data-has-items="false" data-item-count="0">
    <!-- Icono profesional de carrito de compras -->
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4H6zM3.86 6l2.14-4h12l2.14 4H3.86zM5 10h14M5 14h14M5 18h14"></path>
    </svg>
  </button>
</header>
<div class="container">
  <div class="grid">
    <aside class="sidebar">
      <div class="card">
        <h3>Negocios disponibles</h3>
        <p class="small">Selecciona un negocio para ver sus productos.</p>
        <div id="bizList"></div>
      </div>
    </aside>
    <main class="main">
      <div class="topbar">
        <div style="display:flex;flex-direction:column">
          <strong id="bizTitle">Selecciona un negocio</strong>
          <span class="small">Lista de productos disponibles.</span>
        </div>
      </div>
      <div class="card">
        <div id="results" class="products-grid"></div>
        <div style="display:flex;justify-content:center;margin-top:12px">
          <button id="nextBtn" class="btn" style="display:none">Ver más</button>
        </div>
      </div>
    </main>
  </div>
</div>
<footer class="footer">
  <span>© 2025 WapMarket</span>
</footer>

<!-- Modales de confirmación y alerta personalizados -->
<div id="customModal" class="modal">
  <div class="dialog">
    <p id="modalMessage"></p>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:1rem">
      <button class="btn" id="modalConfirmBtn" style="display:none">OK</button>
      <button class="btn ghost" id="modalCancelBtn">Cerrar</button>
    </div>
  </div>
</div>

<!-- Drawer Carrito -->
<div class="modal right" id="cartModal">
  <div class="dialog">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h3 style="margin:6px 0">Tu carrito</h3>
      <button class="btn ghost" type="button" onclick="closeCart()">✕</button>
    </div>
    <div id="cartInfo" class="small" style="margin-bottom:8px"></div>
    <div id="cartItems"></div>
    <div style="margin:12px 0">
      <label style="display:flex;gap:8px;align-items:center">
        <input type="checkbox" id="deliveryChk"> <span>Envío a domicilio (+2000 XAF)</span>
      </label>
    </div>
    <div id="addressBox" style="display:none">
      <label style="display:block;margin-bottom:10px">Dirección exacta
        <input id="address" placeholder="Ej: Malabo, Semu, casa azul" class="input">
      </label>
    </div>
    <div id="totals" style="margin:12px 0;font-weight:900"></div>
    <form id="checkoutForm" style="display:grid;gap:10px">
      <label>Tu nombre (opcional)
        <input id="cname" class="input">
      </label>
      <label>Teléfono (WhatsApp) <input id="cphone" required class="input"></label>
      <label>Nota <textarea id="cnote" placeholder="Ej: Entrega 18:00" class="input"></textarea></label>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
        <button class="btn" type="submit">Confirmar pedido</button>
        <button class="btn ghost" type="button" onclick="closeCart()">Cerrar</button>
      </div>
    </form>
  </div>
</div>

<script src="/api.js"></script>
<script>
// Funciones de modal personalizadas para reemplazar alert() y confirm()
function showModal(message, isConfirm = false) {
  const modal = document.getElementById('customModal');
  const msgEl = document.getElementById('modalMessage');
  const confirmBtn = document.getElementById('modalConfirmBtn');
  const cancelBtn = document.getElementById('modalCancelBtn');

  msgEl.textContent = message;
  modal.style.display = 'flex';
  return new Promise(resolve => {
    if (isConfirm) {
      confirmBtn.style.display = 'inline-block';
      confirmBtn.onclick = () => {
        modal.style.display = 'none';
        resolve(true);
      };
      cancelBtn.onclick = () => {
        modal.style.display = 'none';
        resolve(false);
      };
    } else {
      confirmBtn.style.display = 'none';
      cancelBtn.onclick = () => {
        modal.style.display = 'none';
        resolve(true);
      };
    }
  });
}

// Manteniendo la lógica de JS original, adaptada al nuevo HTML
const DELIVERY_FEE = 2000;
let selectedBusiness = null;
let cart = JSON.parse(localStorage.getItem('cart') || '[]');
let currentProducts = [];

let pageSize = 20;
let currentPage = 1;

const qInput = document.getElementById('q');
const suggBox = document.getElementById('suggBox');

function saveCart(){ localStorage.setItem('cart', JSON.stringify(cart)); updateCartCount(); }
function updateCartCount(){
  const count = cart.reduce((a,c)=>a+Number(c.qty||1),0);
  const btn = document.getElementById('btnOpenCart');
  btn.setAttribute('data-has-items', count > 0 ? 'true' : 'false');
  btn.setAttribute('data-item-count', count);
}
function closeCart(){ document.getElementById('cartModal').style.display='none'; }
function openCart(){ document.getElementById('cartModal').style.display='flex'; renderCart(); }

document.getElementById('btnOpenCart').addEventListener('click', (e)=>{ e.preventDefault(); openCart(); });

async function setBusiness(b){
  selectedBusiness = b;
  document.getElementById('bizTitle').innerHTML =
    'Productos de ' + b.name + (b.business_type==='verified'
      ? '<span class="small" style="margin-left:8px;color:var(--amz-yellow)">✔ Verificado</span>'
      : '');
  if (cart.length && cart[0].business_id !== b.id){
    const confirmed = await showModal('Tu carrito pertenece a otro negocio. ¿Vaciar carrito para continuar con ' + b.name + '?', true);
    if(confirmed) {
      cart = []; saveCart();
    }
  }
  currentPage = 1;
  loadProducts();
}

async function loadBusinesses(){
  const data = await API.get('/public/businesses');
  const box = document.getElementById('bizList');
  box.innerHTML = '';
  (data.items||[]).forEach(b=>{
    const el = document.createElement('div');
    el.className = 'biz-item';
    el.innerHTML = `
      <strong style="font-size:1.02rem">${b.name}</strong>
      ${b.business_type==='verified' ? '<span class="small" style="margin-left:4px;color:var(--amz-yellow)">✔</span>' : ''}
      <div class="small">${b.location||''}</div>`;
    el.addEventListener('click', ()=> setBusiness(b));
    box.appendChild(el);
  });
  if (!selectedBusiness && (data.items||[]).length) setBusiness(data.items[0]);
}

function renderProductsPage(){
  const list = document.getElementById('results');
  list.innerHTML = '';
  const start = (currentPage-1)*pageSize;
  const pageItems = currentProducts.slice(start, start+pageSize);

  if (pageItems.length === 0) {
    list.innerHTML = '<p class="small" style="padding:0 14px">No hay productos disponibles para este negocio.</p>';
    document.getElementById('nextBtn').style.display = 'none';
    return;
  }

  pageItems.forEach(p=>{
    const el = document.createElement('div');
    el.className = 'product-item';
    el.innerHTML = `
<img class="thumb" src="${p.image_url || 'https://placehold.co/240x180?text=WapMarket'}" alt="">
<div class="meta">
  <h4 style="margin:0 0 4px; font-size:1rem">${p.title}</h4>
  <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
    <span class="price">${p.price_xaf ? Number(p.price_xaf).toLocaleString() + ' XAF' : ''}</span>
    <span class="badge">${p.category || ''}</span>
  </div>
  <div style="display:flex;gap:8px;justify-content:flex-start;margin-top:6px">
    <button class="btn" data-id="${p.id}" title="Añadir al carrito">Añadir</button>
  </div>
</div>
`;
    list.appendChild(el);
  });

  const nextBtn = document.getElementById('nextBtn');
  if (currentProducts.length > currentPage * pageSize){
    nextBtn.style.display = 'inline-block';
  } else {
    nextBtn.style.display = 'none';
  }

  list.onclick = async (e)=>{
    const addBtn = e.target.closest('button[data-id]');
    if(addBtn){
      const id = addBtn.dataset.id;
      const p = currentProducts.find(x=>x.id == id);
      if (!p) return;

      if (cart.length && cart[0].business_id !== p.business_id){
        const confirmed = await showModal('Tu carrito es de otro negocio. ¿Vaciar y cambiar a ' + (selectedBusiness?.name||'este negocio') + '?', true);
        if(!confirmed) return;
        cart = [];
      }
      const exists = cart.find(x=>x.id===p.id);
      if (exists) exists.qty = Number(exists.qty||1)+1;
      else cart.push({ id:p.id, title:p.title, price_xaf:p.price_xaf, image_url:p.image_url, category:p.category, qty:1, business_id: p.business_id });
      saveCart();

      addBtn.style.transform='scale(0.96)';
      setTimeout(()=>addBtn.style.transform='',120);
    }
  };
}

async function loadProducts(){
  if (!selectedBusiness) return;
  const q = document.getElementById('q').value.trim();
  const params = new URLSearchParams();
  params.set('business_id', selectedBusiness.id);
  if (q) params.set('q', q);
  const data = await API.get('/public/products?' + params.toString());
  currentProducts = data.items || [];
  currentPage = 1;
  renderProductsPage();
  renderSuggestions();
}

function renderCart(){
  const box = document.getElementById('cartItems');
  const info = document.getElementById('cartInfo');
  if (!cart.length){
    box.innerHTML = '<p class="small">Tu carrito está vacío.</p>';
    info.textContent=''; document.getElementById('totals').textContent=''; return;
  }
  info.textContent = 'Negocio: ' + (selectedBusiness && cart[0].business_id===selectedBusiness.id ? selectedBusiness.name : ('#' + cart[0].business_id));
  box.innerHTML = '';
  let subtotal = 0;
  cart.forEach((item, idx)=>{
    const div = document.createElement('div');
    div.style.margin='8px 0';
    div.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <img src="${item.image_url || 'https://placehold.co/80'}" style="width:60px;height:60px;object-fit:cover;border-radius:6px;border:1px solid #e6e6e6">
        <div style="flex:1">
          <div><strong>${item.title}</strong></div>
          <div class="small">${(item.price_xaf||0).toLocaleString()} XAF • <span>${item.category||''}</span></div>
          <div style="display:flex;gap:6px;align-items:center;margin-top:6px">
            <button class="btn ghost" data-idx="${idx}" data-act="dec">-</button>
            <span style="min-width:24px;text-align:center">${item.qty}</span>
            <button class="btn" data-idx="${idx}" data-act="inc">+</button>
            <button class="btn ghost" data-idx="${idx}" data-act="del">Quitar</button>
          </div>
        </div>
      </div>
    `;
    subtotal += (Number(item.price_xaf||0) * Number(item.qty||1));
    box.appendChild(div);
  });
  const delivery = document.getElementById('deliveryChk').checked;
  const total = subtotal + (delivery ? DELIVERY_FEE : 0);
  document.getElementById('totals').textContent =
    `Subtotal: ${subtotal.toLocaleString()} XAF` + (delivery ? ` + Envío: 2.000 XAF = Total: ${total.toLocaleString()} XAF` : ` = Total: ${total.toLocaleString()} XAF`);
  box.onclick = (e)=>{
    const btn = e.target.closest('button.btn,button.btn.ghost'); if(!btn) return;
    const i = Number(btn.dataset.idx); const act = btn.dataset.act;
    if (act==='inc') cart[i].qty = Number(cart[i].qty||1) + 1;
    if (act==='dec') cart[i].qty = Math.max(1, Number(cart[i].qty||1) - 1);
    if (act==='del') cart.splice(i,1);
    saveCart(); renderCart();
  }
}

document.getElementById('deliveryChk').addEventListener('change', (e)=>{
  document.getElementById('addressBox').style.display = e.target.checked ? 'block' : 'none';
  renderCart();
});

document.getElementById('btnBuscar').addEventListener('click', ()=>{ if (selectedBusiness) loadProducts(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='/'){ e.preventDefault(); qInput.focus(); } });

document.getElementById('nextBtn').addEventListener('click', ()=>{
  const maxPages = Math.ceil(currentProducts.length / pageSize);
  if (currentPage < maxPages){ currentPage++; renderProductsPage(); window.scrollTo({top:0,behavior:'smooth'}); }
});

let typingTimer;
qInput.addEventListener('input', ()=>{
  clearTimeout(typingTimer);
  typingTimer = setTimeout(()=>{ if(selectedBusiness) loadProducts(); }, 250);
  renderSuggestions();
});
qInput.addEventListener('focus', ()=>renderSuggestions());
document.addEventListener('click', e=>{
  if(!e.target.closest('.search')) suggBox.style.display='none';
});

function renderSuggestions(){
  const term = qInput.value.trim().toLowerCase();
  if(!term || !currentProducts.length){ suggBox.style.display='none'; return; }
  const matches = currentProducts
    .filter(p => (p.title||'').toLowerCase().includes(term))
    .slice(0,8);
  if(!matches.length){ suggBox.style.display='none'; return; }
  suggBox.innerHTML = matches.map(m=>`
    <li role="option" data-id="${m.id}">
      <img src="${m.image_url || 'https://placehold.co/80'}" style="width:40px;height:40px;object-fit:cover;border-radius:6px;border:1px solid #e6e6e6" alt="">
      <div style="display:flex;flex-direction:column">
        <strong style="line-height:1.1">${m.title}</strong>
        <span class="small">${m.category||''} ${m.price_xaf? '• '+Number(m.price_xaf).toLocaleString()+' XAF':''}</span>
      </div>
    </li>`).join('');
  suggBox.style.display='block';

  suggBox.querySelectorAll('li').forEach(li=>{
    li.onclick=()=>{
      const id = li.dataset.id;
      const p = currentProducts.find(x=>''+x.id === ''+id);
      if (p){
        qInput.value = p.title;
        suggBox.style.display='none';
        const idx = currentProducts.findIndex(x=>x.id===p.id);
        currentPage = Math.floor(idx / pageSize) + 1;
        renderProductsPage();
        const itemEl = [...document.querySelectorAll('.product-item')][idx % pageSize];
        if (itemEl) itemEl.scrollIntoView({behavior:'smooth', block:'center'});
      }
    };
  });
}

function init(){
  updateCartCount();
  loadBusinesses();
}
init();

document.getElementById('checkoutForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (!cart.length) { showModal('Tu carrito está vacío'); return; }
  const items = cart.map(c => ({ product_id: c.id, qty: c.qty }));
  const delivery = document.getElementById('deliveryChk').checked;
  const payload = {
    items,
    customer_name: document.getElementById('cname').value,
    customer_phone: document.getElementById('cphone').value,
    address: delivery ? document.getElementById('address').value : undefined,
    note: document.getElementById('cnote').value,
    delivery
  };
  const res = await API.post('/public/cart/checkout', payload);
  if (res.error){ showModal(res.error); return; }
  showModal('Pedido confirmado. Código de grupo: ' + res.group_id + '\nTotal: ' + (res.total_xaf||0).toLocaleString() + ' XAF');
  cart = []; saveCart(); closeCart();
});
</script>
</body>
</html>
