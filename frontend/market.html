<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WapMarket — Marketplace GE</title>
  <link rel="stylesheet" href="/styles.css">

  <!-- Fuente Futura PT -->
  <style>
    @import url('https://fonts.cdnfonts.com/css/futura-pt');

    :root{
      --gap:16px;
      --aside-w:300px;
      --bg:#f6f7fb;
      --bg-elev:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --brand:#0ea5e9; /* azul cielo */
      --brand-2:#22c55e; /* verde */
      --accent:#f97316; /* naranja */
      --ring: rgba(14,165,233,.35);
      --shadow: 0 6px 20px rgba(2,8,23,.08);
      --radius: 14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      padding:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      display:flex;flex-direction:column;min-height:100vh
    }

    .wrapper{max-width:1200px;margin:0 auto;padding:14px}

/* ====== HEADER (Top Bar mejorado) ====== */
.header{position:sticky;top:0;z-index:30;background:#0b1220;color:#fff;border-bottom:1px solid rgba(255,255,255,.06);backdrop-filter:saturate(140%) blur(6px)}
.header .row{display:flex;align-items:center;gap:12px;flex-wrap:wrap;padding:10px 14px}
.logo{font-family:'Futura PT',sans-serif;font-weight:800;font-size:1.4rem;letter-spacing:.3px;color:#fff;display:flex;align-items:center;gap:10px}
.logo::after{content:"";display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--brand)}

/* buscador */
.search{display:flex;flex:1;max-width:720px;align-items:center;gap:8px}
.search .field{display:flex;align-items:center;gap:8px;background:#0e1628;border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:6px 10px;flex:1;box-shadow:inset 0 0 0 1px transparent;transition:box-shadow .2s,border-color .2s}
.search .field:focus-within{box-shadow:0 0 0 3px rgba(14,165,233,.25);border-color:var(--ring)}
.search input{flex:1;background:transparent;border:none;outline:0;color:#fff;font-size:.98rem}
.search input::placeholder{color:#cdd2d9}
#btnBuscar{background:linear-gradient(135deg,var(--brand),#60a5fa);color:#081226;border:none;border-radius:999px;padding:10px 16px;font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:8px;box-shadow:var(--shadow);transform:translateZ(0);transition:transform .12s ease}
#btnBuscar:active{transform:scale(.98)}

/* botón carrito */
#btnOpenCart{position:relative;display:inline-flex;align-items:center;justify-content:center;background:#0e1628;color:#fff;border:1px solid rgba(255,255,255,.08);border-radius:999px;height:42px;padding:0 14px;margin-left:4px;text-decoration:none;box-shadow:inset 0 -4px 0 rgba(255,255,255,.03)}
#btnOpenCart img{width:22px;height:22px;object-fit:contain;filter:brightness(95%)}
#btnOpenCart[data-has-items="true"]::after{content:"";position:absolute;top:6px;right:6px;width:9px;height:9px;border-radius:50%;background:#ff3b30;box-shadow:0 0 0 4px rgba(255,59,48,.25)}

/* ====== LAYOUT ====== */
.layout{display:grid;grid-template-columns: var(--aside-w) 1fr; gap:var(--gap);flex:1}
.card{background:var(--bg-elev);border:1px solid #eef0f6;border-radius:var(--radius);box-shadow:var(--shadow)}
.card .body{padding:14px}

aside{margin-left:-2px}
#bizList{display:flex;flex-direction:column;gap:8px}
#bizList.scrolling{max-height:380px;overflow:auto;border-top:1px dashed #eee;padding-top:8px}

.badge{display:inline-block;font-size:12px;padding:4px 8px;border:1px solid #e6e9f2;border-radius:999px;background:#f8fafc;color:#0f172a}
.price{font-weight:800;margin:4px 0}

/* ====== GRID de productos (ahora con 2x2 en móvil) ====== */
#results.grid{display:grid;grid-template-columns: repeat(4, minmax(0,1fr));gap:var(--gap)}
.product-item{background:var(--bg-elev);border:1px solid #eef0f6;border-radius:16px;overflow:hidden;box-shadow:var(--shadow);transition:transform .18s ease, box-shadow .18s ease}
.product-item:hover{transform:translateY(-2px);box-shadow:0 12px 24px rgba(2,8,23,.10)}
.product-item .thumb{width:100%;aspect-ratio:4/3;object-fit:cover;display:block}
.product-item .meta{padding:10px 12px}
.product-item h4{margin:6px 0 2px;font-size:1rem;line-height:1.2}
.product-item .btn{border-radius:10px}

/* ====== Verified (NO CAMBIAR ICONO) ====== */
.verified-badge{display:inline-flex;align-items:center;margin-left:10px;vertical-align:middle}
.verified-badge img{width:22px;height:22px;object-fit:contain}

/* ====== Aside Filtros ====== */
select,input,textarea{width:100%;padding:10px;border:1px solid #e6e9f2;border-radius:12px;background:#fff}
label{display:block;margin:8px 0 6px}

/* ====== Botones base ====== */
.btn{background:#0f172a;color:#fff;border:none;border-radius:12px;padding:8px 12px;font-weight:700;cursor:pointer;transition:transform .12s ease,box-shadow .12s ease}
.btn:active{transform:scale(.98)}
.btn.secondary{background:#111827}
.btn.ghost{background:#f8fafc;color:#111;border:1px solid #e6e9f2}

/* ====== CARRUSEL PUBLICIDAD (mejorado) ====== */
.wa-ads{margin:20px 0;padding:0;background:transparent;border:none}
.wa-ads h3{margin:0 0 10px;font-size:18px;color:#111827;font-weight:800}
.wa-carousel-wrap{position:relative;overflow:hidden;border:1px solid #eef0f6;background:#fff;border-radius:16px;box-shadow:var(--shadow)}
.wa-carousel{display:flex;transition:transform .5s cubic-bezier(.2,.8,.2,1);will-change:transform}
.wa-slide{min-width:100%;flex-shrink:0;text-align:center}
.wa-slide a{display:block;text-decoration:none;color:inherit}
.wa-slide img{width:100%;height:220px;object-fit:cover;display:block}
.wa-slide p{margin:8px 0 12px;font-size:14px}
.wa-nav{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:10px}
.wa-btn{background:#0f172a;color:#fff;border:none;width:40px;height:40px;border-radius:50%;cursor:pointer;box-shadow:var(--shadow)}
.wa-dots{display:flex;gap:6px;flex:1;justify-content:center}
.wa-dot{width:8px;height:8px;border-radius:50%;background:#cfd5e1;border:none}
.wa-dot.active{background:#0f172a}

/* ====== MODALS y TOASTS ====== */
.modal{position:fixed;inset:0;background:rgba(2,8,23,.45);display:none;align-items:center;justify-content:center;padding:16px}
.dialog{background:#fff;padding:16px;border-radius:16px;max-width:520px;width:100%;max-height:80vh;overflow:auto;box-shadow:var(--shadow)}
.small{font-size:.9em;color:var(--muted)}
.kbd{font-family:ui-monospace,Menlo,Consolas,monospace}

.toast{position:fixed;left:50%;top:24px;transform:translateX(-50%) translateY(-20px);opacity:0;background:#111827;color:#fff;padding:12px 16px;border-radius:12px;box-shadow:var(--shadow);z-index:50;transition:transform .25s ease,opacity .25s ease}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* ====== EFECTO CONFETTI simple ====== */
#confetti{position:fixed;inset:0;pointer-events:none;z-index:60}
.confetti-piece{position:absolute;width:8px;height:14px;opacity:0;animation:fall 1200ms linear forwards}
@keyframes fall{0%{transform:translateY(-20px) rotate(0);opacity:1}100%{transform:translateY(100vh) rotate(540deg);opacity:0}}

/* ====== FOOTER ====== */
.footer{background:#fff;border-top:1px solid #eef0f6;padding:16px;text-align:center;margin-top:auto}
.footer a{margin:0 8px;color:#111827;text-decoration:underline;transition:color .2s}
.footer a:hover{color:#0ea5e9}

/* ====== RESPONSIVE ====== */
@media (max-width:1100px){#results.grid{grid-template-columns: repeat(3,minmax(0,1fr));}:root{--aside-w:260px}}
@media (max-width:900px){.layout{grid-template-columns:1fr}aside{order:2}section{order:1}#results.grid{grid-template-columns: repeat(2,minmax(0,1fr));}}
/* Cambio clave: 2x2 en móviles pequeños */
@media (max-width:520px){.header .row{flex-direction:column;align-items:stretch;gap:8px}.search{width:100%}.wa-slide img{height:180px}.dialog{padding:12px}.logo{text-align:center;margin-bottom:4px}#results.grid{grid-template-columns: repeat(2,minmax(0,1fr));gap:12px}}

  </style>
</head>
<body>

<header class="header">
  <div class="row wrapper">
    <div class="logo">WapMarket</div>
    <form id="searchForm" class="search" onsubmit="return false;">
      <div class="field">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 21l-3.5-3.5" stroke="#cdd2d9" stroke-width="2" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="#cdd2d9" stroke-width="2"/></svg>
        <input id="q" placeholder="Buscar productos o servicios..." />
      </div>
      <button class="btn" id="btnBuscar" aria-label="Buscar">Buscar</button>
    </form>
    <a href="#" class="btn ghost" id="btnOpenCart" aria-label="Abrir carrito" title="Carrito" data-has-items="false">
      <img src="/aset/icons8-buy-64.png" alt="Carrito">
    </a>
  </div>
</header>

<main class="wrapper">
  <div class="layout">
    <aside>
      <div class="card">
        <div class="body">
          <h3 style="margin-top:0">Negocios disponibles</h3>
          <div id="bizList"></div>
        </div>
      </div>
      <div class="card" style="margin-top:16px">
        <div class="body">
          <h3>Filtros</h3>
          <label>Categoría
            <select id="category">
              <option value="">Todas</option>
              <option>Servicios</option><option>Comida</option><option>Tiendas</option><option>Salud</option><option>Transporte</option><option>Tecnología</option>
            </select>
          </label>
        </div>
      </div>

      <!-- Publicidad legado (conservado/oculto) -->
      <div class="ads-container" style="display:none !important"></div>
    </aside>

    <section>
      <div class="card">
        <div class="body">
          <h3 id="bizTitle">Selecciona un negocio</h3>
          <div id="results" class="grid"></div>
          <div style="display:flex;justify-content:center;margin-top:12px">
            <button id="nextBtn" class="btn" style="display:none">Más productos</button>
          </div>
        </div>
      </div>

      <!-- Publicidad en carrusel -->
      <section class="wa-ads" aria-label="Publicidad">
        <h3>Publicidad</h3>
        <div class="wa-carousel-wrap">
          <div class="wa-carousel" id="waCarousel">
            <div class="wa-slide">
              <a href="https://wa.me/240555218661" target="_blank" rel="noopener">
                <img src="/aset/Captura de pantalla 2025-07-07 a la(s) 19.02.16.png" alt="Wap Tech & Services">
                <p>Wap Tech &amp; Services</p>
              </a>
            </div>
            <div class="wa-slide">
              <a href="https://wa.me/240555218661" target="_blank" rel="noopener">
                <img src="/aset/app-check-hero_2x.png" alt="CiberSeguridad Prisma">
                <p>CiberSeguridad Prisma</p>
              </a>
            </div>
          </div>
        </div>
        <div class="wa-nav">
          <button class="wa-btn" type="button" data-dir="-1" aria-label="Anterior">‹</button>
          <div class="wa-dots" id="waDots"></div>
          <button class="wa-btn" type="button" data-dir="1" aria-label="Siguiente">›</button>
        </div>
      </section>
    </section>
  </div>
</main>

<!-- Modal carrito -->
<div class="modal" id="cartModal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true">
    <h3>Tu carrito</h3>
    <div id="cartInfo" class="small" style="margin-bottom:8px"></div>
    <div id="cartItems"></div>
    <label style="margin-top:8px"><input type="checkbox" id="deliveryChk"> Envío a domicilio (+2000 XAF)</label>
    <div id="addressBox" style="display:none">
      <label>Dirección exacta
        <input id="address" placeholder="Ej: Malabo, Semu, casa azul">
      </label>
    </div>
    <div id="totals" style="margin:12px 0;font-weight:800"></div>
    <form id="checkoutForm">
      <label>Tu nombre (opcional)<input id="cname"></label>
      <label>Teléfono (WhatsApp) <input id="cphone" required></label>
      <label>Nota <textarea id="cnote" placeholder="Ej: Entrega 18:00"></textarea></label>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" type="submit">Confirmar pedido</button>
        <button class="btn ghost" type="button" onclick="closeCart()">Cerrar</button>
      </div>
    </form>
  </div>
</div>

<!-- Toasts y Confetti -->
<div class="toast" id="toast"></div>
<div id="confetti"></div>

<footer class="footer">
  <span>© WapMarket — Pulsa <span class="kbd">/</span> para buscar</span>
  <a href="#">comprar</a>
  <a href="#">reserva hotel</a>
  <a href="#">restaurantes</a>
  <a href="#">negocios</a>
  <a href="#">comprar billetes</a>
  <a href="#">empleos</a>
</footer>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9EEQZSC4X3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-9EEQZSC4X3');
</script>

<script src="/api.js"></script>
<script>
/* ====== JS (manteniendo tu lógica, mejorando UI/UX) ====== */
const DELIVERY_FEE = 2000;
let selectedBusiness = null;
let cart = JSON.parse(localStorage.getItem('cart') || '[]');
let currentProducts = [];
let pageSize = 20;
let currentPage = 1;

function saveCart(){ localStorage.setItem('cart', JSON.stringify(cart)); updateCartCount(); }
function updateCartCount(){
  const count = cart.reduce((a,c)=>a+Number(c.qty||1),0);
  document.getElementById('btnOpenCart').setAttribute('data-has-items', count>0 ? 'true' : 'false');
}
function closeCart(){ document.getElementById('cartModal').style.display='none'; document.getElementById('cartModal').setAttribute('aria-hidden','true'); }
function openCart(){ document.getElementById('cartModal').style.display='flex'; document.getElementById('cartModal').setAttribute('aria-hidden','false'); renderCart(); }

/* Toast util */
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2400); }

/* Confetti sencillo */
function burstConfetti(){
  const box = document.getElementById('confetti');
  const colors=['#10b981','#0ea5e9','#f59e0b','#ef4444','#8b5cf6'];
  for(let i=0;i<60;i++){
    const s=document.createElement('span');
    s.className='confetti-piece';
    s.style.left=Math.random()*100+'%';
    s.style.top='-10px';
    s.style.background=colors[Math.floor(Math.random()*colors.length)];
    s.style.animationDelay=(Math.random()*300)+'ms';
    s.style.transform=`translateY(-20px) rotate(${Math.random()*180}deg)`;
    box.appendChild(s);
    setTimeout(()=>s.remove(), 1600);
  }
}

/* Publicidad modal legado (conservada pero no visible) */
function openAdsInfo(){ var m=document.getElementById('adsModal'); if(m) m.style.display='flex'; }
function closeAdsInfo(){ var m=document.getElementById('adsModal'); if(m) m.style.display='none'; }

document.getElementById('btnOpenCart').addEventListener('click', (e)=>{ e.preventDefault(); openCart(); });

function setBusiness(b){
  selectedBusiness = b;
  document.getElementById('bizTitle').innerHTML =
    'Productos de ' + b.name + (b.business_type==='verified'
      ? '<span class="verified-badge"><img src="/aset/icons8-verified-50.png" alt="Verificado"></span>'
      : '');
  if (cart.length && cart[0].business_id !== b.id){
    if (confirm('Tu carrito pertenece a otro negocio. ¿Vaciar carrito para continuar con ' + b.name + '?')){
      cart = []; saveCart();
    }
  }
  currentPage = 1;
  loadProducts();
}

async function loadBusinesses(){
  const data = await API.get('/public/businesses');
  const box = document.getElementById('bizList');
  box.innerHTML = '';
  (data.items||[]).forEach(b=>{
    const el = document.createElement('div');
    el.style.cssText = 'padding:10px;border:1px solid #eef0f6;border-radius:12px;margin:8px 0;cursor:pointer;background:#fff;display:flex;align-items:center;justify-content:space-between;gap:8px';
    el.innerHTML = `
      <div>
        <strong>${b.name}</strong>
        ${b.business_type==='verified' ? '<span class="verified-badge"><img src="/aset/icons8-verified-50.png" alt="Verificado"></span>' : ''}
        <div class="small">${b.location||''}</div>
      </div>`;
    el.addEventListener('click', ()=> setBusiness(b));
    box.appendChild(el);
  });
  if ((data.items||[]).length > 10){ box.classList.add('scrolling'); }
  if (!selectedBusiness && (data.items||[]).length) setBusiness(data.items[0]);
}

function renderProductsPage(){
  const list = document.getElementById('results');
  list.innerHTML = '';
  const start = (currentPage-1)*pageSize;
  const pageItems = currentProducts.slice(start, start+pageSize);

  pageItems.forEach(p=>{
    const el = document.createElement('div');
    el.className = 'product-item';
    el.innerHTML = `
      <img class="thumb" src="${p.image_url || 'https://placehold.co/600x400?text=WapMarket'}" alt="${p.title||''}">
      <div class="meta">
        <div class="badge">${p.category || ''}</div>
        <h4>${p.title}</h4>
        <div class="price">${p.price_xaf ? (Number(p.price_xaf).toLocaleString() + ' XAF') : ''}</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" data-id="${p.id}">Añadir</button>
        </div>
      </div>`;
    list.appendChild(el);
  });

  const nextBtn = document.getElementById('nextBtn');
  if (currentProducts.length > pageSize){
    const startPlus = start + pageSize;
    nextBtn.style.display = startPlus < currentProducts.length ? 'inline-block' : 'none';
  } else {
    nextBtn.style.display = 'none';
  }

  list.onclick = (e)=>{
    const btn = e.target.closest('button[data-id]'); if(!btn) return;
    const id = btn.dataset.id;
    const p = currentProducts.find(x=>x.id == id);
    if (!p) return;

    if (cart.length && cart[0].business_id !== p.business_id){
      if (!confirm('Tu carrito es de otro negocio. ¿Vaciar y cambiar a ' + (selectedBusiness?.name||'este negocio') + '?')) return;
      cart = [];
    }
    const exists = cart.find(x=>x.id===p.id);
    if (exists) exists.qty = Number(exists.qty||1)+1; else cart.push({ id:p.id, title:p.title, price_xaf:p.price_xaf, image_url:p.image_url, category:p.category, qty:1, business_id: p.business_id });
    saveCart();
    toast('Añadido al carrito');
  };
}

async function loadProducts(){
  if (!selectedBusiness) return;
  const q = document.getElementById('q').value.trim();
  const cat = document.getElementById('category').value;
  const params = new URLSearchParams();
  params.set('business_id', selectedBusiness.id);
  if (q) params.set('q', q);
  if (cat) params.set('category', cat);
  const data = await API.get('/public/products?' + params.toString());
  currentProducts = data.items || [];
  currentPage = 1;
  renderProductsPage();
}

function renderCart(){
  const box = document.getElementById('cartItems');
  const info = document.getElementById('cartInfo');
  if (!cart.length){ box.innerHTML = '<p>Tu carrito está vacío.</p>'; info.textContent=''; document.getElementById('totals').textContent=''; return; }
  info.textContent = 'Negocio: ' + (selectedBusiness && cart[0].business_id===selectedBusiness.id ? selectedBusiness.name : ('#' + cart[0].business_id));
  box.innerHTML = '';
  let subtotal = 0;
  cart.forEach((item, idx)=>{
    const div = document.createElement('div');
    div.style.margin='8px 0';
    div.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <img src="${item.image_url || 'https://placehold.co/80'}" style="width:60px;height:60px;object-fit:cover;border-radius:8px" alt="${item.title}">
        <div style="flex:1">
          <div><strong>${item.title}</strong></div>
          <div class="small">${(item.price_xaf||0).toLocaleString()} XAF • <span>${item.category||''}</span></div>
          <div style="display:flex;gap:6px;align-items:center;margin-top:6px">
            <button class="btn ghost" data-idx="${idx}" data-act="dec">-</button>
            <span>${item.qty}</span>
            <button class="btn ghost" data-idx="${idx}" data-act="inc">+</button>
            <button class="btn secondary" data-idx="${idx}" data-act="del">Quitar</button>
          </div>
        </div>
      </div>
    `;
    subtotal += (Number(item.price_xaf||0) * Number(item.qty||1));
    box.appendChild(div);
  });
  const delivery = document.getElementById('deliveryChk').checked;
  const total = subtotal + (delivery ? DELIVERY_FEE : 0);
  document.getElementById('totals').textContent = 'Subtotal: ' + subtotal.toLocaleString() + ' XAF' + (delivery? ' + Envío: 2.000 XAF = Total: ' + total.toLocaleString() + ' XAF' : ' = Total: ' + total.toLocaleString() + ' XAF');
  box.onclick = (e)=>{
    const btn = e.target.closest('button.btn'); if(!btn) return;
    const i = Number(btn.dataset.idx); const act = btn.dataset.act;
    if (act==='inc') cart[i].qty = Number(cart[i].qty||1) + 1;
    if (act==='dec') cart[i].qty = Math.max(1, Number(cart[i].qty||1) - 1);
    if (act==='del') cart.splice(i,1);
    saveCart(); renderCart();
  }
}

document.getElementById('deliveryChk').addEventListener('change', (e)=>{
  document.getElementById('addressBox').style.display = e.target.checked ? 'block' : 'none';
  renderCart();
});

document.getElementById('btnBuscar').addEventListener('click', ()=>{ if (selectedBusiness) loadProducts(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='/'){ e.preventDefault(); document.getElementById('q').focus(); } });
document.getElementById('category').addEventListener('change', ()=>{ if (selectedBusiness) loadProducts(); });

document.getElementById('checkoutForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (!cart.length){ alert('Tu carrito está vacío'); return; }
  const items = cart.map(c => ({ product_id: c.id, qty: c.qty }));
  const delivery = document.getElementById('deliveryChk').checked;
  const payload = {
    items,
    customer_name: document.getElementById('cname').value,
    customer_phone: document.getElementById('cphone').value,
    address: delivery ? document.getElementById('address').value : undefined,
    note: document.getElementById('cnote').value,
    delivery
  };
  const res = await API.post('/public/cart/checkout', payload);
  if (res.error){ alert(res.error); return; }
  // Éxito con animación
  burstConfetti();
  toast('✅ Pedido confirmado');
  // Pequeño resumen en toast extendido
  setTimeout(()=>toast('Código de grupo: ' + res.group_id + ' — Total: ' + (res.total_xaf||0).toLocaleString() + ' XAF'), 900);
  cart = []; saveCart(); closeCart();
});

document.getElementById('nextBtn').addEventListener('click', ()=>{
  const maxPages = Math.ceil(currentProducts.length / pageSize);
  if (currentPage < maxPages){ currentPage++; renderProductsPage(); window.scrollTo({top:0,behavior:'smooth'}); }
});

/* ====== CARRUSEL WHATSAPP (mejorado con autoplay + teclado + swipe) ====== */
(function initWaCarousel(){
  const carousel = document.getElementById('waCarousel');
  const dotsBox = document.getElementById('waDots');
  const btns = document.querySelectorAll('.wa-btn');
  if (!carousel || !dotsBox) return;

  const slides = Array.from(carousel.children);
  let idx = 0; let timer = null; const AUTO_MS = 5500;

  function makeDots(){ dotsBox.innerHTML=''; slides.forEach((_,i)=>{ const d=document.createElement('button'); d.className='wa-dot'+(i===0?' active':''); d.type='button'; d.addEventListener('click',()=>go(i,true)); dotsBox.appendChild(d); }); }
  makeDots();

  function go(i, stop=false){
    idx = (i+slides.length)%slides.length;
    carousel.style.transform = `translateX(-${idx*100}%)`;
    [...dotsBox.children].forEach((d,j)=>d.classList.toggle('active', j===idx));
    if (stop) resetAuto();
  }

  function resetAuto(){ clearInterval(timer); timer = setInterval(()=>go(idx+1), AUTO_MS); }
  resetAuto();

  btns.forEach(b=> b.addEventListener('click',()=> go(idx + Number(b.dataset.dir||1), true)) );

  // Swipe táctil
  let startX=0; carousel.addEventListener('touchstart',e=>{ startX=e.touches[0].clientX; }, {passive:true});
  carousel.addEventListener('touchend',e=>{ const dx = e.changedTouches[0].clientX - startX; if (Math.abs(dx)>40) go(idx + (dx<0?1:-1), true); }, {passive:true});

  // Teclado
  document.addEventListener('keydown',e=>{ if(e.key==='ArrowLeft') go(idx-1,true); if(e.key==='ArrowRight') go(idx+1,true); });
})();

updateCartCount();
loadBusinesses();
</script>
</body>
</html>
