<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WapMarket — Tienda</title>
<style>
:root{
  --amz-dark:#131921;
  --amz-yellow:#FF9900;
  --bg:#f6f7f9;
  --card:#fff;
  --muted:#6b7280;
  --border:#e6e6e6;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Inter,Arial,Helvetica,sans-serif;
  background:var(--bg);
  color:#111;
  display:flex; flex-direction:column; min-height:100vh;
}

/* ===== HEADER (igual al admin) ===== */
.header{
  background:var(--amz-dark);
  color:#fff;
  padding:12px 18px;
  display:flex; align-items:center; gap:12px; justify-content:space-between;
}
.brand{font-weight:800;font-size:18px;display:flex;align-items:center;gap:6px}
.brand .mark{color:var(--amz-yellow)}
.header-actions{display:flex;gap:8px;align-items:center}
.btn{background:var(--amz-yellow);border:none;padding:9px 12px;border-radius:6px;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.35);color:#fff}
.cart-btn{display:inline-flex;gap:8px;align-items:center}

/* ===== LAYOUT ===== */
.container{max-width:1100px;margin:20px auto;padding:0 16px;flex:1;width:100%}
.card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:14px;box-shadow:0 6px 18px rgba(17,24,39,0.04)}

/* ===== PRODUCT GRID (único contenedor) ===== */
.products-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.product-card{border:1px solid var(--border);border-radius:8px;padding:10px;background:#fff;display:flex;flex-direction:column;gap:8px}
.product-card img{width:100%;height:140px;object-fit:cover;border-radius:6px}
.product-title{font-weight:700;line-height:1.2}
.product-meta{display:flex;justify-content:space-between;align-items:center;gap:8px}
.price{font-weight:800;color:#B12704}
.badge{font-size:12px;border:1px solid var(--border);padding:4px 6px;border-radius:4px;background:#fafafa}
.actions{display:flex;gap:8px}
.actions .btn{flex:1}

/* ===== FOOTER ===== */
.footer{margin:20px 0;text-align:center;color:var(--muted);font-size:13px}

/* ===== MODAL (carrito) ===== */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:stretch;justify-content:flex-end;padding:0;z-index:1000}
.dialog{
  background:#fff; width:min(520px,100%); height:100%; overflow:auto;
  border-left:1px solid var(--border); padding:16px;
}
.small{font-size:13px;color:var(--muted)}

/* ===== responsive ===== */
@media (max-width:900px){
  .products-list{grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}
}
</style>
</head>
<body>

<header class="header">
  <div class="brand">Wap<span class="mark">Market</span></div>
  <div class="header-actions">
    <button id="btnOpenCart" class="btn ghost cart-btn" title="Carrito">
      <span>Carrito</span>
      <span id="cartCount" class="small" style="color:#fff;opacity:.9">(0)</span>
    </button>
  </div>
</header>

<main class="container">
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <div style="display:flex;flex-direction:column">
        <strong>Productos disponibles</strong>
        <span class="small">Lista cargada desde <code>/api/public/…</code></span>
      </div>
      <!-- (Opcional) buscador rápido; se mantiene en header limpio -->
      <input id="q" class="small" placeholder="Buscar…" style="padding:8px;border:1px solid var(--border);border-radius:6px;min-width:220px" />
    </div>
    <div id="results" class="products-list"></div>
  </div>
</main>

<!-- Carrito -->
<div class="modal" id="cartModal" aria-hidden="true">
  <div class="dialog">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h3 style="margin:6px 0">Tu carrito</h3>
      <button class="btn" type="button" id="closeCartBtn">Cerrar</button>
    </div>
    <div id="cartInfo" class="small" style="margin-bottom:8px"></div>
    <div id="cartItems"></div>
    <div style="margin:12px 0">
      <label style="display:flex;gap:8px;align-items:center">
        <input type="checkbox" id="deliveryChk"> <span>Envío a domicilio (+2000 XAF)</span>
      </label>
    </div>
    <div id="addressBox" style="display:none">
      <label style="display:block;margin-bottom:10px">Dirección exacta
        <input id="address" placeholder="Ej: Malabo, Semu, casa azul" style="width:100%;padding:10px;border-radius:6px;border:1px solid var(--border)">
      </label>
    </div>
    <div id="totals" style="margin:12px 0;font-weight:900"></div>
    <form id="checkoutForm" style="display:grid;gap:10px">
      <label>Tu nombre (opcional)
        <input id="cname" style="width:100%;padding:10px;border-radius:6px;border:1px solid var(--border)">
      </label>
      <label>Teléfono (WhatsApp)
        <input id="cphone" required style="width:100%;padding:10px;border-radius:6px;border:1px solid var(--border)">
      </label>
      <label>Nota
        <textarea id="cnote" placeholder="Ej: Entrega 18:00" style="width:100%;padding:10px;border-radius:6px;border:1px solid var(--border)"></textarea>
      </label>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
        <button class="btn" type="submit">Confirmar pedido</button>
        <button class="btn ghost" type="button" id="closeCartBtn2" style="border-color:#ddd;color:#111">Cerrar</button>
      </div>
    </form>
  </div>
</div>

<footer class="footer">© WapMarket — UI basada en Admin (único vendedor)</footer>

<script>
/* ========= Conexión backend + carrito (listo para producción) ========= */
const API_BASE = '/api';                 // raíz del backend
const DELIVERY_FEE = 2000;
let selectedBusiness = null;             // negocio activo (se elige automáticamente)
let products = [];                       // productos cargados del negocio
let cart = JSON.parse(localStorage.getItem('cart') || '[]'); // persistencia local

// ===== Helpers fetch con tokens si aplican =====
async function fetchJSON(url, opts = {}){
  const headers = Object.assign({'Content-Type':'application/json'}, opts.headers||{});
  const res = await fetch(url, { ...opts, headers });
  const ct = res.headers.get('content-type') || '';
  const isJSON = ct.includes('application/json');
  const body = isJSON ? await res.json().catch(()=>null) : await res.text();
  if (!res.ok) throw Object.assign(new Error(body && body.error ? body.error : (typeof body === 'string' ? body : res.statusText)), { status: res.status, body });
  return body;
}

// ===== API público =====
const PublicAPI = {
  async businesses(){ return fetchJSON(API_BASE + '/public/businesses', { method:'GET', headers:{} }); },
  async products(params){
    const qs = new URLSearchParams(params||{}).toString();
    return fetchJSON(API_BASE + '/public/products' + (qs ? ('?' + qs) : ''), { method:'GET', headers:{} });
  },
  async checkout(payload){
    return fetchJSON(API_BASE + '/public/cart/checkout', { method:'POST', body: JSON.stringify(payload) });
  }
};

// ===== Carrito =====
function saveCart(){ localStorage.setItem('cart', JSON.stringify(cart)); updateCartBadge(); }
function updateCartBadge(){
  const count = cart.reduce((a,c)=>a+Number(c.qty||1),0);
  document.getElementById('cartCount').textContent = '(' + count + ')';
}
function openCart(){ document.getElementById('cartModal').style.display='flex'; renderCart(); }
function closeCart(){ document.getElementById('cartModal').style.display='none'; }

document.getElementById('btnOpenCart').addEventListener('click', e=>{ e.preventDefault(); openCart(); });
document.getElementById('closeCartBtn').addEventListener('click', closeCart);
document.getElementById('closeCartBtn2').addEventListener('click', closeCart);

// Render carrito
function renderCart(){
  const box = document.getElementById('cartItems');
  const info = document.getElementById('cartInfo');
  if (!cart.length){
    box.innerHTML = '<p class="small">Tu carrito está vacío.</p>';
    info.textContent=''; document.getElementById('totals').textContent=''; return;
  }
  info.textContent = 'Negocio: ' + (selectedBusiness ? selectedBusiness.name : ('#' + (cart[0]?.business_id||'')));
  box.innerHTML = '';
  let subtotal = 0;
  cart.forEach((item, idx)=>{
    const div = document.createElement('div');
    div.style.margin='8px 0';
    div.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <img src="${item.image_url || 'https://placehold.co/80'}" style="width:60px;height:60px;object-fit:cover;border-radius:6px;border:1px solid var(--border)">
        <div style="flex:1">
          <div><strong>${escapeHtml(item.title||'')}</strong></div>
          <div class="small">${(item.price_xaf||0).toLocaleString()} XAF • <span>${escapeHtml(item.category||'')}</span></div>
          <div style="display:flex;gap:6px;align-items:center;margin-top:6px">
            <button class="btn" data-idx="${idx}" data-act="dec" style="padding:6px 10px">-</button>
            <span style="min-width:24px;text-align:center">${item.qty}</span>
            <button class="btn" data-idx="${idx}" data-act="inc" style="padding:6px 10px">+</button>
            <button class="btn ghost" data-idx="${idx}" data-act="del" style="border-color:#ddd;color:#111">Quitar</button>
          </div>
        </div>
      </div>
    `;
    subtotal += (Number(item.price_xaf||0) * Number(item.qty||1));
    box.appendChild(div);
  });
  const delivery = document.getElementById('deliveryChk').checked;
  const total = subtotal + (delivery ? DELIVERY_FEE : 0);
  document.getElementById('totals').textContent =
    'Subtotal: ' + subtotal.toLocaleString() + ' XAF' + (delivery? ' + Envío: 2.000 XAF = Total: ' + total.toLocaleString() + ' XAF' : ' = Total: ' + total.toLocaleString() + ' XAF');

  box.onclick = (e)=>{
    const btn = e.target.closest('button[data-act]'); if(!btn) return;
    const i = Number(btn.dataset.idx); const act = btn.dataset.act;
    if (act==='inc') cart[i].qty = Number(cart[i].qty||1) + 1;
    if (act==='dec') cart[i].qty = Math.max(1, Number(cart[i].qty||1) - 1);
    if (act==='del') cart.splice(i,1);
    saveCart(); renderCart();
  }
}

document.getElementById('deliveryChk').addEventListener('change', (e)=>{
  document.getElementById('addressBox').style.display = e.target.checked ? 'block' : 'none';
  renderCart();
});

// ===== Productos (único contenedor) =====
const results = document.getElementById('results');

function renderProducts(list){
  results.innerHTML = '';
  list.forEach(p=>{
    const el = document.createElement('div');
    el.className = 'product-card';
    el.innerHTML = `
      <img src="${p.image_url || 'https://placehold.co/600x400?text=WapMarket'}" alt="">
      <div class="product-title">${escapeHtml(p.title||'')}</div>
      <div class="product-meta">
        <div class="price">${Number(p.price_xaf||0).toLocaleString()} XAF</div>
        <div class="badge">${escapeHtml(p.category||'')}</div>
      </div>
      <div class="actions">
        <button class="btn" data-id="${p.id}">Añadir</button>
      </div>
    `;
    results.appendChild(el);
  });

  // Delegación: añadir al carrito
  results.onclick = (e)=>{
    const btn = e.target.closest('button[data-id]'); if(!btn) return;
    const p = list.find(x=> String(x.id) === btn.dataset.id);
    if (!p) return;
    if (cart.length && cart[0].business_id !== p.business_id){
      if (!confirm('Tu carrito es de otro negocio. ¿Vaciar y cambiar a ' + (selectedBusiness?.name||'este negocio') + '?')) return;
      cart = [];
    }
    const it = cart.find(x=>x.id===p.id);
    if (it) it.qty = Number(it.qty||1)+1;
    else cart.push({ id:p.id, title:p.title, price_xaf:p.price_xaf, image_url:p.image_url, category:p.category, qty:1, business_id: p.business_id });
    saveCart();
  };
}

// ===== Búsqueda mínima (sin chips ni carruseles) =====
const q = document.getElementById('q');
let typingTimer;
q.addEventListener('input', ()=>{
  clearTimeout(typingTimer);
  typingTimer = setTimeout(()=>{
    const term = q.value.trim().toLowerCase();
    const filtered = term ? products.filter(p => (p.title||'').toLowerCase().includes(term)) : products;
    renderProducts(filtered);
  }, 200);
});

// ===== Flujo =====
async function init(){
  updateCartBadge();
  // Elegir primer negocio y traer sus productos
  try{
    const bizData = await PublicAPI.businesses();
    const items = bizData.items || [];
    if (!items.length){ document.getElementById('results').innerHTML = '<div class="small">No hay negocios disponibles.</div>'; return; }
    selectedBusiness = items[0];
    const prodData = await PublicAPI.products({ business_id: selectedBusiness.id });
    products = (prodData.items || []).filter(p => p.active !== false);
    renderProducts(products);
  }catch(e){
    console.error(e);
    document.getElementById('results').innerHTML = '<div class="small">Error cargando productos: ' + (e.message||e) + '</div>';
  }
}
init();

// ===== Checkout =====
document.getElementById('checkoutForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (!cart.length) return alert('Tu carrito está vacío');
  const items = cart.map(c => ({ product_id: c.id, qty: c.qty }));
  const delivery = document.getElementById('deliveryChk').checked;
  const payload = {
    items,
    customer_name: document.getElementById('cname').value,
    customer_phone: document.getElementById('cphone').value,
    address: delivery ? document.getElementById('address').value : undefined,
    note: document.getElementById('cnote').value,
    delivery
  };
  try{
    const res = await PublicAPI.checkout(payload);
    if (res.error) throw new Error(res.error);
    alert('Pedido confirmado. Código de grupo: ' + res.group_id + '\\nTotal: ' + (res.total_xaf||0).toLocaleString() + ' XAF');
    cart = []; saveCart(); closeCart();
  }catch(err){
    alert('Error en checkout: ' + (err.message||err));
  }
});

// Utils
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
</script>
</body>
</html>
