<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WapMarket · Marketplace</title>
<style>
:root {
  --bg: #EAEDED;
  --card: #FFFFFF;
  --ink: #0F1111;
  --muted: #565959;
  --link: #007185;
  --amz-blue: #232F3E;
  --amz-dark-blue: #131A22;
  --amz-yellow: #FF9900;
  --amz-yellow-dark: #E68A00;
  --border-light: #DDD;
  --ring: 0 1px 3px rgba(0, 0, 0, 0.05);
  --btn-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--ink);display:flex;flex-direction:column;min-height:100vh}
.header{background:var(--amz-dark-blue);color:#fff;padding:12px 18px;position:sticky;top:0;z-index:100}
.header-content{display:flex;align-items:center;gap:12px;flex-wrap:wrap;max-width:1200px;margin:0 auto}
.brand{font-weight:800;font-size:24px;color:#fff}
.brand span{color:var(--amz-yellow)}
.container{max-width:1200px;margin:20px auto;padding:0 16px;flex-grow:1}
.grid{display:grid;grid-template-columns:280px 1fr;gap:20px}
.card{background:var(--card);border-radius:4px;padding:20px;box-shadow:var(--ring);}
.small{font-size:13px;color:var(--muted)}
.btn {
  background: var(--amz-yellow);
  border: 1px solid #FF8F00;
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 500;
  color: var(--ink);
  box-shadow: 0 2px 5px 0 rgba(213,217,217,.5);
  font-size: 13px;
  text-align: center;
}
.btn:hover { background: var(--amz-yellow-dark); }
.btn.ghost{background:transparent;border:1px solid var(--border-light);color:var(--ink);box-shadow:none}
.btn.ghost:hover { background-color: #f3f3f3; }

/* Main */
.topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
.form-row{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
.input, textarea, select{padding:8px;border-radius:6px;border:1px solid var(--border-light);width:100%}

/* Footer */
.footer { background: var(--amz-dark-blue); color: #fff; padding: 40px 18px; margin-top: auto; }
.footer-content { max-width: 1000px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px; }
.footer-col h4 { font-size: 16px; font-weight: 700; margin: 0 0 10px; }
.footer-col ul { list-style: none; padding: 0; margin: 0; }
.footer-col li { margin-bottom: 8px; }
.footer-col a { color: #DDD; font-size: 14px; text-decoration: none; }
.footer-col a:hover { color: #fff; text-decoration: underline; }
.footer-bottom { border-top: 1px solid #3A4553; margin-top: 30px; padding-top: 20px; text-align: center; font-size: 12px; color: #DDD; }

/* Product Grid & Item Styling */
.products-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 20px;
}
.product-item {
  background: var(--card);
  border-radius: 4px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 15px;
  box-shadow: var(--ring);
}
.product-item img {
  width: 100%;
  height: 180px;
  object-fit: cover;
  border-radius: 3px;
}
.product-item .meta {
  display: flex;
  flex-direction: column;
  gap: 10px;
  flex-grow: 1;
}
.product-item .meta h4 {
  margin: 0;
  font-size: 1.1rem;
  font-weight: 600;
  line-height: 1.3;
}
.product-item .price {
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--ink);
}
.product-item .badge {
  font-size: 0.8rem;
  padding: 4px 8px;
  background: #f0f0f0;
  border-radius: 4px;
  color: var(--muted);
  align-self: flex-start;
}
.product-item .actions {
  margin-top: auto; /* Push actions to the bottom */
  display: flex;
  gap: 10px;
}

/* Modal Styling */
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;padding:1rem;z-index:99999;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.modal.right{align-items:stretch;justify-content:flex-end;padding:0}
.modal.right .dialog{height:100%;border-radius:0;border-left:1px solid #e6e6e6;padding:1rem;animation:slideIn 0.25s ease both;width:min(480px,100%)}
.dialog{background:var(--card);width:min(480px,90%);max-width:90%;border-radius:8px;box-shadow:0 18px 50px rgba(17,24,39,0.12);padding:1.5rem;animation:fadeIn 0.25s ease both}
@keyframes fadeIn{from{transform:scale(0.95);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes slideIn{from{transform:translateX(30px);opacity:0}to{transform:translateX(0);opacity:1}}

/* Search Bar */
.search{display:flex;flex:1;max-width:720px;position:relative;gap:0}
.search input{flex:1;padding:10px;border-radius:6px 0 0 6px;border:1px solid var(--border-light);outline:none;height:auto;font-size:15px}
.search #btnBuscar{border-radius:0 6px 6px 0;}
.search .sugg{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #e6e6e6;border-radius:8px;box-shadow:0 6px 18px rgba(17,24,39,0.04);z-index:10;margin-top:4px}
.sugg li{list-style:none;padding:8px;display:flex;gap:8px;align-items:center;cursor:pointer}
.sugg li:hover{background:#f6f7f9}

/* Sidebar */
.sidebar{position:sticky;top:80px;height:calc(100vh - 100px);overflow-y:auto;align-self:flex-start}
.sidebar .card{box-shadow:var(--ring);padding:20px}
.biz-item{padding:12px 14px;cursor:pointer;border-bottom:1px solid #f0f0f0;border-radius:4px}
.biz-item:hover{background:#f3f3f3}
.biz-item:last-child{border-bottom:none}

.main .card{padding:0;box-shadow:none;border:none;background:transparent}

/* Cart Icon */
.cart-btn-icon{position:relative;display:flex;align-items:center;justify-content:center;padding:8px 10px;border-radius:8px;background:var(--amz-yellow);box-shadow:var(--btn-shadow);cursor:pointer;border:1px solid #FF8F00;}
.cart-btn-icon svg{width:24px;height:24px;fill:#fff;stroke:#111;stroke-width:0;}
.cart-btn-icon[data-has-items="true"]::after{content:attr(data-item-count);position:absolute;top:-8px;right:-8px;background:red;color:white;border-radius:50%;padding:2px 6px;font-size:11px;font-weight:bold}

@media(max-width:768px){.grid{display:flex;flex-direction:column;gap:16px}.sidebar{position:static;height:auto;overflow-y:visible;padding-right:0}}
@media(max-width:600px){.header-content{flex-direction:column;align-items:stretch;gap:12px;padding-bottom:12px}.header-content .search{width:100%}}

.pagination{display:flex;justify-content:center;align-items:center;gap:8px;margin-top:20px}
.pagination button{padding:8px 12px;border:1px solid #ddd;border-radius:6px;background-color:#fff;cursor:pointer;font-weight:600}
.pagination button.active{background-color:var(--amz-yellow);color:var(--ink);border-color:var(--amz-yellow)}

/* AI Assistant styles */
.chat-modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:flex-end;justify-content:flex-end;z-index:1000;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.chat-dialog{background:var(--card);border-radius:8px 8px 0 0;width:min(400px,100%);height:500px;display:flex;flex-direction:column;padding:16px;box-shadow:0 -8px 20px rgba(17,24,39,0.1);animation:slideUp 0.3s ease both}
.chat-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #ddd;padding-bottom:10px;margin-bottom:10px}
.chat-messages{flex-grow:1;overflow-y:auto;display:flex;flex-direction:column;gap:12px;padding-right:8px}
.message-bubble{padding:10px;border-radius:18px;max-width:85%}
.message-bubble.user{background:var(--amz-yellow);color:#111;align-self:flex-end;border-bottom-right-radius:4px}
.message-bubble.ai{background:#f0f0f0;color:#111;align-self:flex-start;border-bottom-left-radius:4px}
.chat-input-area{display:flex;gap:8px;margin-top:10px}
.chat-input-area input{flex-grow:1}
.mic-btn{background:transparent;border:none;cursor:pointer;padding:0;display:flex;align-items:center}
.mic-btn svg{width:24px;height:24px;fill:#111;transition:fill 0.2s}
.mic-btn.active svg{fill:red;animation:pulse 1s infinite}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
@keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
</style>
</head>
<body>
<header class="header">
  <div class="header-content" style="gap:24px">
    <div class="brand">Wap<span>Market</span></div>
    <form id="searchForm" class="search" onsubmit="return false;">
      <input id="q" placeholder="Buscar productos..." autocomplete="off" />
      <button class="btn" id="btnBuscar" aria-label="Buscar">Buscar</button>
      <ul id="suggBox" class="sugg" role="listbox" style="display:none"></ul>
    </form>
    <div style="display:flex; gap: 12px; align-items: center;">
      <button class="cart-btn-icon" id="btnOpenChat" aria-label="Abrir asistente de IA" title="Asistente de IA">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather feather-zap"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
      </button>
      <button class="cart-btn-icon" id="btnOpenCart" aria-label="Abrir carrito" title="Carrito" data-has-items="false" data-item-count="0">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"></path></svg>
      </button>
    </div>
  </div>
</header>
<div class="container">
  <div class="grid">
    <aside class="sidebar">
      <div class="card">
        <h3>Negocios</h3>
        <p class="small">Selecciona un negocio para ver sus productos.</p>
        <div id="bizList"></div>
      </div>
    </aside>
    <main class="main">
      <div class="topbar">
        <div style="display:flex;flex-direction:column">
          <strong id="bizTitle" style="font-size: 1.5rem;">Selecciona un negocio</strong>
          <span class="small">Lista de productos disponibles.</span>
        </div>
      </div>
      <div class="card">
        <div id="results" class="products-grid"></div>
        <div id="pagination" class="pagination" style="display:none"></div>
      </div>
    </main>
  </div>
</div>

<footer class="footer">
  <div class="footer-content">
    <div class="footer-col">
      <h4>Conócenos</h4>
      <ul>
        <li><a href="#">Trabajar en WapMarket</a></li>
        <li><a href="#">Información corporativa</a></li>
        <li><a href="#">Departamento de prensa</a></li>
      </ul>
    </div>
    <div class="footer-col">
      <h4>Gana dinero con nosotros</h4>
      <ul>
        <li><a href="#">Vender en WapMarket</a></li>
        <li><a href="#">Programa de afiliados</a></li>
        <li><a href="#">Anuncia tus productos</a></li>
      </ul>
    </div>
    <div class="footer-col">
      <h4>Productos de pago</h4>
      <ul>
        <li><a href="#">Compra con puntos</a></li>
        <li><a href="#">Recarga tu saldo</a></li>
        <li><a href="#">Tarjetas regalo</a></li>
      </ul>
    </div>
    <div class="footer-col">
      <h4>Podemos ayudarte</h4>
      <ul>
        <li><a href="#">Devoluciones y reemplazos</a></li>
        <li><a href="#">Gestionar compras</a></li>
        <li><a href="#">Ayuda</a></li>
      </ul>
    </div>
  </div>
  <div class="footer-bottom">
    <span>© 2025, WapMarket.com, Inc. o afiliados.</span>
  </div>
</footer>

<div id="customModal" class="modal">
  <div class="dialog">
    <p id="modalMessage"></p>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:1rem">
      <button class="btn" id="modalConfirmBtn" style="display:none">OK</button>
      <button class="btn ghost" id="modalCancelBtn">Cerrar</button>
    </div>
  </div>
</div>

<div class="modal right" id="cartModal">
  <div class="dialog">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h3 style="margin:6px 0">Tu carrito</h3>
      <button class="btn ghost" type="button" onclick="closeCart()">✕</button>
    </div>
    <div id="cartInfo" class="small" style="margin-bottom:8px"></div>
    <div id="cartItems"></div>
    <div style="margin:12px 0">
      <label style="display:flex;gap:8px;align-items:center">
        <input type="checkbox" id="deliveryChk"> <span>Envío a domicilio (+2000 XAF)</span>
      </label>
    </div>
    <div id="addressBox" style="display:none">
      <label style="display:block;margin-bottom:10px">Dirección exacta
        <input id="address" placeholder="Ej: Malabo, Semu, casa azul" class="input">
      </label>
    </div>
    <div id="totals" style="margin:12px 0;font-weight:900"></div>
    <form id="checkoutForm" style="display:grid;gap:10px">
      <label>Tu nombre (opcional)
        <input id="cname" class="input">
      </label>
      <label>Teléfono (WhatsApp) <input id="cphone" required class="input"></label>
      <label>Nota <textarea id="cnote" placeholder="Ej: Entrega 18:00" class="input"></textarea></label>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
        <button class="btn" type="submit">Confirmar pedido</button>
        <button class="btn ghost" type="button" onclick="closeCart()">Cerrar</button>
      </div>
    </form>
  </div>
</div>

<div id="chatModal" class="chat-modal">
  <div class="chat-dialog">
    <div class="chat-header">
      <strong style="margin:0">Asistente de WapMarket</strong>
      <button class="btn ghost" type="button" onclick="closeChat()">✕</button>
    </div>
    <div id="chatMessages" class="chat-messages">
      <div class="message-bubble ai">Hola, soy tu asistente de compras. ¿Cómo puedo ayudarte hoy?</div>
    </div>
    <div class="chat-input-area">
      <input type="text" id="chatInput" placeholder="Escribe tu mensaje..." class="input">
      <button class="mic-btn" id="micBtn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="18" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
      </button>
      <button class="btn" id="sendChatBtn">Enviar</button>
    </div>
  </div>
</div>

<script src="/api.js"></script>
<script>
// Custom modal functions
function showModal(message, isConfirm = false, onConfirm = null) {
  const modal = document.getElementById('customModal');
  const msgEl = document.getElementById('modalMessage');
  const confirmBtn = document.getElementById('modalConfirmBtn');
  const cancelBtn = document.getElementById('modalCancelBtn');
  msgEl.textContent = message;
  modal.style.display = 'flex';
  confirmBtn.onclick = null;
  cancelBtn.onclick = null;
  return new Promise(resolve => {
    if (isConfirm) {
      confirmBtn.style.display = 'inline-block';
      confirmBtn.onclick = () => { modal.style.display = 'none'; resolve(true); if (onConfirm) onConfirm(); };
      cancelBtn.onclick = () => { modal.style.display = 'none'; resolve(false); };
    } else {
      confirmBtn.style.display = 'none';
      cancelBtn.onclick = () => { modal.style.display = 'none'; resolve(true); };
    }
  });
}

const DELIVERY_FEE = 2000;
let selectedBusiness = null;
let cart = JSON.parse(localStorage.getItem('cart') || '[]');
let currentProducts = [];
let pageSize = 20;
let currentPage = 1;
const qInput = document.getElementById('q');
const suggBox = document.getElementById('suggBox');

function saveCart(){ localStorage.setItem('cart', JSON.stringify(cart)); updateCartCount(); }
function updateCartCount(){
  const count = cart.reduce((a,c)=>a+Number(c.qty||1),0);
  const btn = document.getElementById('btnOpenCart');
  btn.setAttribute('data-has-items', count > 0 ? 'true' : 'false');
  btn.setAttribute('data-item-count', count);
}
function closeCart(){ document.getElementById('cartModal').style.display='none'; }
function openCart(){ document.getElementById('cartModal').style.display='flex'; renderCart(); }
document.getElementById('btnOpenCart').addEventListener('click', (e)=>{ e.preventDefault(); openCart(); });

async function setBusiness(b){
  selectedBusiness = b;
  document.getElementById('bizTitle').innerHTML = b.name + (b.business_type==='verified' ? '<span class="small" style="margin-left:8px;color:var(--amz-yellow)">✔ Verificado</span>' : '');
  if (cart.length && cart[0].business_id !== b.id){
    const confirmed = await showModal('Tu carrito pertenece a otro negocio. ¿Vaciar carrito para continuar con ' + b.name + '?', true);
    if(confirmed) { cart = []; saveCart(); }
  }
  currentPage = 1;
  loadProducts();
}

async function loadBusinesses(){
  const data = await API.get('/public/businesses');
  const box = document.getElementById('bizList');
  box.innerHTML = '';
  (data.items||[]).forEach(b=>{
    const el = document.createElement('div');
    el.className = 'biz-item';
    el.innerHTML = `<strong style="font-size:1.02rem">${b.name}</strong>${b.business_type==='verified' ? '<span class="small" style="margin-left:4px;color:var(--amz-yellow)">✔</span>' : ''}<div class="small">${b.location||''}</div>`;
    el.addEventListener('click', ()=> setBusiness(b));
    box.appendChild(el);
  });
  if (!selectedBusiness && (data.items||[]).length) setBusiness(data.items[0]);
}

function renderProductsPage(){
  const list = document.getElementById('results');
  const pagination = document.getElementById('pagination');
  list.innerHTML = '';
  pagination.innerHTML = '';
  const start = (currentPage-1)*pageSize;
  const pageItems = currentProducts.slice(start, start+pageSize);
  if (pageItems.length === 0) {
    list.innerHTML = '<p class="small" style="padding:0 14px">No hay productos disponibles para este negocio.</p>';
    pagination.style.display = 'none';
    return;
  }
  pageItems.forEach(p=>{
    const el = document.createElement('div');
    el.className = 'product-item';
    el.innerHTML = `
      <img class="thumb" src="${p.image_url || 'https://placehold.co/300x200?text=WapMarket'}" alt="${p.title}">
      <div class="meta">
        <span class="badge">${p.category || 'General'}</span>
        <h4>${p.title}</h4>
        <span class="price">${p.price_xaf ? Number(p.price_xaf).toLocaleString() + ' XAF' : 'Consultar'}</span>
      </div>
      <div class="actions">
        <button class="btn" data-id="${p.id}" data-action="add" style="width:100%">Añadir al carrito</button>
      </div>
    `;
    list.appendChild(el);
  });

  const totalPages = Math.ceil(currentProducts.length / pageSize);
  if (totalPages > 1) {
    pagination.style.display = 'flex';
    if (currentPage > 1) {
      const prevBtn = document.createElement('button');
      prevBtn.textContent = '«';
      prevBtn.onclick = () => { currentPage--; renderProductsPage(); window.scrollTo({top:0,behavior:'smooth'}); };
      pagination.appendChild(prevBtn);
    }
    for (let i = 1; i <= totalPages; i++) {
      const pageBtn = document.createElement('button');
      pageBtn.textContent = i;
      pageBtn.className = i === currentPage ? 'active' : '';
      pageBtn.onclick = () => { currentPage = i; renderProductsPage(); window.scrollTo({top:0,behavior:'smooth'}); };
      pagination.appendChild(pageBtn);
    }
    if (currentPage < totalPages) {
      const nextBtn = document.createElement('button');
      nextBtn.textContent = '»';
      nextBtn.onclick = () => { currentPage++; renderProductsPage(); window.scrollTo({top:0,behavior:'smooth'}); };
      pagination.appendChild(nextBtn);
    }
  } else {
    pagination.style.display = 'none';
  }

  list.onclick = async (e)=>{
    const btn = e.target.closest('button[data-id]');
    if(!btn) return;
    const id = btn.dataset.id;
    const action = btn.dataset.action;
    const p = currentProducts.find(x=>x.id == id);
    if (!p) return;
    
    if (action === 'add') {
      if (cart.length && cart[0].business_id !== p.business_id){
        const confirmed = await showModal('Tu carrito es de otro negocio. ¿Vaciar y cambiar a ' + (selectedBusiness?.name||'este negocio') + '?', true);
        if(!confirmed) return;
        cart = [];
      }
      const exists = cart.find(x=>x.id===p.id);
      if (exists) exists.qty = Number(exists.qty||1)+1;
      else cart.push({ id:p.id, title:p.title, price_xaf:p.price_xaf, image_url:p.image_url, category:p.category, qty:1, business_id: p.business_id });
      saveCart();
      btn.textContent = 'Añadido!';
      btn.style.background = '#28a745';
      setTimeout(()=>{ btn.textContent = 'Añadir al carrito'; btn.style.background = ''; }, 1000);
    }
  };
}

async function loadProducts(){
  if (!selectedBusiness) return;
  const q = document.getElementById('q').value.trim();
  const params = new URLSearchParams();
  params.set('business_id', selectedBusiness.id);
  if (q) params.set('q', q);
  const data = await API.get('/public/products?' + params.toString());
  currentProducts = data.items || [];
  currentPage = 1;
  renderProductsPage();
  renderSuggestions();
}

function renderCart(){
  const box = document.getElementById('cartItems');
  const info = document.getElementById('cartInfo');
  if (!cart.length){
    box.innerHTML = '<p class="small">Tu carrito está vacío.</p>';
    info.textContent=''; document.getElementById('totals').textContent=''; return;
  }
  info.textContent = 'Negocio: ' + (selectedBusiness && cart[0].business_id===selectedBusiness.id ? selectedBusiness.name : ('#' + cart[0].business_id));
  box.innerHTML = '';
  let subtotal = 0;
  cart.forEach((item, idx)=>{
    const div = document.createElement('div');
    div.style.margin='8px 0';
    div.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><img src="${item.image_url || 'https://placehold.co/80'}" style="width:60px;height:60px;object-fit:cover;border-radius:6px;border:1px solid #e6e6e6"><div style="flex:1"><div><strong>${item.title}</strong></div><div class="small">${(item.price_xaf||0).toLocaleString()} XAF • <span>${item.category||''}</span></div><div style="display:flex;gap:6px;align-items:center;margin-top:6px"><button class="btn ghost" data-idx="${idx}" data-act="dec">-</button><span style="min-width:24px;text-align:center">${item.qty}</span><button class="btn" data-idx="${idx}" data-act="inc">+</button><button class="btn ghost" data-idx="${idx}" data-act="del">Quitar</button></div></div></div>`;
    subtotal += (Number(item.price_xaf||0) * Number(item.qty||1));
    box.appendChild(div);
  });
  const delivery = document.getElementById('deliveryChk').checked;
  const total = subtotal + (delivery ? DELIVERY_FEE : 0);
  document.getElementById('totals').textContent = `Subtotal: ${subtotal.toLocaleString()} XAF` + (delivery ? ` + Envío: 2.000 XAF = Total: ${total.toLocaleString()} XAF` : ` = Total: ${total.toLocaleString()} XAF`);
  box.onclick = (e)=>{
    const btn = e.target.closest('button.btn,button.btn.ghost'); if(!btn) return;
    const i = Number(btn.dataset.idx); const act = btn.dataset.act;
    if (act==='inc') cart[i].qty = Number(cart[i].qty||1) + 1;
    if (act==='dec') cart[i].qty = Math.max(1, Number(cart[i].qty||1) - 1);
    if (act==='del') cart.splice(i,1);
    saveCart(); renderCart();
  }
}

document.getElementById('deliveryChk').addEventListener('change', (e)=>{ document.getElementById('addressBox').style.display = e.target.checked ? 'block' : 'none'; renderCart(); });
document.getElementById('btnBuscar').addEventListener('click', ()=>{ if (selectedBusiness) loadProducts(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='/'){ e.preventDefault(); qInput.focus(); } });

let typingTimer;
qInput.addEventListener('input', ()=>{ clearTimeout(typingTimer); typingTimer = setTimeout(()=>{ if(selectedBusiness) loadProducts(); }, 250); renderSuggestions(); });
qInput.addEventListener('focus', ()=>renderSuggestions());
document.addEventListener('click', e=>{ if(!e.target.closest('.search')) suggBox.style.display='none'; });

function renderSuggestions(){
  const term = qInput.value.trim().toLowerCase();
  if(!term || !currentProducts.length){ suggBox.style.display='none'; return; }
  const matches = currentProducts.filter(p => (p.title||'').toLowerCase().includes(term)).slice(0,8);
  if(!matches.length){ suggBox.style.display='none'; return; }
  suggBox.innerHTML = matches.map(m=>`<li role="option" data-id="${m.id}"><img src="${m.image_url || 'https://placehold.co/80'}" style="width:40px;height:40px;object-fit:cover;border-radius:6px;border:1px solid #e6e6e6" alt=""><div style="display:flex;flex-direction:column"><strong style="line-height:1.1">${m.title}</strong><span class="small">${m.category||''} ${m.price_xaf? '• '+Number(m.price_xaf).toLocaleString()+' XAF':''}</span></div></li>`).join('');
  suggBox.style.display='block';
  suggBox.querySelectorAll('li').forEach(li=>{
    li.onclick=()=>{
      const id = li.dataset.id;
      const p = currentProducts.find(x=>''+x.id === ''+id);
      if (p){
        qInput.value = p.title;
        suggBox.style.display='none';
        const idx = currentProducts.findIndex(x=>x.id===p.id);
        currentPage = Math.floor(idx / pageSize) + 1;
        renderProductsPage();
        const itemEl = [...document.querySelectorAll('.product-item')][idx % pageSize];
        if (itemEl) itemEl.scrollIntoView({behavior:'smooth', block:'center'});
      }
    };
  });
}

function init(){ updateCartCount(); loadBusinesses(); }
init();

document.getElementById('checkoutForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (!cart.length) { showModal('Tu carrito está vacío'); return; }
  const items = cart.map(c => ({ product_id: c.id, qty: c.qty }));
  const delivery = document.getElementById('deliveryChk').checked;
  const payload = { items, customer_name: document.getElementById('cname').value, customer_phone: document.getElementById('cphone').value, address: delivery ? document.getElementById('address').value : undefined, note: document.getElementById('cnote').value, delivery };
  const res = await API.post('/public/cart/checkout', payload);
  if (res.error){ showModal(res.error); return; }
  showModal('Pedido confirmado. Código de grupo: ' + res.group_id + '\nTotal: ' + (res.total_xaf||0).toLocaleString() + ' XAF');
  cart = []; saveCart(); closeCart();
});

// AI Assistant Logic
const chatModal = document.getElementById('chatModal');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const micBtn = document.getElementById('micBtn');
const sendChatBtn = document.getElementById('sendChatBtn');

function openChat() { chatModal.style.display = 'flex'; }
function closeChat() { chatModal.style.display = 'none'; }
document.getElementById('btnOpenChat').addEventListener('click', openChat);

function addMessage(text, sender) {
    const msgDiv = document.createElement('div');
    msgDiv.className = `message-bubble ${sender}`;
    msgDiv.textContent = text;
    chatMessages.appendChild(msgDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function sendToAI(query) {
    addMessage(query, 'user');
    chatInput.value = '';
    try {
        const response = await fetch('./api/gemini-proxy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query: query })
        });
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Error de la API de Gemini');
        }
        const data = await response.json();
        addMessage(data.text, 'ai');
    } catch (error) {
        console.error('Error al comunicarse con la API:', error);
        addMessage("Lo siento, hubo un error con el asistente. Inténtalo de nuevo.", 'ai');
    }
}

sendChatBtn.addEventListener('click', () => { const text = chatInput.value.trim(); if (text) sendToAI(text); });
chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { const text = chatInput.value.trim(); if (text) sendToAI(text); } });

let recognition = null;
if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = 'es-ES';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    recognition.onstart = () => { micBtn.classList.add('active'); chatInput.placeholder = 'Hablando...'; chatInput.value = ''; };
    recognition.onresult = (event) => { const transcript = event.results[0][0].transcript; chatInput.value = transcript; sendToAI(transcript); };
    recognition.onerror = (event) => { console.error('Error de reconocimiento de voz:', event.error); micBtn.classList.remove('active'); chatInput.placeholder = 'Escribe tu mensaje...'; };
    recognition.onend = () => { micBtn.classList.remove('active'); chatInput.placeholder = 'Escribe tu mensaje...'; };
    micBtn.addEventListener('click', () => { if (micBtn.classList.contains('active')) { recognition.stop(); } else { recognition.start(); } });
} else { micBtn.style.display = 'none'; }
</script>
</body>
</html>
