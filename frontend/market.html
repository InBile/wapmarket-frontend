<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WapMarket — Marketplace GE</title>
  <!-- Tailwind + Swiper -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; background:#f9fafb; }
    .logo-text { font-family: 'Arial Black', Gadget, sans-serif; }
    .verified-badge img{width:20px;height:20px;object-fit:contain;}
    .toast{position:fixed;left:50%;top:24px;transform:translateX(-50%) translateY(-20px);opacity:0;background:#111827;color:#fff;padding:12px 16px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.2);z-index:50;transition:transform .25s ease,opacity .25s ease}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    #confetti{position:fixed;inset:0;pointer-events:none;z-index:60}
    .confetti-piece{position:absolute;width:8px;height:14px;opacity:0;animation:fall 1200ms linear forwards}
    @keyframes fall{0%{transform:translateY(-20px) rotate(0);opacity:1}100%{transform:translateY(100vh) rotate(540deg);opacity:0}}
  </style>
</head>
<body class="flex flex-col min-h-screen">

<!-- TopBar premium -->
<header class="sticky top-0 z-30 bg-gradient-to-r from-orange-500 via-orange-300 to-white shadow-lg">
  <div class="max-w-7xl mx-auto flex items-center justify-between gap-4 px-4 py-3">
    <div class="logo-text text-black text-2xl tracking-wide">WapMarket</div>
    <form id="searchForm" class="flex flex-1 max-w-lg items-center gap-2" onsubmit="return false;">
      <div class="flex items-center flex-1 bg-white/70 rounded-full px-3 py-2 focus-within:ring-2 focus-within:ring-orange-400">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-gray-700"><path d="M21 21l-3.5-3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/></svg>
        <input id="q" placeholder="Buscar productos..." class="bg-transparent border-none focus:outline-none flex-1 text-black placeholder-gray-500 ml-2"/>
      </div>
      <button id="btnBuscar" class="bg-orange-500 hover:bg-orange-600 text-white font-bold px-4 py-2 rounded-full shadow">Buscar</button>
    </form>
    <a href="#" id="btnOpenCart" class="relative bg-white/80 p-2 rounded-full hover:bg-white transition" data-has-items="false">
      <img src="/aset/icons8-buy-64.png" class="w-6 h-6" alt="Carrito">
      <span id="cartDot" class="hidden absolute top-1 right-1 w-3 h-3 bg-red-500 rounded-full"></span>
    </a>
  </div>
</header>

<main class="flex-1 flex max-w-7xl mx-auto w-full">
  <!-- Aside menú -->
  <aside class="w-64 shrink-0 border-r border-gray-200 bg-white flex flex-col">
    <div class="px-4 py-3 border-b">
      <h3 class="font-bold text-gray-700">Negocios</h3>
    </div>
    <nav id="bizList" class="flex-1 overflow-y-auto divide-y divide-gray-100"></nav>
    <div class="px-4 py-3 border-t">
      <h3 class="font-bold text-gray-700 mb-2">Categorías</h3>
      <select id="category" class="w-full border rounded-lg px-2 py-1">
        <option value="">Todas</option>
        <option>Servicios</option><option>Comida</option><option>Tiendas</option><option>Salud</option><option>Transporte</option><option>Tecnología</option>
      </select>
    </div>
  </aside>

  <!-- Contenido -->
  <section class="flex-1 overflow-y-auto p-6 space-y-6">
    <div class="bg-white shadow rounded-xl p-4">
      <h3 id="bizTitle" class="font-bold text-lg mb-4">Selecciona un negocio</h3>
      <div id="results" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
      <div class="flex justify-center mt-4">
        <button id="nextBtn" class="hidden bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-full">Más productos</button>
      </div>
    </div>

    <!-- Publicidad -->
    <div class="bg-white shadow rounded-xl p-4">
      <h3 class="font-bold mb-3">Publicidad</h3>
      <div class="swiper mySwiper rounded-xl">
        <div class="swiper-wrapper">
          <div class="swiper-slide flex flex-col items-center">
            <a href="https://wa.me/240555218661" target="_blank"><img src="/aset/Captura de pantalla 2025-07-07 a la(s) 19.02.16.png" class="w-full h-56 object-cover rounded-xl"/></a>
            <p class="mt-2 text-center font-semibold text-orange-600">Wap Tech & Services</p>
          </div>
          <div class="swiper-slide flex flex-col items-center">
            <a href="https://wa.me/240555218661" target="_blank"><img src="/aset/app-check-hero_2x.png" class="w-full h-56 object-cover rounded-xl"/></a>
            <p class="mt-2 text-center font-semibold text-orange-600">CiberSeguridad Prisma</p>
          </div>
        </div>
        <div class="swiper-pagination"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-button-next"></div>
      </div>
    </div>
  </section>
</main>

<!-- Modal carrito -->
<div class="hidden fixed inset-0 bg-black/50 items-center justify-center p-4" id="cartModal">
  <div class="bg-white rounded-xl shadow-lg max-w-lg w-full max-h-[80vh] overflow-auto p-6">
    <h3 class="font-bold mb-3">Tu carrito</h3>
    <div id="cartInfo" class="text-sm mb-2 text-gray-500"></div>
    <div id="cartItems"></div>
    <label class="flex items-center gap-2 mt-4"><input type="checkbox" id="deliveryChk"> Envío a domicilio (+2000 XAF)</label>
    <div id="addressBox" class="hidden mt-2">
      <label class="block text-sm mb-1">Dirección exacta
        <input id="address" placeholder="Ej: Malabo, Semu, casa azul" class="w-full border rounded-lg px-2 py-1">
      </label>
    </div>
    <div id="totals" class="font-bold mt-3"></div>
    <form id="checkoutForm" class="space-y-2 mt-4">
      <label class="block">Tu nombre (opcional)<input id="cname" class="w-full border rounded-lg px-2 py-1"></label>
      <label class="block">Teléfono (WhatsApp) <input id="cphone" required class="w-full border rounded-lg px-2 py-1"></label>
      <label class="block">Nota <textarea id="cnote" placeholder="Ej: Entrega 18:00" class="w-full border rounded-lg px-2 py-1"></textarea></label>
      <div class="flex gap-2 justify-end pt-2">
        <button class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-full" type="submit">Confirmar pedido</button>
        <button class="bg-gray-200 px-4 py-2 rounded-full" type="button" onclick="closeCart()">Cerrar</button>
      </div>
    </form>
  </div>
</div>

<div class="toast" id="toast"></div>
<div id="confetti"></div>

<footer class="bg-white border-t py-4 text-center text-sm space-x-4">
  <a href="#">Comprar billetes</a>
  <a href="#">Reservar hotel</a>
  <a href="#">Empleos</a>
  <a href="#">Conoce Wap Technology</a>
</footer>

<script src="/api.js"></script>
<script>
const DELIVERY_FEE=2000;
let selectedBusiness=null;
let cart=JSON.parse(localStorage.getItem('cart')||'[]');
let currentProducts=[];
let pageSize=20;
let currentPage=1;

function saveCart(){localStorage.setItem('cart',JSON.stringify(cart));updateCartCount();}
function updateCartCount(){const count=cart.reduce((a,c)=>a+Number(c.qty||1),0);document.getElementById('cartDot').classList.toggle('hidden',!(count>0));}
function closeCart(){document.getElementById('cartModal').classList.add('hidden');}
function openCart(){document.getElementById('cartModal').classList.remove('hidden');renderCart();}
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2400);}
function burstConfetti(){const box=document.getElementById('confetti');const colors=['#f97316','#0ea5e9','#22c55e','#e11d48','#8b5cf6'];for(let i=0;i<60;i++){const s=document.createElement('span');s.className='confetti-piece';s.style.left=Math.random()*100+'%';s.style.top='-10px';s.style.background=colors[Math.floor(Math.random()*colors.length)];s.style.animationDelay=(Math.random()*300)+'ms';s.style.transform=`translateY(-20px) rotate(${Math.random()*180}deg)`;box.appendChild(s);setTimeout(()=>s.remove(),1600);}}

document.getElementById('btnOpenCart').addEventListener('click',e=>{e.preventDefault();openCart();});
document.getElementById('btnBuscar').addEventListener('click',()=>{if(selectedBusiness)loadProducts();});
document.getElementById('category').addEventListener('change',()=>{if(selectedBusiness)loadProducts();});

function setBusiness(b){
  selectedBusiness=b;
  document.getElementById('bizTitle').innerHTML='Productos de '+b.name+(b.business_type==='verified'?' <span class=\"verified-badge\"><img src=\"/aset/icons8-verified-50.png\" alt=\"Verificado\"></span>':'');
  if(cart.length&&cart[0].business_id!==b.id){if(confirm('Tu carrito pertenece a otro negocio. ¿Vaciar carrito para continuar con '+b.name+'?')){cart=[];saveCart();}}
  currentPage=1;loadProducts();
}

async function loadBusinesses(){
  const data=await API.get('/public/businesses');
  const box=document.getElementById('bizList');
  box.innerHTML='';
  (data.items||[]).forEach(b=>{
    const el=document.createElement('div');
    el.className='px-4 py-3 hover:bg-orange-50 cursor-pointer flex justify-between items-center';
    el.innerHTML=`<span>${b.name}${b.business_type==='verified'?' <span class=\"verified-badge\"><img src=\"/aset/icons8-verified-50.png\" alt=\"Verificado\"></span>':''}</span>`;
    el.addEventListener('click',()=>setBusiness(b));
    box.appendChild(el);
  });
  if(!selectedBusiness&&(data.items||[]).length)setBusiness(data.items[0]);
}

function renderProductsPage(){
  const list=document.getElementById('results');
  list.innerHTML='';
  const start=(currentPage-1)*pageSize;
  const pageItems=currentProducts.slice(start,start+pageSize);
  pageItems.forEach(p=>{
    const el=document.createElement('div');
    el.className='bg-white border rounded-xl shadow hover:shadow-lg transition overflow-hidden';
    el.innerHTML=`<img class=\"w-full h-40 object-cover\" src=\"${p.image_url||'https://placehold.co/600x400?text=WapMarket'}\" alt=\"${p.title||''}\"><div class=\"p-3\"><div class=\"text-xs text-gray-500 mb-1\">${p.category||''}</div><h4 class=\"font-semibold\">${p.title}</h4><div class=\"font-bold text-orange-600\">${p.price_xaf?(Number(p.price_xaf).toLocaleString()+' XAF'):''}</div><button class=\"mt-2 bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded-full\" data-id=\"${p.id}\">Añadir</button></div>`;
    list.appendChild(el);
  });
  const nextBtn=document.getElementById('nextBtn');
  nextBtn.style.display=(currentProducts.length>start+pageSize)?'inline-block':'none';
  list.onclick=e=>{const btn=e.target.closest('button[data-id]');if(!btn)return;const id=btn.dataset.id;const p=currentProducts.find(x=>x.id==id);if(!p)return;if(cart.length&&cart[0].business_id!==p.business_id){if(!confirm('Tu carrito es de otro negocio. ¿Vaciar y cambiar a '+(selectedBusiness?.name||'este negocio')+'?'))return;cart=[];}const exists=cart.find(x=>x.id===p.id);if(exists)exists.qty=Number(exists.qty||1)+1;else cart.push({id:p.id,title:p.title,price_xaf:p.price_xaf,image_url:p.image_url,category:p.category,qty:1,business_id:p.business_id});saveCart();toast('Añadido al carrito');};
}

async function loadProducts(){
  if(!selectedBusiness)return;
  const q=document.getElementById('q').value.trim();
  const cat=document.getElementById('category').value;
  const params=new URLSearchParams();
  params.set('business_id',selectedBusiness.id);
  if(q)params.set('q',q);
  if(cat)params.set('category',cat);
  const data=await API.get('/public/products?'+params.toString());
  currentProducts=data.items||[];
  currentPage=1;
  renderProductsPage();
}

function renderCart(){
  const box=document.getElementById('cartItems');
  const info=document.getElementById('cartInfo');
  if(!cart.length){box.innerHTML='<p>Tu carrito está vacío.</p>';info.textContent='';document.getElementById('totals').textContent='';return;}
  info.textContent='Negocio: '+(selectedBusiness&&cart[0].business_id===selectedBusiness.id?selectedBusiness.name:('#'+cart[0].business_id));
  box.innerHTML='';let subtotal=0;
  cart.forEach((item,idx)=>{const div=document.createElement('div');div.className='flex gap-3 items-center my-2';div.innerHTML=`<img src=\"${item.image_url||'https://placehold.co/80'}\" class=\"w-14 h-14 object-cover rounded\"><div class=\"flex-1\"><div class=\"font-semibold\">${item.title}</div><div class=\"text-xs text-gray-500\">${(item.price_xaf||0).toLocaleString()} XAF • ${item.category||''}</div><div class=\"flex gap-2 items-center mt-1\"><button class=\"px-2 bg-gray-200 rounded\" data-idx=\"${idx}\" data-act=\"dec\">-</button><span>${item.qty}</span><button class=\"px-2 bg-gray-200 rounded\" data-idx=\"${idx}\" data-act=\"inc\">+</button><button class=\"px-2 bg-red-500 text-white rounded\" data-idx=\"${idx}\" data-act=\"del\">Quitar</button></div></div>`;subtotal+=(Number(item.price_xaf||0)*Number(item.qty||1));box.appendChild(div);});const delivery=document.getElementById('deliveryChk').checked;const total=subtotal+(delivery?DELIVERY_FEE:0);document.getElementById('totals').textContent='Total: '+total.toLocaleString()+' XAF'+(delivery?' (incluye envío)':'');box.onclick=e=>{const btn=e.target.closest('button');if(!btn)return;const i=Number(btn.dataset.idx);const act=btn.dataset.act;if(act==='inc')cart[i].qty=Number(cart[i].qty||1)+1;if(act==='dec')cart[i].qty=Math.max(1,Number(cart[i].qty||1)-1);if(act==='del')cart.splice(i,1);saveCart();renderCart();};}

document.getElementById('deliveryChk').addEventListener('change',e=>{document.getElementById('addressBox').classList.toggle('hidden',!e.target.checked);renderCart();});
document.getElementById('checkoutForm').addEventListener('submit',async e=>{e.preventDefault();if(!cart.length){alert('Tu carrito está vacío');return;}const items=cart.map(c=>({product_id:c.id,qty:c.qty}));const delivery=document.getElementById('deliveryChk').checked;const payload={items,customer_name:document.getElementById('cname').value,customer_phone:document.getElementById('cphone').value,address:delivery?document.getElementById('address').value:undefined,note:document.getElementById('cnote').value,delivery};const res=await API.post('/public/cart/checkout',payload);if(res.error){alert(res.error);return;}burstConfetti();toast('✅ Pedido confirmado');setTimeout(()=>toast('Código: '+res.group_id+' — Total: '+(res.total_xaf||0).toLocaleString()+' XAF'),900);cart=[];saveCart();closeCart();});

document.getElementById('nextBtn').addEventListener('click',()=>{const maxPages=Math.ceil(currentProducts.length/pageSize);if(currentPage<maxPages){currentPage++;renderProductsPage();window.scrollTo({top:0,behavior:'smooth'});}});

// Swiper publicidad
const swiper=new Swiper(\".mySwiper\",{loop:true,autoplay:{delay:4000},pagination:{el:\".swiper-pagination\",clickable:true},navigation:{nextEl:\".swiper-button-next\",prevEl:\".swiper-button-prev\"}});

updateCartCount();
loadBusinesses();
</script>
</body>
</html>
