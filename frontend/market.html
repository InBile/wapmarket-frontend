<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WapMarket · Marketplace</title>
<style>
:root{
  --amz-dark:#131921;
  --amz-yellow:#FF9900;
  --bg:#f6f7f9;
  --card:#fff;
  --muted:#6b7280;
  --btn-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#111;display:flex;flex-direction:column;min-height:100vh}
.header{background:var(--amz-dark);color:#fff;padding:12px 18px;position:sticky;top:0;z-index:100}
.header-content{display:flex;align-items:center;gap:12px;flex-wrap:wrap;max-width:1100px;margin:0 auto}
.brand{font-weight:800;font-size:18px}
.container{max-width:1100px;margin:20px auto;padding:0 16px;flex-grow:1}
.category-filter{display:flex;gap:10px;overflow-x:auto;padding-bottom:10px;scroll-snap-type:x mandatory;}
.category-btn{
  flex:0 0 auto;
  padding:8px 16px;
  background:#f0f0f0;
  border-radius:20px;
  cursor:pointer;
  font-size:14px;
  white-space:nowrap;
  transition:background-color 0.2s, color 0.2s;
}
.category-btn:hover{background:#ddd}
.category-btn.active{background:var(--amz-yellow);color:#fff;font-weight:600;}
.businesses-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;margin-top:20px}
.business-card{background:var(--card);border-radius:8px;box-shadow:var(--btn-shadow);overflow:hidden;transition:transform 0.2s}
.business-card:hover{transform:translateY(-5px)}
.business-card img{width:100%;height:150px;object-fit:cover;display:block}
.business-content{padding:15px}
.business-content h3{margin-top:0;margin-bottom:5px;font-size:1.2rem}
.business-content p{margin:0;font-size:14px;color:var(--muted)}
.business-content .btn{display:block;margin-top:10px;text-align:center}
.products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:20px;margin-top:20px}
.product-card{background:var(--card);border-radius:8px;box-shadow:var(--btn-shadow);overflow:hidden;display:flex;flex-direction:column}
.product-card img{width:100%;height:150px;object-fit:cover;display:block}
.product-info{padding:15px;flex-grow:1}
.product-info h4{margin:0 0 5px;font-size:16px;color:#333;font-weight:600}
.product-info p{margin:0;font-size:14px;color:var(--amz-dark);font-weight:bold}
.product-card .add-to-cart{
  background:var(--amz-yellow);color:#111;
  border:none;width:100%;padding:10px;
  cursor:pointer;font-weight:bold;
  transition:background 0.2s;
  border-radius:0 0 8px 8px;
}
.product-card .add-to-cart:hover{background:#ffa020}

.cart-btn{background:var(--amz-yellow);color:var(--amz-dark);border:none;padding:8px 12px;border-radius:4px;cursor:pointer;font-weight:bold}
.cart-btn .count{background:red;color:#fff;font-size:12px;padding:2px 6px;border-radius:50%;margin-left:5px}

.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;justify-content:center;align-items:center;z-index:1000;opacity:0;visibility:hidden;transition:opacity 0.3s ease;}
.modal-overlay.active{opacity:1;visibility:visible;}
.modal-content{background:var(--card);padding:20px;border-radius:8px;width:90%;max-width:500px;transform:translateY(-50px);transition:transform 0.3s ease;}
.modal-overlay.active .modal-content{transform:translateY(0);}
.modal-close{position:absolute;top:10px;right:15px;font-size:24px;cursor:pointer;color:#888;}
.modal-content h2{margin-top:0;}
.cart-items{list-style:none;padding:0;margin:0;}
.cart-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #eee;}
.cart-item:last-child{border-bottom:none;}
.cart-item img{width:60px;height:60px;object-fit:cover;border-radius:4px;margin-right:10px;}
.cart-item-info{flex-grow:1;}
.cart-total{font-weight:bold;font-size:1.2rem;margin-top:15px;text-align:right;}
.form-group{margin-bottom:15px;}
.form-group label{display:block;margin-bottom:5px;font-weight:600;}
.form-group input, .form-group textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;}
.form-group input[type="checkbox"]{width:auto;}
.form-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:20px;}
.btn{padding:10px 20px;border:none;border-radius:4px;cursor:pointer;font-weight:bold;}
.btn-primary{background:var(--amz-yellow);color:var(--amz-dark);}
.btn-secondary{background:#ddd;color:#333;}
.btn-full-width{width:100%;}
/* AI chat styles */
:root {
  --ai-brand: #4285f4;
}
.chat-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    width: 60px;
    height: 60px;
    background: var(--ai-brand);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    transition: transform 0.2s ease-in-out;
}
.chat-container:hover {
    transform: scale(1.1);
}
.chat-container svg {
    width: 30px;
    height: 30px;
}
.chat-modal {
    position: fixed;
    bottom: 90px;
    right: 20px;
    z-index: 999;
    width: 90%;
    max-width: 350px;
    height: 500px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.25);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transform: scale(0.8);
    opacity: 0;
    pointer-events: none;
    transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
}
.chat-modal.active {
    transform: scale(1);
    opacity: 1;
    pointer-events: auto;
}
.chat-header {
    background: var(--ai-brand);
    color: white;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 12px 12px 0 0;
}
.chat-header h3 { margin: 0; font-size: 1rem; }
.chat-close { font-size: 1.5rem; cursor: pointer; }
.chat-body {
    flex-grow: 1;
    padding: 15px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.chat-input {
    display: flex;
    padding: 10px;
    border-top: 1px solid #eee;
    align-items: center;
}
.chat-input input {
    flex-grow: 1;
    border: none;
    outline: none;
    padding: 10px;
    font-size: 0.9rem;
    border-radius: 20px;
    background: #f0f0f0;
}
.chat-input button {
    background: none;
    border: none;
    cursor: pointer;
    margin-left: 8px;
    padding: 5px;
}
.chat-input svg { width: 24px; height: 24px; color: var(--ai-brand); }
.message {
    padding: 10px;
    border-radius: 15px;
    max-width: 80%;
    word-wrap: break-word;
}
.message.user {
    background-color: #e0f2fe;
    align-self: flex-end;
    border-bottom-right-radius: 5px;
}
.message.bot {
    background-color: #f1f0f0;
    align-self: flex-start;
    border-bottom-left-radius: 5px;
}
.microphone-btn {
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: var(--ai-brand);
    color: white;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: background-color 0.2s, transform 0.2s;
}
.microphone-btn:hover {
    background-color: #3b7ad6;
    transform: scale(1.05);
}
.microphone-btn.recording {
    background-color: #ef4444;
}
.microphone-btn.recording svg {
    animation: pulse 1.5s infinite;
}
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}
</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="dns-prefetch" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body>
<div class="header">
  <div class="header-content">
    <div class="brand">WapMarket</div>
    <div class="flex-grow"></div>
    <div class="search-bar">
      <input type="text" placeholder="Buscar productos..." id="searchInput" oninput="debounceSearch()">
    </div>
    <button id="cartBtn" class="cart-btn">
      Carrito <span id="cartCount" class="count">0</span>
    </button>
  </div>
</div>

<div class="container">
  <h1>Negocios Locales</h1>
  <div class="category-filter">
    <button class="category-btn active" data-category="all">Todas las categorías</button>
    <!-- Categories will be dynamically added here -->
  </div>
  <div class="businesses-grid" id="businessesGrid">
    <!-- Business cards will be dynamically added here -->
  </div>
  <div class="products-grid" id="productsGrid" style="display:none;">
    <!-- Product cards will be dynamically added here -->
  </div>
</div>

<footer class="mt-auto py-4 bg-gray-800 text-white text-center">
    <div class="container">
        <p>&copy; 2024 WapMarket. Todos los derechos reservados.</p>
        <div class="footer-links" style="margin-top: 10px;">
            <a href="https://wa.me/?text=Hola%20WapMarket!" class="text-gray-400 hover:text-white mx-2" data-message="Quisiera información sobre cómo vender en WapMarket.">Vender en WapMarket</a>
            <a href="https://wa.me/?text=Hola%20WapMarket!" class="text-gray-400 hover:text-white mx-2" data-message="Hola, estoy interesado en los servicios de envío de WapMarket.">Servicios de Envío</a>
            <a href="https://wa.me/?text=Hola%20WapMarket!" class="text-gray-400 hover:text-white mx-2" data-message="Hola, me gustaría saber más sobre la API de WapMarket.">API para Negocios</a>
        </div>
    </div>
</footer>

<!-- Modal del carrito -->
<div id="cartModal" class="modal-overlay">
  <div class="modal-content">
    <span class="modal-close" id="closeCartModal">&times;</span>
    <h2>Tu Carrito</h2>
    <ul id="cartItems" class="cart-items"></ul>
    <div id="cartTotal" class="cart-total">Total: 0 XAF</div>
    <form id="checkoutForm" class="mt-4">
      <div class="form-group">
        <label for="cname">Tu Nombre</label>
        <input type="text" id="cname" required />
      </div>
      <div class="form-group">
        <label for="cphone">Tu Teléfono</label>
        <input type="tel" id="cphone" required />
      </div>
      <div class="form-group flex items-center gap-2">
        <input type="checkbox" id="deliveryChk" class="w-auto" />
        <label for="deliveryChk" class="mb-0">Solicitar envío a domicilio</label>
      </div>
      <div class="form-group" id="addressGroup" style="display: none;">
        <label for="address">Dirección de Envío</label>
        <textarea id="address" placeholder="Ej. Calle 5, N° 123, Malabo"></textarea>
      </div>
      <div class="form-group">
        <label for="cnote">Notas adicionales</label>
        <textarea id="cnote"></textarea>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary btn-full-width">Confirmar Pedido</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para mensajes -->
<div id="messageModal" class="modal-overlay">
  <div class="modal-content">
    <span class="modal-close" id="closeMessageModal">&times;</span>
    <h2 id="modalTitle"></h2>
    <p id="modalMessage"></p>
  </div>
</div>

<!-- Botón flotante para la IA -->
<div id="aiChatBtn" class="chat-container">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
    <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm-1 15h2v2h-2v-2zm-1-4h4V6h-4v7z" fill="white"/>
  </svg>
</div>

<!-- Modal de chat con IA -->
<div id="aiChatModal" class="chat-modal">
  <div class="chat-header">
    <h3>Asistente de compras WapMarket</h3>
    <span class="chat-close" id="closeAiChat">&times;</span>
  </div>
  <div class="chat-body" id="chatBody">
    <div class="message bot">Hola, soy tu asistente de compras. ¿Cómo puedo ayudarte hoy?</div>
  </div>
  <div class="chat-input">
    <input type="text" id="chatInput" placeholder="Escribe tu mensaje..." />
    <button id="micBtn" class="microphone-btn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3.31-2.69 6-6 6s-6-2.69-6-6H4c0 3.73 3.33 6.84 7.5 7.43V22h1v-4.57C16.67 17.84 20 14.73 20 11h-2.7z"/>
        </svg>
    </button>
  </div>
</div>

<script type="module">
    // URLs de la API, aquí la URL de WapMarket
    const API_BASE = 'https://wap-market-backend.web.app';
    const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=';

    let businesses = [];
    let products = [];
    let categories = new Set();
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    let allProducts = [];
    let speechRecognition = null;
    let isRecording = false;

    // Elementos del DOM
    const businessesGrid = document.getElementById('businessesGrid');
    const productsGrid = document.getElementById('productsGrid');
    const categoryFilter = document.querySelector('.category-filter');
    const searchInput = document.getElementById('searchInput');

    const cartBtn = document.getElementById('cartBtn');
    const cartModal = document.getElementById('cartModal');
    const closeCartModalBtn = document.getElementById('closeCartModal');
    const cartItemsList = document.getElementById('cartItems');
    const cartCountSpan = document.getElementById('cartCount');
    const cartTotalDiv = document.getElementById('cartTotal');
    const deliveryCheckbox = document.getElementById('deliveryChk');
    const addressGroup = document.getElementById('addressGroup');

    const messageModal = document.getElementById('messageModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const closeMessageModalBtn = document.getElementById('closeMessageModal');
    
    // AI Chat elements
    const aiChatBtn = document.getElementById('aiChatBtn');
    const aiChatModal = document.getElementById('aiChatModal');
    const closeAiChatBtn = document.getElementById('closeAiChat');
    const chatBody = document.getElementById('chatBody');
    const chatInput = document.getElementById('chatInput');
    const micBtn = document.getElementById('micBtn');

    let chatHistory = [];

    // ================== Funciones de utilidad ==================
    function showModal(title, message) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        messageModal.classList.add('active');
    }
    
    closeMessageModalBtn.onclick = () => messageModal.classList.remove('active');

    function saveCart() {
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartCount();
    }

    function updateCartCount() {
        const count = cart.reduce((sum, item) => sum + item.qty, 0);
        cartCountSpan.textContent = count;
    }

    // ================== Lógica del carrito y UI ==================
    function renderCart() {
        cartItemsList.innerHTML = '';
        let total = 0;
        if (cart.length === 0) {
            cartItemsList.innerHTML = '<p class="text-center text-gray-500">Tu carrito está vacío.</p>';
        } else {
            cart.forEach(item => {
                const li = document.createElement('li');
                li.className = 'cart-item';
                li.innerHTML = `
                    <img src="${item.image_url || 'https://placehold.co/60x60/f0f0f0/cccccc?text=no+img'}" alt="${item.title}" />
                    <div class="cart-item-info">
                        <strong>${item.title}</strong><br/>
                        <small>${item.qty} x ${Number(item.price_xaf).toLocaleString()} XAF</small>
                    </div>
                    <span>${(item.qty * Number(item.price_xaf)).toLocaleString()} XAF</span>
                `;
                cartItemsList.appendChild(li);
                total += item.qty * Number(item.price_xaf);
            });
        }
        cartTotalDiv.textContent = `Total: ${total.toLocaleString()} XAF`;
    }

    function openCart() {
        renderCart();
        cartModal.classList.add('active');
    }

    function closeCart() {
        cartModal.classList.remove('active');
    }

    cartBtn.onclick = openCart;
    closeCartModalBtn.onclick = closeCart;
    deliveryCheckbox.onchange = (e) => {
        addressGroup.style.display = e.target.checked ? 'block' : 'none';
    };

    // ================== Carga de datos de la API ==================
    class API {
        static async request(path, options = {}) {
            const url = `${API_BASE}${path}`;
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `Error HTTP! status: ${response.status}`);
                }
                return response.json();
            } catch (error) {
                console.error("API Request Error:", error);
                showModal('Error', 'No se pudo conectar al servidor. Por favor, inténtalo de nuevo.');
                throw error;
            }
        }
        static get(path) { return this.request(path); }
        static post(path, body) {
            return this.request(path, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
        }
    }

    async function loadBusinesses() {
        try {
            const data = await API.get('/public/business');
            businesses = data.items || [];
            renderBusinesses();
        } catch (e) {
            // Already handled by API class
        }
    }

    async function loadProductsByBusiness(businessId) {
        try {
            const data = await API.get(`/public/business/${businessId}/products`);
            allProducts = data.items || [];
            categories = new Set(['all', ...allProducts.map(p => p.category).filter(Boolean)]);
            renderCategories();
            renderProducts(allProducts);
        } catch (e) {
            // Already handled by API class
        }
    }

    // ================== Renderizado de la UI ==================
    function renderBusinesses() {
        businessesGrid.innerHTML = '';
        businesses.forEach(biz => {
            const card = document.createElement('div');
            card.className = 'business-card';
            card.innerHTML = `
                <img src="${biz.logo_url || 'https://placehold.co/400x150/f0f0f0/cccccc?text=Negocio'}" alt="${biz.name}" />
                <div class="business-content">
                    <h3>${biz.name}</h3>
                    <p>${biz.description || ''}</p>
                    <button class="btn btn-primary btn-full-width" onclick="showProducts('${biz.id}')">Ver productos</button>
                </div>
            `;
            businessesGrid.appendChild(card);
        });
    }

    function showProducts(businessId) {
        document.querySelector('.container h1').textContent = 'Productos';
        businessesGrid.style.display = 'none';
        productsGrid.style.display = 'grid';
        loadProductsByBusiness(businessId);
    }
    
    function renderCategories() {
        categoryFilter.innerHTML = '';
        categories.forEach(cat => {
            const btn = document.createElement('button');
            btn.className = 'category-btn';
            btn.textContent = cat === 'all' ? 'Todas las categorías' : cat;
            btn.dataset.category = cat;
            btn.onclick = () => filterProductsByCategory(cat);
            categoryFilter.appendChild(btn);
        });
        document.querySelector('.category-btn').classList.add('active');
    }

    function filterProductsByCategory(category) {
        document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.category-btn[data-category="${category}"]`).classList.add('active');
        const filtered = category === 'all' ? allProducts : allProducts.filter(p => p.category === category);
        renderProducts(filtered);
    }

    let searchTimeout;
    function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const query = searchInput.value.toLowerCase();
            const filtered = allProducts.filter(p => 
                p.title.toLowerCase().includes(query) || 
                (p.description && p.description.toLowerCase().includes(query))
            );
            renderProducts(filtered);
        }, 300);
    }

    function renderProducts(productsToRender) {
        productsGrid.innerHTML = '';
        productsToRender.forEach(p => {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.innerHTML = `
                <img src="${p.image_url || 'https://placehold.co/200x150/f0f0f0/cccccc?text=no+img'}" alt="${p.title}" />
                <div class="product-info">
                    <h4>${p.title}</h4>
                    <p>${Number(p.price_xaf).toLocaleString()} XAF</p>
                </div>
                <button class="add-to-cart" data-id="${p.id}">Añadir al carrito</button>
            `;
            productsGrid.appendChild(card);
        });
        document.querySelectorAll('.add-to-cart').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.target.dataset.id;
                addToCart(id, 1);
                showModal('Producto añadido', 'El producto ha sido añadido a tu carrito.');
            });
        });
    }

    function addToCart(productId, quantity) {
        const existingItem = cart.find(item => item.id === productId);
        if (existingItem) {
            existingItem.qty += quantity;
        } else {
            const product = allProducts.find(p => p.id === productId);
            if (product) {
                cart.push({ ...product, qty: quantity });
            }
        }
        saveCart();
    }

    // ================== Lógica de la IA ==================
    aiChatBtn.onclick = () => aiChatModal.classList.add('active');
    closeAiChatBtn.onclick = () => aiChatModal.classList.remove('active');

    function appendMessage(sender, text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        messageDiv.textContent = text;
        chatBody.appendChild(messageDiv);
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    async function callGeminiAPI(history, tools, systemInstruction) {
        const payload = {
            contents: history,
            tools: tools,
            systemInstruction: {
                parts: [{ text: systemInstruction }]
            },
            generationConfig: {
                responseMimeType: 'application/json',
                responseSchema: {
                    type: 'OBJECT',
                    properties: {
                        action: {
                            type: 'STRING',
                            enum: ['search_products', 'add_to_cart', 'respond']
                        },
                        parameters: {
                            type: 'OBJECT',
                            properties: {
                                query: { type: 'STRING' },
                                product_id: { type: 'STRING' },
                                quantity: { type: 'NUMBER' },
                                budget: { type: 'NUMBER' }
                            }
                        },
                        response_text: { type: 'STRING' }
                    },
                    required: ['action']
                }
            }
        };

        const apiKey = "";
        let response = null;
        let retries = 0;
        const maxRetries = 5;
        const baseDelay = 1000;

        while (retries < maxRetries) {
            try {
                response = await fetch(GEMINI_API_URL + apiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.ok) break;
            } catch (error) {
                console.error("Fetch attempt failed:", error);
            }
            retries++;
            const delay = baseDelay * Math.pow(2, retries);
            await new Promise(res => setTimeout(res, delay));
        }

        if (!response || !response.ok) {
            throw new Error('Failed to fetch from Gemini API after retries');
        }

        const result = await response.json();
        const candidate = result?.candidates?.[0];
        if (candidate?.content?.parts?.[0]?.text) {
            const jsonText = candidate.content.parts[0].text;
            return JSON.parse(jsonText);
        }
        return null;
    }

    async function handleChatInput(input) {
        appendMessage('user', input);
        chatHistory.push({ role: 'user', parts: [{ text: input }] });

        const systemPrompt = `
            Eres un asistente de compras de WapMarket. Tu objetivo es ayudar al usuario a encontrar y comprar productos.
            Tienes las siguientes herramientas a tu disposición. Debes responder con una acción en formato JSON.
            
            1.  "search_products": Para buscar productos.
                -   Parámetros:
                    -   "query": (string, obligatorio) El término de búsqueda del producto.
                    -   "budget": (number, opcional) El presupuesto máximo del usuario en XAF.
            2.  "add_to_cart": Para añadir un producto al carrito.
                -   Parámetros:
                    -   "product_id": (string, obligatorio) El ID del producto.
                    -   "quantity": (number, obligatorio) La cantidad a añadir.
            3.  "respond": Para responder al usuario con texto.
                -   Parámetros:
                    -   "response_text": (string, obligatorio) El texto de la respuesta.

            Tu respuesta DEBE ser SIEMPRE un JSON válido.
            Si el usuario te pide un listado de productos, usa "search_products".
            Si el usuario te pide añadir algo al carrito, usa "add_to_cart".
            Si el usuario te saluda, te da información, o hace preguntas generales, usa "respond".
            El ID de los productos y sus precios están en la base de datos, simula que los buscas. Si el usuario te da un presupuesto, prioriza los productos que se ajusten.
            
            Ejemplos de interacción:
            - Usuario: "Necesito comprar arroz y azúcar"
            - Tu respuesta: {"action": "search_products", "parameters": {"query": "arroz y azúcar"}}

            - Usuario: "Añade 2 botellas de agua"
            - Tu respuesta: {"action": "add_to_cart", "parameters": {"product_id": "simulated_id_for_water", "quantity": 2}}

            - Usuario: "Hola, ¿qué tal?"
            - Tu respuesta: {"action": "respond", "response_text": "Hola, ¿en qué puedo ayudarte hoy?"}
        `;

        try {
            const geminiResponse = await callGeminiAPI(chatHistory, [{ "google_search": {} }], systemPrompt);
            await handleGeminiResponse(geminiResponse);
        } catch (e) {
            appendMessage('bot', 'Lo siento, hubo un error. Por favor, inténtalo de nuevo.');
            console.error(e);
        }
    }

    async function handleGeminiResponse(response) {
        if (!response || !response.action) {
            appendMessage('bot', 'No pude entender tu solicitud. Por favor, sé más específico.');
            return;
        }

        switch (response.action) {
            case 'search_products':
                const query = response.parameters?.query || '';
                const budget = response.parameters?.budget;
                const filteredProducts = allProducts.filter(p => 
                    p.title.toLowerCase().includes(query.toLowerCase()) || 
                    (p.category && p.category.toLowerCase().includes(query.toLowerCase()))
                ).filter(p => budget ? Number(p.price_xaf) <= budget : true);
                
                if (filteredProducts.length > 0) {
                    let productList = "He encontrado los siguientes productos:\n";
                    filteredProducts.slice(0, 5).forEach(p => {
                        productList += `- ${p.title} - ${Number(p.price_xaf).toLocaleString()} XAF\n`;
                    });
                    
                    const listResponse = `{"action": "respond", "response_text": "${productList.replace(/"/g, '\\"')}\n¿Quieres que añada alguno a tu carrito?"}`;
                    handleGeminiResponse(JSON.parse(listResponse));

                } else {
                    appendMessage('bot', `Lo siento, no encontré productos para "${query}".`);
                }
                break;
            case 'add_to_cart':
                const product = allProducts.find(p => p.id === response.parameters?.product_id);
                if (product) {
                    addToCart(product.id, response.parameters?.quantity || 1);
                    appendMessage('bot', `Se ha añadido ${response.parameters?.quantity || 1} de ${product.title} a tu carrito.`);
                } else {
                    appendMessage('bot', 'No pude encontrar ese producto para añadirlo al carrito. Por favor, sé más específico.');
                }
                break;
            case 'respond':
            default:
                appendMessage('bot', response.response_text);
                break;
        }
    }

    document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && chatInput.value.trim() !== '') {
            handleChatInput(chatInput.value.trim());
            chatInput.value = '';
        }
    });

    if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        speechRecognition = new SpeechRecognition();
        speechRecognition.interimResults = false;
        speechRecognition.lang = 'es-ES';

        speechRecognition.onstart = () => {
            isRecording = true;
            micBtn.classList.add('recording');
        };

        speechRecognition.onend = () => {
            isRecording = false;
            micBtn.classList.remove('recording');
        };

        speechRecognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            chatInput.value = transcript;
            handleChatInput(transcript);
        };

        speechRecognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            showModal('Error de Voz', 'No se pudo iniciar la grabación. Asegúrate de que el micrófono esté habilitado.');
            isRecording = false;
            micBtn.classList.remove('recording');
        };

        micBtn.onclick = () => {
            if (isRecording) {
                speechRecognition.stop();
            } else {
                speechRecognition.start();
            }
        };
    } else {
        micBtn.style.display = 'none';
        showModal('Función no soportada', 'Tu navegador no soporta el reconocimiento de voz. Por favor, utiliza el teclado.');
    }
    
    // ================== Inicialización ==================
    function init() {
        updateCartCount();
        loadBusinesses();
        // Carga una lista de productos para el asistente de IA
        // Simulamos una carga de productos de un negocio con un ID conocido.
        loadProductsByBusiness('6572793b88950d00167c1340');
    }
    init();

    document.getElementById('checkoutForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!cart.length) { showModal('Tu carrito está vacío'); return; }
      const items = cart.map(c => ({ product_id: c.id, qty: c.qty }));
      const delivery = document.getElementById('deliveryChk').checked;
      const payload = {
        items,
        customer_name: document.getElementById('cname').value,
        customer_phone: document.getElementById('cphone').value,
        address: delivery ? document.getElementById('address').value : undefined,
        note: document.getElementById('cnote').value,
        delivery
      };
      const res = await API.post('/public/cart/checkout', payload);
      if (res.error){ showModal(res.error); return; }
      showModal('Pedido confirmado. Código de grupo: ' + res.group_id + '\nTotal: ' + (res.total_xaf||0).toLocaleString() + ' XAF');
      cart = []; saveCart(); closeCart();
    });

    // Listener para los enlaces del footer
    document.querySelector('.footer-links').addEventListener('click', e => {
      const link = e.target.closest('a');
      if (!link) return;

      e.preventDefault();
      const href = link.href;
      const message = link.dataset.message;

      showModal(`¿Deseas enviar el siguiente mensaje a WhatsApp?\n\n"${message}"`);
    });
</script>
</body>
</html>
