<!doctype html>
<html lang="es">
<head>
Â  <meta charset="utf-8">
Â  <meta name="viewport" content="width=device-width,initial-scale=1">
Â  <title>Vendedor â€” WapMarket</title>
Â  <link rel="stylesheet" href="/styles.css">
Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
:root{
Â  --amz-dark:#131921;
Â  --amz-dark-gradient:linear-gradient(to bottom, #232f3e, #131921);
Â  --amz-yellow:#FF9900;
Â  --amz-border:#e6e6e6;
Â  --link:#007185;
Â  --bg-page:#eaeded;
Â  --card-bg:#fff;
Â  --text-dark:#111;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg-page);font-family:Arial,sans-serif;color:var(--text-dark)}
.header{
  position:sticky;
  top:0;
  z-index:50;
  background:var(--amz-dark);
  padding:8px 0;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  display:flex;
  align-items:center;
}
.header-bg{
  background:var(--amz-dark-gradient);
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
}
.wrapper{
  max-width:1200px;
  margin:0 auto;
  padding:0 16px;
  position:relative;
  z-index:2;
}
.row{display:flex;align-items:center;gap:12px}
.logo{
  color:#fff;
  font-weight:800;
  letter-spacing:.5px;
  font-size:1.5rem;
  padding:5px 10px;
}
.logout-btn{
  background:transparent;
  border:1px solid rgba(255,255,255,.5);
  color:#fff;
  font-weight:bold;
  padding:6px 14px;
  border-radius:3px;
  cursor:pointer;
  transition:all 0.2s ease-in-out;
}
.logout-btn:hover{background:rgba(255,255,255,.15)}
/* Business identity */
.biz-head{
  color:#fff;
  margin-left:auto;
  display:flex;
  align-items:center;
  gap:8px;
  font-weight:600;
}
.biz-badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  color:#fff;
  font-weight:700;
}
.biz-badge .v{
  width:18px;
  height:18px;
  border-radius:50%;
  background:#12b886;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
  color:#fff;
}

/* Cards */
.card{
  background:var(--card-bg);
  border:1px solid var(--amz-border);
  border-radius:8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
  margin:16px 0;
}
h3{margin:0 0 12px;font-size:1.2rem;font-weight:700}
label{display:block;margin:10px 0 5px;font-weight:700}
input,select,textarea{
  width:100%;
  height:40px;
  padding:8px;
  border:1px solid #999;
  border-radius:3px;
  background:#fff;
  transition:border-color 0.2s;
}
input:focus, select:focus, textarea:focus{
  outline:none;
  border-color:var(--amz-yellow);
  box-shadow:0 0 5px rgba(255, 153, 0, 0.5);
}
textarea{height:88px;resize:vertical}
.btn{
  height:38px;
  border-radius:3px;
  padding:0 16px;
  border:1px solid #a88734;
  background:var(--amz-yellow);
  font-weight:700;
  color:var(--text-dark);
  cursor:pointer;
  box-shadow: 0 1px 0 rgba(255,255,255,.4) inset, 0 1px 1px rgba(0,0,0,.2);
  transition:all 0.2s ease-in-out;
}
.btn:hover{
  background:#f0c14b;
  border-color:#927e28;
}
.btn.ghost{background:#fff;border:1px solid var(--amz-border);color:var(--link);box-shadow:none;}
.btn.ghost:hover{background:#fafafa;border-color:#ccc;}
.btn.danger{background:#fff;border:1px solid #b12704;color:#b12704}
.btn.danger:hover{background:#f8f8f8}
.btn.small{height:30px;padding:0 10px;font-size:.9rem}

/* Tables */
.table{width:100%;border-collapse:collapse;border:1px solid var(--amz-border);border-radius:8px;overflow:hidden;}
.table th,.table td{
  border-bottom:1px solid var(--amz-border);
  padding:10px;
  vertical-align:middle;
  text-align:left;
  background:#fff;
}
.table th{background:#f0f2f2;font-weight:bold;color:#555}
.table td:first-child, .table th:first-child{border-left:none;}
.table td:last-child, .table th:last-child{border-right:none;}
.table tr:last-child td{border-bottom:none;}
.table img{border-radius:4px;width:50px;height:auto;}
.table-actions{display:flex;gap:8px;flex-wrap:wrap}
.table-wrap{overflow:auto}

/* Responsive: make tables scroll on small screens */
@media (max-width: 900px){
Â  .row.wrap{flex-wrap:wrap}
Â  .biz-head{order:3;width:100%;justify-content:flex-start;margin:6px 0 0}
}
@media (max-width: 640px){
Â  .wrapper{padding:0 10px}
Â  .table th,.table td{padding:8px}
}
</style>

</head>
<body>
<header class="header">
  <div class="header-bg"></div>
  <div class="row wrapper">
Â  Â  <div class="logo">WapMarket</div><div class="biz-head"><span id="bizName">Mi negocio</span><span id="bizVerified" class="biz-badge" style="display:none"><span class="v">âœ“</span> Verificado</span></div><button id="logoutBtn" class="btn logout-btn">Cerrar sesiÃ³n</button>
Â  </div>
</header>

<main class="wrapper">
Â  <!-- Login -->
Â  <div class="card" style="padding:16px;max-width:800px" id="loginBox">
Â  Â  <h3>Login de Negocio</h3>
Â  Â  <form onsubmit="return false;">
Â  Â  Â  <label>Email <input id="lemail" type="email" required></label>
Â  Â  Â  <label>ContraseÃ±a <input id="lpass" type="password" required></label>
Â  Â  Â  <button class="btn" id="btnLogin">Entrar</button>
Â  Â  </form>
Â  </div>

Â  <!-- Panel negocio -->
Â  <div id="panel" style="display:none">
Â  Â  <!-- Publicar producto -->
Â  Â  <div class="card" style="padding:16px;max-width:800px">
Â  Â  Â  <h3>Publicar producto</h3>
Â  Â  Â  <form id="prodForm" onsubmit="return false;">
Â  Â  Â  Â  <label>TÃ­tulo <input id="title" required></label>
Â  Â  Â  Â  <label>DescripciÃ³n <textarea id="description"></textarea></label>
Â  Â  Â  Â  <label>CategorÃ­a
Â  Â  Â  Â  Â  <select id="category">
Â  Â  Â  Â  Â  Â  <option>Servicios</option><option>Comida</option><option>Tiendas</option>
Â  Â  Â  Â  Â  Â  <option>Salud</option><option>Transporte</option><option>TecnologÃ­a</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </label>
Â  Â  Â  Â  <label>Precio (XAF) <input id="price" type="number" min="0"></label>
Â  Â  Â  Â  <label>Imagen (archivo) <input id="image" type="file" accept="image/*"></label>
Â  Â  Â  Â  <button class="btn" id="btnPublicar">Publicar</button>
Â  Â  Â  </form>
Â  Â  </div>

Â  Â  <!-- Pedidos -->
Â  Â  <div class="card" style="padding:16px;max-width:1100px">
Â  Â  Â  <h3>Pedidos</h3>
Â  Â  Â  <div class="table-wrap"><table class="table" id="ordersTable">
Â  Â  Â  Â  <thead><tr><th>ID</th><th>Grupo</th><th>Producto</th><th>Precio</th><th>Cant.</th>
Â  Â  Â  Â  <th>Cliente</th><th>TelÃ©fono</th><th>EnvÃ­o</th><th>DirecciÃ³n</th><th>Estado</th><th>Acciones</th></tr></thead>
Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  </table></div>
Â  Â  </div>

Â  Â  <!-- Productos -->
Â  Â  <div class="card" style="padding:16px;max-width:1100px">
Â  Â  Â  <h3>Mis Productos</h3>
Â  Â  Â  <div class="table-wrap"><table class="table" id="productsTable">
Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <th>ID</th><th>TÃ­tulo</th><th>CategorÃ­a</th><th>Precio</th><th>Imagen</th><th>Creado</th><th>Acciones</th>
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  </thead>
Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  </table></div>
Â  Â  </div>
Â  </div>
</main>

<script src="/api.js"></script>
<script>

// API DELETE polyfill si no existe
if (!API.delete){
Â  API.delete = function(url, opts){ opts = opts||{}; opts.method='DELETE'; return API.request(url, null, opts); };
}

let token = null;Â 
let business_id = null;
function authHeaders(){ return token ? { 'Authorization':'Bearer '+token } : {}; }


// ============= PERFIL DEL NEGOCIO (nombre e insignia) =============
async function loadProfile(){
Â  try{
Â  Â  let me = await API.get('/business/me', { headers: authHeaders() });
Â  Â  if (me && me.name){ document.getElementById('bizName').textContent = me.name; }
Â  Â  if (me && (me.verified || me.is_verified)){ document.getElementById('bizVerified').style.display='inline-flex'; }
Â  Â  if (me && me.info){ document.getElementById('bizName').title = me.info; }
Â  }catch(e){
Â  Â  // fallback silencioso si el endpoint no existe
Â  Â  console.warn('No se pudo cargar el perfil del negocio', e);
Â  }
}

// ============= UTIL: mapa de pedidos para acciones rÃ¡pidas =============
const ordersMap = {};

// ============= ENVIAR WHATSAPP AL CLIENTE =============
function sendWhatsAppForOrder(order, newStatus){
Â  try{
Â  Â  if(!order) return;
Â  Â  const phone = String(order.customer_phone||'').replace(/[^0-9]/g,'');
Â  Â  if(!phone) return;
Â  Â  const delivery = order.delivery ? `SÃ­ (+${Number(order.delivery_fee_xaf||0).toLocaleString()} XAF)` : 'No';
Â  Â  const total = (Number(order.price_xaf||0) * Number(order.qty||1)) + Number(order.delivery ? (order.delivery_fee_xaf||0):0);
Â  Â  const text = [
Â  Â  Â  'WapMarket â€” ConfirmaciÃ³n de pedido',
Â  Â  Â  `Negocio: ${document.getElementById('bizName').textContent}`,
Â  Â  Â  `Pedido #${order.id} (grupo ${order.group_id||'-'})`,
Â  Â  Â  `Producto: ${order.title}`,
Â  Â  Â  `Cantidad: ${order.qty}`,
Â  Â  Â  `EnvÃ­o: ${delivery}`,
Â  Â  Â  `Total: ${total.toLocaleString()} XAF`,
Â  Â  Â  `Estado: ${newStatus}`,
Â  Â  Â  '',
Â  Â  Â  'Gracias por su compra.'
Â  Â  ].join('\n');
Â  Â  const url = `https://wa.me/${phone}?text=${encodeURIComponent(text)}`;
Â  Â  window.open(url, '_blank');
Â  }catch(err){ console.warn('WhatsApp fallÃ³', err); }
}

// ================== GENERACIÃ“N DE FACTURAS (PDF) ==================
function generateInvoice(order) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 10;
    const margin = 10;
    const lineHeight = 7;
    const productsList = Array.isArray(order.products) ? order.products : [{ product: { title: order.title, price_xaf: order.price_xaf }, quantity: order.qty }];

    doc.setFontSize(16);
    doc.text('Factura de Compra', margin, y);
    y += lineHeight * 2;

    doc.setFontSize(10);
    doc.text(`CÃ³digo de Pedido: ${order.id}`, margin, y);
    y += lineHeight;
    doc.text(`Cliente: ${order.customer_name || 'AnÃ³nimo'}`, margin, y);
    y += lineHeight;
    doc.text(`TelÃ©fono: ${order.customer_phone || ''}`, margin, y);
    y += lineHeight * 2;
    
    doc.setFontSize(12);
    doc.text('Detalles del Pedido:', margin, y);
    y += lineHeight;
    
    let total = 0;
    productsList.forEach(item => {
        const product = item.product || {};
        const title = product.title || order.title;
        const price = Number(product.price_xaf || order.price_xaf || 0);
        const quantity = Number(item.quantity || order.qty || 1);
        const itemTotal = price * quantity;
        total += itemTotal;
        doc.text(`- ${title} (x${quantity}) - ${price.toLocaleString()} XAF c/u`, margin, y);
        y += lineHeight;
    });

    if (order.delivery) {
        const deliveryFee = Number(order.delivery_fee_xaf || 0);
        doc.text(`EnvÃ­o: ${deliveryFee.toLocaleString()} XAF`, margin, y);
        y += lineHeight;
        total += deliveryFee;
    }

    doc.setDrawColor(0);
    doc.setLineWidth(0.5);
    doc.line(margin, y, 200, y);
    y += lineHeight;
    
    doc.setFontSize(14);
    doc.text(`TOTAL: ${total.toLocaleString()} XAF`, margin, y);

    doc.save(`factura_${order.id.slice(-8)}.pdf`);
}


// ================== LOGIN ==================
document.getElementById('btnLogin').addEventListener('click', async ()=>{
Â  const res = await API.post('/business/login', { email: lemail.value, password: lpass.value });
Â  if (res.error){ alert(res.error); return; }
Â  token = res.token; business_id = res.business_id;
Â  localStorage.setItem('bizToken', token);
Â  localStorage.setItem('bizId', String(business_id));
Â  document.getElementById('loginBox').style.display='none';
Â  document.getElementById('panel').style.display='block';
Â  loadOrders();
Â  loadProducts();
Â  loadProfile();
});

// Autologin si ya hay token guardado
token = localStorage.getItem('bizToken');Â 
business_id = Number(localStorage.getItem('bizId')||0);
if (token && business_id){Â 
Â  document.getElementById('loginBox').style.display='none';Â 
Â  document.getElementById('panel').style.display='block';Â 
Â  loadOrders();Â 
Â  loadProducts();
Â  loadProfile();
}

// ================== PUBLICAR PRODUCTO ==================
document.getElementById('btnPublicar').addEventListener('click', async ()=>{
Â  if (!token) return alert('Primero inicia sesiÃ³n');
Â  let imageUrl = '';
Â  const file = document.getElementById('image').files[0];
Â  if (file){
Â  Â  const fd = new FormData();Â 
Â  Â  fd.append('image', file);
Â  Â  const up = await API.upload('/business/upload-image', fd, { headers: authHeaders() });
Â  Â  if (up.error) return alert(up.error);
Â  Â  imageUrl = up.url;
Â  }
Â  const payload = {
Â  Â  title: title.value,Â 
Â  Â  description: description.value,Â 
Â  Â  category: category.value,
Â  Â  price_xaf: Number(price.value || 0),Â 
Â  Â  image_url: imageUrl
Â  };
Â  const res = await API.post('/business/products', payload, { headers: authHeaders() });
Â  if (res.error){ alert(res.error); return; }
Â  alert('Producto publicado');
Â  document.getElementById('prodForm').reset();
Â  loadProducts();
});

// ================== CARGAR PEDIDOS ==================
async function loadOrders(){
Â  if (!token) return;
Â  const data = await API.get('/business/orders', { headers: authHeaders() });
Â  const tb = document.querySelector('#ordersTable tbody');Â 
Â  tb.innerHTML='';
Â Â 
(data.items||[]).forEach(o=>{
Â  const tr = document.createElement('tr');
Â  const deliveryTxt = o.delivery ? ('SÃ­ (+'+Number(o.delivery_fee_xaf||0).toLocaleString()+' XAF)') : 'No';
Â  tr.innerHTML = `<td>${o.id}</td><td>${o.group_id||''}</td><td>${o.title}</td><td>${Number(o.price_xaf||0).toLocaleString()} XAF</td><td>${o.qty}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${o.customer_name||''}</td><td>${o.customer_phone||''}</td><td>${deliveryTxt}</td><td>${o.address||''}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><span class="small">${o.status}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="table-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn small" data-id="${o.id}" data-s="accepted">Aceptar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn small ghost" data-id="${o.id}" data-s="rejected">Rechazar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn small" data-id="${o.id}" data-s="fulfilled">Entregado</button>
                    <button class="btn small ghost" data-id="${o.id}" data-action="invoice">Factura</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>`;
Â  tb.appendChild(tr);
Â  ordersMap[o.id] = o;
});

Â  tb.onclick = async (e)=>{
Â  Â  const btn = e.target.closest('button.btn'); if (!btn) return;
Â  Â  const id = btn.getAttribute('data-id');Â 
    const action = btn.getAttribute('data-action');
    if (action === 'invoice') {
        generateInvoice(ordersMap[id]);
    } else {
    Â  Â  const s = btn.getAttribute('data-s');
    Â  Â  const r = await API.put('/business/orders/'+id, { status:s }, { headers: authHeaders() });
    Â  Â  if (r.error) return alert(r.error);
    Â  Â  try{ sendWhatsAppForOrder(ordersMap[id], s); }catch(_){}
    }
Â  Â  loadOrders();
Â  };
}

// ================== CARGAR PRODUCTOS ==================
async function loadProducts(){
Â  if (!token) return;
Â  const data = await API.get('/business/products', { headers: authHeaders() });
Â  console.log("Productos del negocio:", data); // ðŸ”Ž debug
Â  const tb = document.querySelector('#productsTable tbody');
Â  tb.innerHTML='';
Â  (data.items||[]).forEach(p=>{
Â  Â  const tr = document.createElement('tr');
Â  Â  tr.innerHTML = `
Â  Â  Â  <td>${p.id}</td>
Â  Â  Â  <td>${p.title}</td>
Â  Â  Â  <td>${p.category||''}</td>
Â  Â  Â  <td>${Number(p.price_xaf||0).toLocaleString()} XAF</td>
Â  Â  Â  <td>${p.image_url ? `<img src="${p.image_url}" style="max-height:50px">` : ''}</td>
Â  Â  Â  <td>${new Date(p.created_at).toLocaleString()}</td>
Â  Â  `;
Â  Â  tb.appendChild(tr);
Â  });
}
Â  // ================== CERRAR SESIÃ“N ==================
document.getElementById('logoutBtn').addEventListener('click', ()=>{
Â  localStorage.removeItem('bizToken');
Â  localStorage.removeItem('bizId');
Â  token = null;
Â  business_id = null;
Â  // Mostrar login otra vez y ocultar el panel
Â  document.getElementById('loginBox').style.display = 'block';
Â  document.getElementById('panel').style.display = 'none';
Â  });
</script>
</body>
</html>
