<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Vendedor — WapMarket</title>
  <style>
    :root{
      --amz-dark:#131921;
      --amz-light:#232f3e;
      --amz-yellow:#febd69;
      --amz-border:#e6e6e6;
      --link:#007185;
      --bg-color: #eaeded;
      --panel-bg: #fff;
      --text-color: #111;
      --heading-color: #000;
      --button-bg: #ff7a00;
      --button-text: #fff;
      --button-hover: #e06a00;
      --accent-color: #ffb43a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg-color);font-family:Inter, sans-serif;color:var(--text-color); line-height: 1.6;}
    .container{max-width:1200px;margin:0 auto;padding:0 16px}
    .header{position:sticky;top:0;z-index:50;background:var(--amz-dark);padding:10px 0}
    .header .wrapper{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;}
    .logo{color:#fff;font-weight:800;letter-spacing:.2px;font-size:1.5rem;}
    .logout-btn{background:transparent;border:1px solid rgba(255,255,255,.25);color:#fff;padding:8px 16px;border-radius:6px;cursor:pointer;}
    .logout-btn:hover{background:rgba(255,255,255,.08)}
    .business-info{display:flex;align-items:center;gap:1rem;color:#fff;}
    .business-info img{width:40px;height:40px;border-radius:50%;}
    .content-area{padding:2rem 0;}
    .panel{background:var(--panel-bg);padding:2rem;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.05);margin-bottom:2rem;}
    h1, h2{color:var(--heading-color);margin-top:0;font-weight:600;}
    h1{font-size:2rem;margin-bottom:1rem;}
    h2{font-size:1.5rem;margin-bottom:1.5rem;}
    .tabs{display:flex;gap:1rem;margin-bottom:2rem;}
    .tab-btn{padding:10px 20px;background:none;border:none;cursor:pointer;font-weight:600;color:var(--muted);}
    .tab-btn.active{border-bottom:3px solid var(--accent-color);color:var(--heading-color);}
    .tab-content{display:none;}
    .tab-content.active{display:block;}
    .search-bar{display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;}
    .search-bar input{flex-grow:1;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:1rem;}
    .search-bar select{padding:10px;border:1px solid #ccc;border-radius:6px;}
    .orders-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));gap:1rem;}
    .order-card{background:#fafafa;padding:1.5rem;border-radius:8px;border:1px solid #e0e0e0;box-shadow:0 2px 5px rgba(0,0,0,0.03);position:relative;overflow:hidden;}
    .order-card.new::before{content:'';position:absolute;top:0;left:0;width:10px;height:100%;background:var(--accent-color);}
    .order-card.pending::before{content:'';position:absolute;top:0;left:0;width:10px;height:100%;background:#ffb300;}
    .order-card h3{margin-top:0;display:flex;justify-content:space-between;align-items:center;font-size:1.2rem;color:var(--heading-color);}
    .order-card .status{font-size:0.85rem;padding:4px 8px;border-radius:4px;color:#fff;font-weight:600;text-transform:uppercase;}
    .status-new{background:#ff7a00;}
    .status-pending{background:#ffb300;}
    .status-completed{background:#00b894;}
    .order-details{font-size:0.9rem;color:var(--muted);margin-top:0.5rem;}
    .order-details ul{list-style:none;padding:0;margin:0;}
    .order-details li{margin-bottom:0.5rem;display:flex;justify-content:space-between;}
    .order-details li span:last-child{font-weight:600;}
    .order-actions{display:flex;gap:0.5rem;margin-top:1rem;justify-content:flex-end;}
    .btn{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:0.9rem;}
    .btn-primary{background:var(--button-bg);color:var(--button-text);}
    .btn-primary:hover{background:var(--button-hover);}
    .btn-secondary{background:#e0e0e0;color:var(--text-color);}
    .btn-secondary:hover{background:#d0d0d0;}
    table{width:100%;border-collapse:collapse;margin-top:1.5rem;}
    table th, table td{padding:12px;border-bottom:1px solid #e0e0e0;text-align:left;}
    table th{background:#fafafa;font-weight:600;}
    table img{max-height:50px;border-radius:4px;}
    .table-responsive{overflow-x:auto;}

    /* Modal styles */
    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;justify-content:center;align-items:center;z-index:1000;opacity:0;visibility:hidden;transition:opacity 0.3s ease;}
    .modal-overlay.active{opacity:1;visibility:visible;}
    .modal-content{background:var(--panel-bg);padding:2rem;border-radius:8px;max-width:600px;width:90%;transform:translateY(-50px);transition:transform 0.3s ease;box-shadow:0 10px 25px rgba(0,0,0,0.2);}
    .modal-overlay.active .modal-content{transform:translateY(0);}
    .modal-close{position:absolute;top:1rem;right:1rem;font-size:1.5rem;cursor:pointer;color:#888;}
    .modal-content h2{margin-top:0;}
    
    @media print {
      body * {
        visibility: hidden;
      }
      .invoice-container, .invoice-container * {
        visibility: visible;
      }
      .invoice-container {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        padding: 2rem;
        background: #fff;
        color: #000;
      }
      .no-print {
        display: none !important;
      }
    }
    .invoice-container{
      display:none;
    }
  </style>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div class="header">
    <div class="wrapper">
      <div class="row">
        <div class="logo">WapMarket</div>
        <div class="business-info" id="businessInfo">
          <img src="https://placehold.co/40x40/FF7A00/FFFFFF?text=B" alt="Negocio">
          <span id="businessName">Nombre del Negocio</span>
        </div>
      </div>
      <button class="logout-btn" id="logoutBtn">Cerrar Sesión</button>
    </div>
  </div>

  <div class="container content-area">
    <div class="panel">
      <div class="tabs">
        <button class="tab-btn active" data-tab="orders">Pedidos</button>
        <button class="tab-btn" data-tab="products">Productos</button>
      </div>

      <div id="orders" class="tab-content active">
        <h1>Pedidos del Negocio</h1>
        
        <div class="search-bar">
          <input type="text" id="orderSearch" placeholder="Buscar por código, cliente, teléfono, estado...">
          <select id="orderSort">
            <option value="createdAt-desc">Fecha (Más recientes)</option>
            <option value="createdAt-asc">Fecha (Más antiguos)</option>
            <option value="status-desc">Estado (Nuevos primero)</option>
            <option value="status-asc">Estado (Completados primero)</option>
          </select>
        </div>

        <div id="ordersGrid" class="orders-grid">
          <!-- Order cards will be injected here -->
        </div>
      </div>

      <div id="products" class="tab-content">
        <h1>Productos del Negocio</h1>
        <div class="table-responsive">
          <table id="productsTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Categoría</th>
                <th>Precio</th>
                <th>Imagen</th>
                <th>Fecha de Creación</th>
              </tr>
            </thead>
            <tbody>
              <!-- Product data will be injected here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <div class="invoice-container" id="invoiceContainer"></div>

  <div id="modalOverlay" class="modal-overlay">
    <div class="modal-content">
      <span class="modal-close" id="modalClose">&times;</span>
      <h2 id="modalTitle"></h2>
      <p id="modalMessage"></p>
      <div class="modal-actions" id="modalActions"></div>
    </div>
  </div>

  <script type="module">
    // Firebase and Firestore imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, setDoc, query, onSnapshot, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables for Firebase configuration, provided by the environment.
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let token = localStorage.getItem('bizToken');
    let userId = null;
    let businessId = localStorage.getItem('bizId');
    let ordersMap = {};

    // API class for interacting with the backend
    class API {
        static async request(path, options) {
            const url = `https://wap-market-backend.web.app${path}`;
            const response = await fetch(url, options);
            return response.json();
        }
        static get(path, options = {}) {
            return this.request(path, { ...options, method: 'GET' });
        }
        static put(path, body, options = {}) {
            return this.request(path, {
                ...options,
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', ...options.headers },
                body: JSON.stringify(body)
            });
        }
        static post(path, body, options = {}) {
            return this.request(path, {
                ...options,
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...options.headers },
                body: JSON.stringify(body)
            });
        }
    }

    // Authentication headers for API calls
    function authHeaders() {
        return { 'Authorization': `Bearer ${token}` };
    }

    // Show a custom modal dialog
    function showModal(title, message, actions = []) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalMessage').textContent = message;
      const modalActions = document.getElementById('modalActions');
      modalActions.innerHTML = '';
      actions.forEach(action => {
        const btn = document.createElement('button');
        btn.textContent = action.label;
        btn.className = `btn ${action.class}`;
        btn.onclick = () => {
          action.handler();
          hideModal();
        };
        modalActions.appendChild(btn);
      });
      document.getElementById('modalOverlay').classList.add('active');
    }

    // Hide the modal dialog
    function hideModal() {
      document.getElementById('modalOverlay').classList.remove('active');
    }
    document.getElementById('modalClose').addEventListener('click', hideModal);

    // ================== GESTIÓN DE AUTENTICACIÓN ==================
    async function initAuth() {
        try {
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
            userId = auth.currentUser.uid;
            console.log("Autenticación exitosa. User ID:", userId);
        } catch (error) {
            console.error("Error de autenticación:", error);
        }
    }

    // ================== GESTIÓN DE PESTAÑAS ==================
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        e.target.classList.add('active');
        document.getElementById(e.target.dataset.tab).classList.add('active');
      });
    });

    // ================== GESTIÓN DE PEDIDOS ==================
    const ordersGrid = document.getElementById('ordersGrid');
    const orderSearch = document.getElementById('orderSearch');
    const orderSort = document.getElementById('orderSort');

    async function loadOrders() {
      if (!userId) return;

      const ordersCollection = collection(db, `artifacts/${appId}/public/data/orders`);
      let ordersQuery = query(ordersCollection, where("business_id", "==", businessId));

      const unsubscribe = onSnapshot(ordersQuery, (querySnapshot) => {
        let orders = [];
        querySnapshot.forEach((doc) => {
          const order = { id: doc.id, ...doc.data() };
          orders.push(order);
          ordersMap[order.id] = order;
        });
        renderOrders(orders);
      }, (error) => {
        console.error("Error al escuchar cambios en los pedidos:", error);
      });

      return unsubscribe;
    }

    function renderOrders(orders) {
      const searchTerm = orderSearch.value.toLowerCase();
      const sortBy = orderSort.value;
      
      const filteredOrders = orders.filter(order => {
        const orderText = JSON.stringify(order).toLowerCase();
        return orderText.includes(searchTerm);
      });

      filteredOrders.sort((a, b) => {
        const [field, direction] = sortBy.split('-');
        let valA, valB;
        if (field === 'createdAt') {
          valA = new Date(a.created_at || a.createdAt);
          valB = new Date(b.created_at || b.createdAt);
        } else if (field === 'status') {
          const statusOrder = { 'new': 3, 'pending': 2, 'completed': 1, 'canceled': 0 };
          valA = statusOrder[a.status] || 0;
          valB = statusOrder[b.status] || 0;
        }
        
        if (valA < valB) return direction === 'asc' ? -1 : 1;
        if (valA > valB) return direction === 'asc' ? 1 : -1;
        return 0;
      });

      ordersGrid.innerHTML = '';
      if (filteredOrders.length === 0) {
        ordersGrid.innerHTML = '<p class="text-center text-gray-500">No se encontraron pedidos.</p>';
        return;
      }

      filteredOrders.forEach(order => {
        const card = document.createElement('div');
        let statusClass;
        let cardClass;
        if (order.status === 'new') {
          statusClass = 'status-new';
          cardClass = 'new';
        } else if (order.status === 'pending') {
          statusClass = 'status-pending';
          cardClass = 'pending';
        } else {
          statusClass = 'status-completed';
          cardClass = '';
        }
        
        card.className = `order-card ${cardClass}`;
        card.innerHTML = `
          <h3>
            Pedido #${order.id.slice(0, 8)}
            <span class="status ${statusClass}">${order.status}</span>
          </h3>
          <div class="order-details">
            <p><strong>Cliente:</strong> ${order.customer_name || 'N/A'}</p>
            <p><strong>Total:</strong> ${Number(order.total_xaf || 0).toLocaleString()} XAF</p>
            <p><strong>Fecha:</strong> ${new Date(order.created_at).toLocaleString()}</p>
            <p><strong>Entrega:</strong> ${order.delivery ? 'Sí' : 'No'}</p>
            <ul>
              ${(order.items || []).map(item => `
                <li>
                  <span>${item.qty} x ${item.title || 'Producto desconocido'}</span>
                  <span>${Number(item.price_xaf || 0).toLocaleString()} XAF</span>
                </li>
              `).join('')}
            </ul>
          </div>
          <div class="order-actions no-print">
            <button class="btn btn-secondary print-invoice-btn" data-id="${order.id}">Factura</button>
            ${order.status === 'new' ? `<button class="btn btn-primary action-btn" data-id="${order.id}" data-status="pending">Preparar</button>` : ''}
            ${order.status === 'pending' ? `<button class="btn btn-primary action-btn" data-id="${order.id}" data-status="completed">Entregado</button>` : ''}
          </div>
        `;
        ordersGrid.appendChild(card);
      });
      addOrderListeners();
    }
    
    orderSearch.addEventListener('input', () => renderOrders(Object.values(ordersMap)));
    orderSort.addEventListener('change', () => renderOrders(Object.values(ordersMap)));

    function addOrderListeners() {
      document.querySelectorAll('.action-btn').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.getAttribute('data-id'); 
          const status = btn.getAttribute('data-status');
          
          try {
            const orderRef = doc(db, `artifacts/${appId}/public/data/orders`, id);
            await setDoc(orderRef, { status: status, updated_at: new Date().toISOString() }, { merge: true });
            
            showModal('Pedido Actualizado', `El pedido #${id.slice(0, 8)} ha sido actualizado a "${status}".`, [{
              label: 'OK',
              class: 'btn-primary',
              handler: () => {}
            }]);
          } catch (e) {
            console.error("Error al actualizar el estado del pedido:", e);
            showModal('Error', 'No se pudo actualizar el estado del pedido. Por favor, inténtalo de nuevo.');
          }
        };
      });

      document.querySelectorAll('.print-invoice-btn').forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-id');
          const order = ordersMap[id];
          if (order) {
            generateInvoice(order);
          } else {
            showModal('Error', 'No se encontró la información del pedido para generar la factura.');
          }
        };
      });
    }

    function generateInvoice(order) {
        const invoiceContainer = document.getElementById('invoiceContainer');
        invoiceContainer.innerHTML = `
          <div style="font-family: Arial, sans-serif; padding: 20px; border: 1px solid #ddd; max-width: 600px; margin: auto;">
            <h2 style="text-align: center; margin-bottom: 20px;">Factura</h2>
            <div style="border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px;">
              <p><strong>Pedido ID:</strong> ${order.id}</p>
              <p><strong>Fecha:</strong> ${new Date(order.created_at).toLocaleString()}</p>
              <p><strong>Cliente:</strong> ${order.customer_name || 'N/A'}</p>
              <p><strong>Teléfono:</strong> ${order.customer_phone || 'N/A'}</p>
              ${order.address ? `<p><strong>Dirección:</strong> ${order.address}</p>` : ''}
            </div>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
              <thead>
                <tr style="background-color: #f2f2f2;">
                  <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Producto</th>
                  <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Cantidad</th>
                  <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Precio Unitario</th>
                  <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Total</th>
                </tr>
              </thead>
              <tbody>
                ${(order.items || []).map(item => `
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd;">${item.title || 'Producto desconocido'}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${item.qty}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${Number(item.price_xaf || 0).toLocaleString()} XAF</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${Number(item.total_price || 0).toLocaleString()} XAF</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            <div style="text-align: right; margin-top: 20px;">
              <h3>Total: ${Number(order.total_xaf || 0).toLocaleString()} XAF</h3>
            </div>
            <p style="text-align: center; font-size: 12px; margin-top: 40px;">Gracias por su compra.</p>
          </div>
        `;
        invoiceContainer.style.display = 'block';
        window.print();
        invoiceContainer.style.display = 'none';
    }

    // ================== CARGAR PRODUCTOS ==================
    async function loadProducts() {
      if (!userId) return;
      const productsCollection = collection(db, `artifacts/${appId}/public/data/products`);
      const productsQuery = query(productsCollection, where("business_id", "==", businessId));

      const unsubscribe = onSnapshot(productsQuery, (querySnapshot) => {
        const tb = document.querySelector('#productsTable tbody');
        tb.innerHTML = '';
        querySnapshot.forEach((doc) => {
          const p = { id: doc.id, ...doc.data() };
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${p.id.slice(0, 8)}</td>
            <td>${p.title}</td>
            <td>${p.category || ''}</td>
            <td>${Number(p.price_xaf || 0).toLocaleString()} XAF</td>
            <td>${p.image_url ? `<img src="${p.image_url}" style="max-height:50px">` : ''}</td>
            <td>${new Date(p.created_at).toLocaleString()}</td>
          `;
          tb.appendChild(tr);
        });
      }, (error) => {
        console.error("Error al escuchar cambios en los productos:", error);
      });

      return unsubscribe;
    }

    // ================== CERRAR SESIÓN ==================
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('bizToken');
      localStorage.removeItem('bizId');
      token = null;
      businessId = null;
      window.location.reload();
    });

    // ================== INICIALIZACIÓN ==================
    async function init() {
      await initAuth();
      if (businessId) {
        document.getElementById('businessName').textContent = businessId.slice(0, 8);
        loadOrders();
        loadProducts();
      } else {
        showModal('Acceso denegado', 'No se encontró un ID de negocio. Por favor, asegúrate de haber iniciado sesión.');
        document.getElementById('logoutBtn').textContent = 'Ir a la página de inicio';
      }
    }
    init();
  </script>
</body>
</html>
