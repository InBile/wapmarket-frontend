<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Vendedor — WapMarket</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<header class="header">
  <div class="row wrapper">
    <div class="logo">WapMarket</div><button id="logoutBtn" class="btn logout-btn">Cerrar sesión</button>
  </div>
</header>

<main class="wrapper">
  <!-- Login -->
  <div class="card" style="padding:16px;max-width:800px" id="loginBox">
    <h3>Login de Negocio</h3>
    <form onsubmit="return false;">
      <label>Email <input id="lemail" type="email" required></label>
      <label>Contraseña <input id="lpass" type="password" required></label>
      <button class="btn" id="btnLogin">Entrar</button>
    </form>
  </div>

  <!-- Panel negocio -->
  <div id="panel" style="display:none">
    <!-- Publicar producto -->
    <div class="card" style="padding:16px;max-width:800px">
      <h3>Publicar producto</h3>
      <form id="prodForm" onsubmit="return false;">
        <label>Título <input id="title" required></label>
        <label>Descripción <textarea id="description"></textarea></label>
        <label>Categoría
          <select id="category">
            <option value="alimentacion">Alimentación</option>
            <option value="electronica">Electrónica</option>
            <option value="ropa">Ropa</option>
            <option value="hogar">Hogar</option>
          </select>
        </label>
        <label>Precio (XAF) <input id="price_xaf" type="number" required></label>
        <label>URL de la imagen <input id="image_url"></label>
        <button class="btn" id="btnPublish">Publicar</button>
      </form>
    </div>

    <!-- Gestión de pedidos -->
    <div class="card" style="padding:16px;max-width:100%">
      <h3>Pedidos Recientes</h3>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <input type="text" id="orderSearch" placeholder="Buscar por ID, nombre o teléfono..." style="width:50%; padding:8px; border:1px solid #ccc; border-radius:4px;">
        <div style="display:flex; gap:8px;">
            <button class="btn" id="sortDateBtn">Ordenar por Fecha</button>
            <select id="filterStatus" class="select" style="padding:8px; border:1px solid #ccc; border-radius:4px;">
                <option value="">Filtrar por Estado</option>
                <option value="pending">Pendiente</option>
                <option value="in-progress">En curso</option>
                <option value="completed">Completado</option>
            </select>
        </div>
      </div>
      <table id="ordersTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Cliente</th>
            <th>Productos</th>
            <th>Total</th>
            <th>Estado</th>
            <th>Fecha</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Gestión de productos -->
    <div class="card" style="padding:16px;max-width:100%">
      <h3>Mis Productos</h3>
      <table id="productsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Título</th>
            <th>Categoría</th>
            <th>Precio</th>
            <th>Imagen</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</main>

<script src="/api.js"></script>
<script>
  const API = {
    get: async (url, options) => {
      const response = await fetch(url, options);
      return response.json();
    },
    put: async (url, data, options) => {
      const response = await fetch(url, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', ...options.headers },
        body: JSON.stringify(data)
      });
      return response.json();
    }
  };

  const API_ENDPOINT = 'https://api.wapmarket.com'; // Sustituye con tu endpoint real

  // ================== AUTENTICACIÓN ==================
  let token = localStorage.getItem('bizToken');
  let business_id = localStorage.getItem('bizId');
  const loginBox = document.getElementById('loginBox');
  const panel = document.getElementById('panel');
  const btnLogin = document.getElementById('btnLogin');

  function authHeaders() {
    return {
      'Authorization': `Bearer ${token}`
    };
  }

  function checkAuth() {
    if (token) {
      loginBox.style.display = 'none';
      panel.style.display = 'block';
      loadOrders();
      loadProducts();
    } else {
      loginBox.style.display = 'block';
      panel.style.display = 'none';
    }
  }
  checkAuth();

  btnLogin.onclick = async () => {
    const email = document.getElementById('lemail').value;
    const pass = document.getElementById('lpass').value;
    const r = await API.put('/auth/business/login', { email, password: pass });
    if (r.error) return alert(r.error);
    token = r.token;
    business_id = r.business_id;
    localStorage.setItem('bizToken', token);
    localStorage.setItem('bizId', business_id);
    checkAuth();
  };

  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('bizToken');
    localStorage.removeItem('bizId');
    token = null;
    business_id = null;
    checkAuth();
  });

  // ================== GESTIÓN DE PEDIDOS ==================
  const ordersTableBody = document.querySelector('#ordersTable tbody');
  const orderSearchInput = document.getElementById('orderSearch');
  const sortDateBtn = document.getElementById('sortDateBtn');
  const filterStatusSelect = document.getElementById('filterStatus');
  let allOrders = [];

  function renderOrders(orders) {
      ordersTableBody.innerHTML = '';
      if (!orders || orders.length === 0) {
          ordersTableBody.innerHTML = '<tr><td colspan="7">No hay pedidos para mostrar.</td></tr>';
          return;
      }
      
      orders.forEach(order => {
          const productsHtml = order.products.map(p => `
              <li>${p.product.title} (${p.quantity} x ${p.product.price_xaf.toLocaleString()} XAF)</li>
          `).join('');

          const tr = document.createElement('tr');
          tr.innerHTML = `
              <td>${order.id.slice(-6)}</td>
              <td>
                  <strong>${order.customer_name || 'Anónimo'}</strong><br>
                  <a href="https://wa.me/${order.customer_phone}?text=Hola,%20tu%20pedido%20esta%20en%20proceso." target="_blank">${order.customer_phone}</a>
              </td>
              <td><ul>${productsHtml}</ul></td>
              <td>${Number(order.total_xaf).toLocaleString()} XAF</td>
              <td>${order.status}</td>
              <td>${new Date(order.created_at).toLocaleString()}</td>
              <td>
                  <div style="display:flex; gap:4px; flex-wrap:wrap;">
                      <button class="btn" data-id="${order.id}" data-s="in-progress">En curso</button>
                      <button class="btn" data-id="${order.id}" data-s="completed">Completado</button>
                      <button class="btn ghost" data-id="${order.id}" data-action="generate-invoice">Factura</button>
                  </div>
              </td>
          `;
          ordersTableBody.appendChild(tr);
      });
  }

  async function loadOrders() {
      if (!token) return;
      const data = await API.get('/business/orders', { headers: authHeaders() });
      allOrders = data.items || [];
      allOrders.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      renderOrders(allOrders);
  }

  function filterAndSortOrders() {
      const query = orderSearchInput.value.toLowerCase();
      const status = filterStatusSelect.value;
      
      let filteredOrders = allOrders.filter(order => {
          const matchesQuery = (
              order.id.toLowerCase().includes(query) ||
              (order.customer_name && order.customer_name.toLowerCase().includes(query)) ||
              (order.customer_phone && order.customer_phone.includes(query))
          );
          const matchesStatus = (status === '' || order.status === status);
          return matchesQuery && matchesStatus;
      });
      renderOrders(filteredOrders);
  }

  orderSearchInput.addEventListener('input', filterAndSortOrders);
  filterStatusSelect.addEventListener('change', filterAndSortOrders);
  sortDateBtn.addEventListener('click', () => {
      allOrders.reverse();
      renderOrders(allOrders);
  });

  ordersTableBody.addEventListener('click', async (e) => {
      const btn = e.target.closest('button.btn');
      if (!btn) return;

      const id = btn.getAttribute('data-id');
      const action = btn.getAttribute('data-action');

      if (action === 'generate-invoice') {
          const order = allOrders.find(o => o.id === id);
          if (order) generateInvoice(order);
      } else {
          const status = btn.getAttribute('data-s');
          const r = await API.put(`/business/orders/${id}`, { status: status }, { headers: authHeaders() });
          if (r.error) return alert(r.error);
          loadOrders();
      }
  });

  // ================== GENERACIÓN DE FACTURAS (PDF) ==================
  function generateInvoice(order) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      const margin = 10;
      const lineHeight = 7;
      
      doc.setFontSize(16);
      doc.text('Factura de Compra', margin, y);
      y += lineHeight * 2;

      doc.setFontSize(10);
      doc.text(`Código de Identificación: ${order.id.slice(-8)}`, margin, y);
      y += lineHeight;
      doc.text(`Fecha del Pedido: ${new Date(order.created_at).toLocaleDateString()}`, margin, y);
      y += lineHeight;
      doc.text(`Estado: ${order.status}`, margin, y);
      y += lineHeight * 2;

      doc.setFontSize(12);
      doc.text('Detalles del Cliente:', margin, y);
      y += lineHeight;
      doc.setFontSize(10);
      doc.text(`Nombre: ${order.customer_name || 'Anónimo'}`, margin, y);
      y += lineHeight;
      doc.text(`Teléfono: ${order.customer_phone}`, margin, y);
      y += lineHeight;
      if (order.address) {
          doc.text(`Dirección: ${order.address}`, margin, y);
          y += lineHeight;
      }
      y += lineHeight;

      doc.setFontSize(12);
      doc.text('Productos:', margin, y);
      y += lineHeight;
      doc.setFontSize(10);
      order.products.forEach(item => {
          doc.text(`- ${item.quantity} x ${item.product.title} - ${item.product.price_xaf.toLocaleString()} XAF c/u`, margin, y);
          y += lineHeight;
      });
      y += lineHeight;
      
      doc.setFontSize(12);
      doc.text(`Subtotal: ${Number(order.subtotal_xaf).toLocaleString()} XAF`, margin, y);
      y += lineHeight;
      if (order.delivery_fee_xaf) {
          doc.text(`Envío: ${Number(order.delivery_fee_xaf).toLocaleString()} XAF`, margin, y);
          y += lineHeight;
      }
      y += 2;
      doc.setDrawColor(0);
      doc.setLineWidth(0.5);
      doc.line(margin, y, 200, y);
      y += lineHeight;
      
      doc.setFontSize(14);
      doc.text(`TOTAL: ${Number(order.total_xaf).toLocaleString()} XAF`, margin, y);

      doc.save(`factura_${order.id.slice(-8)}.pdf`);
  }
  
  // ================== CARGAR PRODUCTOS ==================
  async function loadProducts() {
      if (!token) return;
      const data = await API.get('/business/products', { headers: authHeaders() });
      const tb = document.querySelector('#productsTable tbody');
      tb.innerHTML = '';
      (data.items || []).forEach(p => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
              <td>${p.id}</td>
              <td>${p.title}</td>
              <td>${p.category || ''}</td>
              <td>${Number(p.price_xaf || 0).toLocaleString()} XAF</td>
              <td>${p.image_url ? `<img src="${p.image_url}" style="max-height:50px">` : ''}</td>
              <td>${new Date(p.created_at).toLocaleString()}</td>
          `;
          tb.appendChild(tr);
      });
  }

  document.getElementById('btnPublish').onclick = async () => {
    // Lógica para publicar producto (mantener la existente)
  };
</script>
</body>
</html>
