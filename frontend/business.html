<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Vendedor — WapMarket</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
<header class="header">
  <div class="row wrapper">
    <div class="logo">WapMarket</div>
  </div>
</header>

<main class="wrapper">
  <div class="card" style="padding:16px;max-width:800px" id="loginBox">
    <h3>Login de Negocio</h3>
    <form onsubmit="return false;">
      <label>Email <input id="lemail" type="email" required></label>
      <label>Contraseña <input id="lpass" type="password" required></label>
      <button class="btn" id="btnLogin">Entrar</button>
    </form>
  </div>

  <div id="panel" style="display:none">
    <div class="card" style="padding:16px;max-width:800px">
      <h3>Publicar producto</h3>
      <form id="prodForm" onsubmit="return false;">
        <label>Título <input id="title" required></label>
        <label>Descripción <textarea id="description"></textarea></label>
        <label>Categoría
          <select id="category">
            <option>Servicios</option><option>Comida</option><option>Tiendas</option>
            <option>Salud</option><option>Transporte</option><option>Tecnología</option>
          </select>
        </label>
        <label>Precio (XAF) <input id="price" type="number" min="0"></label>
        <label>Imagen (archivo) <input id="image" type="file" accept="image/*"></label>
        <button class="btn" id="btnPublicar">Publicar</button>
      </form>
    </div>

    <div class="card" style="padding:16px;max-width:1100px">
      <h3>Pedidos</h3>
      <table class="table" id="ordersTable">
        <thead>
          <tr>
            <th>ID</th><th>Grupo</th><th>Producto</th><th>Precio</th><th>Cant.</th>
            <th>Cliente</th><th>Teléfono</th><th>Envío</th><th>Dirección</th>
            <th>Estado</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</main>

<!-- ✅ primero cargamos API -->
<script src="/api.js"></script>

<!-- ✅ después tu lógica -->
<script>
let token = null; 
let business_id = null;

function authHeaders(){ 
  return token ? { 'Authorization':'Bearer '+token } : {}; 
}

// Login negocio
document.getElementById('btnLogin').addEventListener('click', async ()=>{
  const res = await API.post('/business/login', { email: lemail.value, password: lpass.value });
  if (res.error){ alert(res.error); return; }
  token = res.token; business_id = res.business_id;
  localStorage.setItem('bizToken', token);
  localStorage.setItem('bizId', String(business_id));
  document.getElementById('loginBox').style.display='none';
  document.getElementById('panel').style.display='block';
  loadOrders();
});

// Si ya estaba logueado en localStorage
token = localStorage.getItem('bizToken'); 
business_id = Number(localStorage.getItem('bizId')||0);
if (token && business_id){ 
  document.getElementById('loginBox').style.display='none'; 
  document.getElementById('panel').style.display='block'; 
  loadOrders(); 
}

// Publicar producto
document.getElementById('btnPublicar').addEventListener('click', async ()=>{
  if (!token) return alert('Primero inicia sesión');
  let imageUrl = '';
  const file = document.getElementById('image').files[0];
  if (file){
    const fd = new FormData(); fd.append('image', file);
    const up = await API.upload('/business/upload-image', fd, { headers: authHeaders() });
    if (up.error) return alert(up.error);
    imageUrl = up.url;
  }
  const payload = {
    title: title.value, 
    description: description.value, 
    category: category.value,
    price_xaf: Number(price.value || 0), 
    image_url: imageUrl
  };
  const res = await API.post('/products', payload, { headers: authHeaders() });
  if (res.error){ alert(res.error); return; }
  alert('Producto publicado');
  document.getElementById('prodForm').reset();
});

// Cargar pedidos
async function loadOrders(){
  if (!token) return;
  const data = await API.get('/business/orders', { headers: authHeaders() });
  const tb = document.querySelector('#ordersTable tbody'); 
  tb.innerHTML='';
  (data.items||[]).forEach(o=>{
    const tr = document.createElement('tr');
    const deliveryTxt = o.delivery ? ('Sí (+'+Number(o.delivery_fee_xaf||0).toLocaleString()+' XAF)') : 'No';
    tr.innerHTML = `
      <td>${o.id}</td><td>${o.group_id||''}</td><td>${o.title}</td>
      <td>${Number(o.price_xaf||0).toLocaleString()} XAF</td><td>${o.qty}</td>
      <td>${o.customer_name||''}</td><td>${o.customer_phone||''}</td>
      <td>${deliveryTxt}</td><td>${o.address||''}</td>
      <td><span class="small">${o.status}</span></td>
      <td>
        <button class="btn" data-id="${o.id}" data-s="accepted">Aceptar</button>
        <button class="btn" data-id="${o.id}" data-s="rejected">Rechazar</button>
        <button class="btn" data-id="${o.id}" data-s="fulfilled">Entregado</button>
      </td>`;
    tb.appendChild(tr);
  });
  tb.onclick = async (e)=>{
    const btn = e.target.closest('button.btn'); if (!btn) return;
    const id = btn.getAttribute('data-id'); const s = btn.getAttribute('data-s');
    const r = await API.put('/business/orders/'+id, { status:s }, { headers: authHeaders() });
    if (r.error) return alert(r.error);
    loadOrders();
  };
}
</script>
</body>
</html>
