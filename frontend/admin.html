<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WapMarket · Admin</title>
<style>
:root{
  --amz-dark:#131921;
  --amz-yellow:#FF9900;
  --bg:#f6f7f9;
  --card:#fff;
  --muted:#6b7280;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#111}
.header{background:var(--amz-dark);color:#fff;padding:12px 18px;display:flex;align-items:center;gap:12px}
.brand{font-weight:800;font-size:18px}
.container{max-width:1100px;margin:20px auto;padding:0 16px}
.grid{display:grid;grid-template-columns:320px 1fr;gap:16px}
.card{background:var(--card);border:1px solid #e6e6e6;border-radius:8px;padding:14px;box-shadow:0 6px 18px rgba(17,24,39,0.04)}
.small{font-size:13px;color:var(--muted)}

.sidebar .section{margin-bottom:12px}
.btn{background:var(--amz-yellow);border:none;padding:8px 10px;border-radius:6px;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;border:1px solid #ddd;color:#111}

.topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
.form-row{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
.input, textarea, select{padding:8px;border-radius:6px;border:1px solid #ddd;width:100%}
.products-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
.product-card{border:1px solid #e6e6e6;border-radius:8px;padding:10px;background:#fff;display:flex;flex-direction:column;gap:8px}
.product-card img{width:100%;height:140px;object-fit:cover;border-radius:6px}

.footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}

@media (max-width:900px){ .grid{grid-template-columns:1fr} .sidebar{order:2} .main{order:1} }
</style>
</head>
<body>
  <header class="header">
    <div class="brand">Wap<span style="color:var(--amz-yellow)">Market</span> · Admin</div>
    <div class="small">Panel de administración — único vendedor</div>
  </header>

  <div class="container">
    <div class="grid">
      <aside class="sidebar">
        <div class="card">
          <h3>Acceso administrador</h3>
          <p class="small">Inicia sesión con la cuenta admin para administrar productos.</p>
          <div class="form-row">
            <input id="adminEmail" class="input" placeholder="Email admin" />
            <input id="adminPassword" class="input" placeholder="Contraseña admin" type="password" />
            <button id="adminLoginBtn" class="btn">Entrar como admin</button>
          </div>
          <hr/>
          <div class="small">Token admin:</div>
          <textarea id="debugTokens" style="width:100%;height:80px;border:1px solid #eee;padding:8px;border-radius:6px" readonly></textarea>
        </div>
      </aside>

      <main class="main">
        <div class="topbar">
          <div style="display:flex;flex-direction:column">
            <strong>Gestión de productos</strong>
            <span class="small">Crea, lista y desactiva productos.</span>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="logoutAdmin" class="btn ghost">Cerrar admin</button>
          </div>
        </div>

        <div class="card">
          <h3>Crear / Subir producto</h3>
          <div class="form-row">
            <input id="p_title" class="input" placeholder="Título" />
            <textarea id="p_description" class="input" placeholder="Descripción"></textarea>
            <div style="display:flex;gap:8px">
              <input id="p_category" class="input" placeholder="Categoría" />
              <input id="p_price" class="input" placeholder="Precio (XAF)" type="number" />
            </div>
            <label class="small">Imagen (opcional)</label>
            <input id="p_image" type="file" accept="image/*" />
            <div style="display:flex;gap:8px">
              <button id="uploadImageBtn" class="btn ghost">Subir imagen</button>
              <button id="createProductBtn" class="btn">Crear producto</button>
            </div>
            <div id="uploadedPreview" style="margin-top:8px"></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3>Productos del administrador</h3>
            <div class="small">Lista actualizada desde <code>/api/business/products</code></div>
          </div>
          <div id="productsContainer" style="margin-top:12px" class="products-list"></div>
        </div>

        <div class="footer">© 2025 WapMarket - Admin panel</div>
      </main>
    </div>
  </div>

<script>
const API_BASE = 'https://wapmarket-backend-production.up.railway.app/api';
let adminToken = localStorage.getItem('adminToken') || '';
let uploadedImageUrl = null;

// Elements
const adminEmail = document.getElementById('adminEmail');
const adminPassword = document.getElementById('adminPassword');
const adminLoginBtn = document.getElementById('adminLoginBtn');
const debugTokens = document.getElementById('debugTokens');

const p_title = document.getElementById('p_title');
const p_description = document.getElementById('p_description');
const p_category = document.getElementById('p_category');
const p_price = document.getElementById('p_price');
const p_image = document.getElementById('p_image');
const uploadImageBtn = document.getElementById('uploadImageBtn');
const createProductBtn = document.getElementById('createProductBtn');
const uploadedPreview = document.getElementById('uploadedPreview');
const productsContainer = document.getElementById('productsContainer');
const logoutAdmin = document.getElementById('logoutAdmin');

function setDebug(){ debugTokens.value = JSON.stringify({ adminToken: adminToken||null }, null, 2); }
setDebug();

async function fetchJSON(url, opts = {}){
  const headers = opts.headers || {};
  if (adminToken) headers['Authorization'] = 'Bearer ' + adminToken;
  try {
    const res = await fetch(url, { ...opts, headers });
    const ct = res.headers.get('content-type') || '';
    const body = ct.includes('application/json') ? await res.json().catch(()=>null) : await res.text();
    if (!res.ok) throw Object.assign(new Error(body && body.error ? body.error : res.statusText), { status: res.status, body });
    return body;
  } catch(e){ throw e; }
}

// Admin login
adminLoginBtn.addEventListener('click', async ()=>{
  const email = adminEmail.value.trim();
  const password = adminPassword.value;
  if(!email||!password) return alert('Completa credenciales admin');
  try{
    const data = await fetchJSON(API_BASE+'/admin/login',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email,password})});
    adminToken = data.token;
    localStorage.setItem('adminToken',adminToken);
    setDebug();
    alert('Admin login OK');
    loadProducts();
  }catch(e){ console.error(e); alert('Error admin login: '+(e.message||e)); }
});

// Upload image
uploadImageBtn.addEventListener('click', async ()=>{
  if(!adminToken) return alert('Inicia sesión primero');
  const file = p_image.files[0];
  if(!file) return alert('Selecciona una imagen');
  const fd = new FormData();
  fd.append('image', file);
  try{
    const res = await fetch(API_BASE+'/business/upload-image',{ method:'POST', headers:{ 'Authorization':'Bearer '+adminToken }, body:fd });
    const data = await res.json();
    if(!data||!data.url) throw new Error('No se recibió URL');
    uploadedImageUrl = data.url;
    uploadedPreview.innerHTML='<img src="'+uploadedImageUrl+'" style="max-width:160px;border-radius:6px;margin-top:6px"/>';
    alert('Imagen subida OK');
  }catch(e){ console.error(e); alert('Error subiendo imagen: '+(e.message||e)); }
});

// Create product
createProductBtn.addEventListener('click', async ()=>{
  if(!adminToken) return alert('Inicia sesión primero');
  const title=p_title.value.trim();
  const description=p_description.value.trim();
  const category=p_category.value.trim();
  const price=Number(p_price.value||0);
  if(!title) return alert('Título obligatorio');
  try{
    const payload={ title, description, category, price_xaf: price, image_url: uploadedImageUrl||null };
    const res = await fetchJSON(API_BASE+'/business/products',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
    alert('Producto creado: '+(res.product&&res.product.id?res.product.id:'OK'));
    p_title.value=''; p_description.value=''; p_category.value=''; p_price.value=''; p_image.value=''; uploadedImageUrl=null; uploadedPreview.innerHTML='';
    loadProducts();
  }catch(e){ console.error(e); alert('Error creando producto: '+(e.message||e)); }
});

// Load products
async function loadProducts(){
  if(!adminToken) return;
  try{
    const res = await fetchJSON(API_BASE+'/business/products',{ method:'GET' });
    renderProducts(res.items||[]);
  }catch(e){ console.error(e); alert('Error cargando productos: '+(e.message||e)); }
}

function renderProducts(items){
  productsContainer.innerHTML='';
  if(!items.length){ productsContainer.innerHTML='<div class="small">No hay productos.</div>'; return; }
  items.forEach(p=>{
    const el=document.createElement('div');
    el.className='product-card';
    el.innerHTML=`
      <img src="${p.image_url||'https://placehold.co/600x400?text=No+image'}" alt="${escapeHtml(p.title)}" />
      <div style="display:flex;flex-direction:column;gap:6px">
        <strong>${escapeHtml(p.title)}</strong>
        <div class="small">${escapeHtml(p.category||'')}</div>
        <div style="font-weight:800">${Number(p.price_xaf||0).toLocaleString()} XAF</div>
        <div style="display:flex;gap:8px;margin-top:6px">
          <button class="btn ghost" data-act="disable" data-id="${p.id}">${p.active?'Desactivar':'Activar'}</button>
          <button class="btn ghost" data-act="delete" data-id="${p.id}">Eliminar</button>
        </div>
      </div>
    `;
    productsContainer.appendChild(el);
  });
}

// Product actions
productsContainer.addEventListener('click', async e=>{
  const btn=e.target.closest('button[data-act]');
  if(!btn) return;
  const act=btn.dataset.act;
  const id=btn.dataset.id;
  if(act==='disable'){
    const makeActive = btn.textContent.trim()==='Activar';
    try{
      await fetchJSON(API_BASE+'/business/products/'+encodeURIComponent(id),{ method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({active:makeActive})});
      alert('Estado actualizado'); loadProducts();
    }catch(e){ console.error(e); alert('Error actualizando: '+(e.message||e)); }
  }else if(act==='delete'){
    if(!confirm('Eliminar producto permanentemente?')) return;
    try{
      await fetchJSON(API_BASE+'/business/products/'+encodeURIComponent(id),{ method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({active:false})});
      alert('Producto desactivado'); loadProducts();
    }catch(e){ console.error(e); alert('Error eliminando: '+(e.message||e)); }
  }
});

// Logout
logoutAdmin.addEventListener('click', ()=>{ adminToken=''; localStorage.removeItem('adminToken'); setDebug(); alert('Sesión admin cerrada'); productsContainer.innerHTML=''; });

function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

// Auto-load if token exists
if(adminToken) loadProducts();
</script>
</body>
</html>
